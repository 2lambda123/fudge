
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fudge.legacy.converting.endfFileToGND &mdash; Fudge and GND 1.2 beta documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.2 beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/gnd-20121206-favicon.ico"/>
    <link rel="top" title="Fudge and GND 1.2 beta documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Fudge and GND 1.2 beta documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for fudge.legacy.converting.endfFileToGND</h1><div class="highlight"><pre>
<span class="c"># &lt;&lt;BEGIN-copyright&gt;&gt;</span>
<span class="c"># &lt;&lt;END-copyright&gt;&gt;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">fudge</span> <span class="kn">import</span> <span class="n">gnd</span>
<span class="kn">from</span> <span class="nn">fudge.core</span> <span class="kn">import</span> <span class="n">fudgemisc</span>
<span class="kn">from</span> <span class="nn">fudge.core.utilities</span> <span class="kn">import</span> <span class="n">brb</span><span class="p">,</span> <span class="n">fudgeZA</span>
<span class="kn">from</span> <span class="nn">pqu</span> <span class="kn">import</span> <span class="n">physicalQuantityWithUncertainty</span>
<span class="kn">from</span> <span class="nn">fudge.core.math</span> <span class="kn">import</span> <span class="n">fudgemath</span><span class="p">,</span> <span class="n">matrix</span> <span class="k">as</span> <span class="n">gndMatrix</span>
<span class="kn">from</span> <span class="nn">fudge.core.math.xData</span> <span class="kn">import</span> <span class="n">axes</span><span class="p">,</span> <span class="n">XYs</span><span class="p">,</span> <span class="n">LegendreSeries</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">W_XYs</span>

<span class="kn">from</span> <span class="nn">fudge.processing</span> <span class="kn">import</span> <span class="n">processingInfo</span>
<span class="kn">from</span> <span class="nn">fudge.gnd.productData</span> <span class="kn">import</span> <span class="n">distributions</span>

<span class="kn">import</span> <span class="nn">endfFormats</span>
<span class="kn">import</span> <span class="nn">endf_endl</span>
<span class="kn">import</span> <span class="nn">endfFileToGNDMisc</span>
<span class="kn">import</span> <span class="nn">endlToGND</span>

<span class="n">ENDFInterpolationToGND</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatToken</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">}</span>
<span class="n">frames</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">axes</span><span class="o">.</span><span class="n">centerOfMassToken</span> <span class="p">}</span>
<span class="n">ENDF_Accuracy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDF_Accuracy</span>
<span class="n">FUDGE_EPS</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">FUDGE_EPS</span>
<span class="n">productNameToZA</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;n&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;H1&#39;</span> <span class="p">:</span> <span class="mi">1001</span><span class="p">,</span> <span class="s">&#39;H2&#39;</span> <span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s">&#39;H3&#39;</span> <span class="p">:</span> <span class="mi">1003</span><span class="p">,</span> <span class="s">&#39;He3&#39;</span> <span class="p">:</span> <span class="mi">2003</span><span class="p">,</span> <span class="s">&#39;He4&#39;</span> <span class="p">:</span> <span class="mi">2004</span><span class="p">,</span> <span class="s">&#39;gamma&#39;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="n">lightIsotopeNames</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;H1&#39;</span><span class="p">,</span> <span class="s">&#39;H2&#39;</span><span class="p">,</span> <span class="s">&#39;H3&#39;</span><span class="p">,</span> <span class="s">&#39;He3&#39;</span><span class="p">,</span> <span class="s">&#39;He4&#39;</span> <span class="p">]</span>

<div class="viewcode-block" id="logFiles"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.logFiles">[docs]</a><span class="k">class</span> <span class="nc">logFiles</span> <span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">toStdOut</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">toStdErr</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">defaultIsStderrWriting</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span> <span class="p">:</span>

        <span class="k">def</span> <span class="nf">addIfDifferent</span><span class="p">(</span> <span class="n">newOutput</span> <span class="p">)</span> <span class="p">:</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">newOutput</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">output</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="bp">False</span> <span class="p">)</span>
            <span class="k">return</span><span class="p">(</span> <span class="bp">True</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaultIsStderrWriting</span> <span class="o">=</span> <span class="n">defaultIsStderrWriting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">toStdOut</span> <span class="p">)</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">toStdErr</span> <span class="ow">and</span> <span class="n">addIfDifferent</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">logFile</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">type</span><span class="p">(</span> <span class="n">logFile</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span> <span class="s">&#39;&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">logFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">logFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="nb">type</span><span class="p">(</span> <span class="n">logFile</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;logFile type = </span><span class="si">%s</span><span class="s"> is no supported&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">type</span><span class="p">(</span> <span class="n">logFlie</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">addIfDifferent</span><span class="p">(</span> <span class="n">logFile</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">logFile</span> <span class="p">)</span>

<div class="viewcode-block" id="logFiles.write"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.logFiles.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">stderrWriting</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultIsStderrWriting</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">output</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">stderrWriting</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">msg</span> <span class="p">)</span>

<span class="c"># iterator that keeps track of line number:</span></div></div>
<div class="viewcode-block" id="myIter"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.myIter">[docs]</a><span class="k">class</span> <span class="nc">myIter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<div class="viewcode-block" id="myIter.next"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.myIter.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">next</span>

<span class="c"># two useful shortcuts for reading ENDF data:</span></div></div>
<span class="n">funkyF</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span>
<div class="viewcode-block" id="funkyFI"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.funkyFI">[docs]</a><span class="k">def</span> <span class="nf">funkyFI</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="p">)</span> <span class="p">:</span>   <span class="c"># read ENDF line with 2 floats and 4 ints</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logFile</span> <span class="p">)</span> <span class="p">)</span>

<span class="c"># create some custom Exceptions:</span></div>
<div class="viewcode-block" id="BadResonances"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.BadResonances">[docs]</a><span class="k">class</span> <span class="nc">BadResonances</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="BadCovariance"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.BadCovariance">[docs]</a><span class="k">class</span> <span class="nc">BadCovariance</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">):</span> <span class="k">pass</span>
    </div>
<div class="viewcode-block" id="calculateZA"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.calculateZA">[docs]</a><span class="k">def</span> <span class="nf">calculateZA</span><span class="p">(</span> <span class="n">ZACompound</span><span class="p">,</span> <span class="n">ZAOther</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This function handles the removal (or addition) of ZAOther to ZACompound include natural compound (but not a natural other).&quot;&quot;&quot;</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZACompound</span> <span class="o">%</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZAOther</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ZAOther</span> <span class="o">//</span> <span class="mi">1000</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">minus</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">ZACompound</span> <span class="o">-</span> <span class="n">ZAOther</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">ZACompound</span> <span class="o">+</span> <span class="n">ZAOther</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getTypeNameGamma"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getTypeNameGamma">[docs]</a><span class="k">def</span> <span class="nf">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">level</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">fudgemath</span><span class="o">.</span><span class="n">isNumber</span><span class="p">(</span> <span class="n">level</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">100</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">levelIndex</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Negative excitation level = </span><span class="si">%s</span><span class="s"> for ZA = </span><span class="si">%s</span><span class="s"> and levelIndex = </span><span class="si">%s</span><span class="s"> is not allowed&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">level</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">message</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">message</span> <span class="p">)</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span><span class="p">(</span> <span class="nb">type</span><span class="p">(</span> <span class="n">level</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span> <span class="s">&#39;&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;level (type =&quot;</span><span class="si">%s</span><span class="s">&quot;) must be a number or a string&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">brb</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span> <span class="n">level</span> <span class="p">),</span> <span class="n">ZA</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZA</span> <span class="o">=</span> <span class="mi">7</span>                             <span class="c"># Special case for gammas which are yo = 7 for ENDL.</span>
    <span class="n">p</span> <span class="o">=</span>  <span class="n">endlToGND</span><span class="o">.</span><span class="n">getTypeName</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">levelIndex</span><span class="p">,</span> <span class="n">levelUnit</span> <span class="o">=</span> <span class="s">&#39;eV&#39;</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">p</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getTypeNameENDF"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getTypeNameENDF">[docs]</a><span class="k">def</span> <span class="nf">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">levelIndex</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">undefinedLevelInfo</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;ZA&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;ZA&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZA</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">ZA</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">1002</span><span class="p">,</span> <span class="mi">1003</span><span class="p">,</span> <span class="mi">2003</span><span class="p">,</span> <span class="mi">2004</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;undefinedLevelInfo[&#39;count&#39;] &gt; 1 for ZA = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ZA</span> <span class="p">)</span>
                <span class="n">levelIndex</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;levelIndex&#39;</span><span class="p">],</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">levelIndex</span> <span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="returnConstantQ"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.returnConstantQ">[docs]</a><span class="k">def</span> <span class="nf">returnConstantQ</span><span class="p">(</span> <span class="n">Q_eV</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">Q_eV</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="countZAMasses"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.countZAMasses">[docs]</a><span class="k">def</span> <span class="nf">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ZAData</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">AWR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ZAData</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZAData</span><span class="p">[</span><span class="n">AWR</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ZAData</span><span class="p">[</span><span class="n">AWR</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="smearXYs"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.smearXYs">[docs]</a><span class="k">def</span> <span class="nf">smearXYs</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;data must be an python array of [ [ x0, y0 ], [ x1, y1 ], ...  [ xn, yn ] ].&quot;&quot;&quot;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">eps</span> <span class="o">==</span> <span class="mf">0.</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Need non-zeor eps&#39;</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">xPrior</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">xPrior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;x = </span><span class="si">%s</span><span class="s"> &lt; xPrior = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">==</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">x</span> <span class="o">*=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
                    <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">xPrior</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;eps = </span><span class="si">%s</span><span class="s"> &lt; 0 is not implemented&#39;</span> <span class="o">%</span> <span class="n">eps</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getCrossSectionLinearOrPointwise"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getCrossSectionLinearOrPointwise">[docs]</a><span class="k">def</span> <span class="nf">getCrossSectionLinearOrPointwise</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">cls</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">pointwise</span>
    <span class="n">independent</span><span class="p">,</span> <span class="n">dependent</span><span class="p">,</span> <span class="n">qualifier</span> <span class="o">=</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span><span class="p">,</span> <span class="bp">None</span> <span class="p">)</span> <span class="o">==</span> <span class="p">(</span> <span class="n">independent</span><span class="p">,</span> <span class="n">dependent</span><span class="p">,</span> <span class="n">qualifier</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">linear</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">cls</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span> <span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getMultiplicityPointwiseOrPieceWise"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getMultiplicityPointwiseOrPieceWise">[docs]</a><span class="k">def</span> <span class="nf">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">yUnit</span> <span class="o">=</span> <span class="s">&#39;multiplicity&#39;</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">multiplicityInterpolation</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyInterpolation</span> <span class="o">=</span> <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">multiplicityName</span> <span class="o">=</span> <span class="n">yUnit</span><span class="p">,</span> \
        <span class="n">multiplicityInterpolation</span> <span class="o">=</span> <span class="n">multiplicityInterpolation</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span>  <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>                        <span class="c"># Make sure its less than first point</span>
        <span class="n">doWarning</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">xPrior</span> <span class="o">==</span> <span class="n">x</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">doWarning</span> <span class="p">)</span> <span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: same multiplicity energies, second one being incremented&#39;</span> <span class="p">)</span>
                <span class="n">doWarning</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">]</span>
            <span class="n">xPrior</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ENDF_Accuracy</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">doKludge</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span> <span class="p">)</span> <span class="p">:</span> <span class="n">doKludge</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">doKludge</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;piecewise multiplicity is not supported&#39;</span> <span class="p">)</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copyDataToXYs</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copyDataToXYs</span><span class="p">(</span> <span class="p">)</span> <span class="o">+</span> <span class="n">xys</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">xys</span><span class="p">,</span> <span class="n">ENDF_Accuracy</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">multiplicity</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getTotalOrPromptFission"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getTotalOrPromptFission">[docs]</a><span class="k">def</span> <span class="nf">getTotalOrPromptFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT456Data</span><span class="p">,</span> <span class="n">totalOrPrompt</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LNU</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MT456Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">LNU</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LNU</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;     </span><span class="si">%s</span><span class="s"> fission neutron data: LNU = </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">totalOrPrompt</span><span class="p">,</span> <span class="n">LNU</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LNU</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">polynomial</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MT456Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">fissionMultiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">polynomial</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">polynomial</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">multiplicityRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MT456Data</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">multiplicityRegions</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported&quot;</span> <span class="p">)</span>
        <span class="n">fissionMultiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">multiplicityRegions</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">fissionMultiplicity</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getDelayedFission"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getDelayedFission">[docs]</a><span class="k">def</span> <span class="nf">getDelayedFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT455Data</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;     Delayed fission neutron data (MT=455)&#39;</span> <span class="p">)</span>
    <span class="n">MT455DataMF1</span> <span class="o">=</span> <span class="n">MT455Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LDG</span><span class="p">,</span> <span class="n">LNU</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MT455DataMF1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LDG</span><span class="p">,</span> <span class="n">LNU</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LDG</span> <span class="p">),</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LNU</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; LDG=</span><span class="si">%s</span><span class="s"> LNU=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LDG</span><span class="p">,</span> <span class="n">LNU</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LDG</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Only energy-independent delayed fission neutrons are supported&quot;</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LNU</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Only tables of delayed fission neutrons are supported&quot;</span> <span class="p">)</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">decayRateData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MT455DataMF1</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">NNF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">decayRateData</span><span class="p">[</span><span class="s">&#39;NPL&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">decayRates</span> <span class="o">=</span> <span class="n">decayRateData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span>

    <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">multiplicityRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MT455DataMF1</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">multiplicityRegions</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported&quot;</span> <span class="p">)</span>
    <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">multiplicityInterpolation</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">multiplicityRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>

    <span class="n">totolDelayedMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">5</span> <span class="ow">in</span> <span class="n">MT455Data</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">delayedNeutronEnergies</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">readMF5</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">455</span><span class="p">,</span> <span class="n">MT455Data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">delayNeutrons</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
        <span class="n">weightsSum</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span> <span class="p">)</span>        <span class="c"># Renormalize weights to sum to 1.</span>
        <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span> <span class="p">:</span> <span class="n">weightsSum</span> <span class="o">=</span> <span class="n">weightsSum</span> <span class="o">+</span> <span class="n">weight</span>
        <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span> <span class="p">:</span> 
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span> <span class="p">:</span> <span class="n">XYs</span><span class="o">.</span><span class="n">pointwiseXY</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span> <span class="n">weight</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">weightsSum</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">delayedNeutronEnergies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="o">*</span> <span class="p">[</span> <span class="bp">None</span> <span class="p">]</span>
        <span class="n">totolDelayedMultiplicity_</span> <span class="o">=</span> <span class="n">totolDelayedMultiplicity</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span>
        <span class="n">nuBar</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="p">[</span> <span class="n">totolDelayedMultiplicity_</span> <span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: More than one delayed fission neutron decay time but no MF = 5 data&#39;</span> <span class="p">)</span>
    <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyDecayChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="mf">0.</span> <span class="p">)</span> <span class="p">)</span>     <span class="c"># Dummy channel, so Q&#39;s value does not matter.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">decayRate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">energyComponent</span> <span class="o">=</span> <span class="n">delayedNeutronEnergies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">energyComponent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">weights_energyInterpolation</span><span class="p">,</span> <span class="n">weights_multiplicityInterpolation</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weights_energyInterpolation</span> <span class="o">!=</span> <span class="n">energyInterpolation</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> \
                <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Total and weight energy interpolations differ: </span><span class="si">%s</span><span class="s"> vs </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">weights_energyInterpolation</span><span class="p">,</span> <span class="n">energyInterpolation</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weights_multiplicityInterpolation</span> <span class="o">!=</span> <span class="n">multiplicityInterpolation</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> \
                <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Total and weight multiplicity interpolations differ: </span><span class="si">%s</span><span class="s"> vs </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">weights_multiplicityInterpolation</span><span class="p">,</span> <span class="n">multiplicityInterpolation</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weights_energyInterpolation</span> <span class="o">!=</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">)</span> <span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;For energy only linear interpolations supported: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">weights_energyInterpolation</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weights_multiplicityInterpolation</span> <span class="o">!=</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">)</span> <span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;For multiplicity only linear interpolations supported: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">weights_multiplicityInterpolation</span> <span class="p">)</span>
            <span class="n">totolDelayedM</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">totolDelayedMultiplicity</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">totolDelayedMultiplicity</span><span class="o">.</span><span class="n">domainMax</span><span class="p">(</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMax</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">totolDelayedM</span> <span class="o">=</span> <span class="n">totolDelayedMultiplicity</span><span class="o">.</span><span class="n">xSlice</span><span class="p">(</span> <span class="n">xMax</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMax</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMax</span><span class="p">(</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">totolDelayedM</span><span class="o">.</span><span class="n">domainMax</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">xSlice</span><span class="p">(</span> <span class="n">xMax</span> <span class="o">=</span> <span class="n">totolDelayedM</span><span class="o">.</span><span class="n">domainMax</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMin</span><span class="p">(</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="n">totolDelayedM</span><span class="o">.</span><span class="n">domainMin</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> 
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">xSlice</span><span class="p">(</span> <span class="n">xMin</span> <span class="o">=</span> <span class="n">totolDelayedM</span><span class="o">.</span><span class="n">domainMin</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">totolDelayedM</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">nuBar</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="p">[</span> <span class="n">multiplicity</span> <span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">nuBar</span><span class="p">:</span>
            <span class="n">m</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">frexp</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nuBar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">round</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="mf">3.321928095</span><span class="p">))</span> <span class="p">)</span>
            <span class="c">#nuBar.setValue( xy[0], round(xy[-1], 10+int(abs(math.log10(xy[-1])))) )</span>
        <span class="n">particle</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">nuBar</span> <span class="p">)</span>
        <span class="n">particle</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;emissionMode&#39;</span><span class="p">,</span> <span class="s">&#39;delayed&#39;</span> <span class="p">)</span>
        <span class="n">particle</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;decayRate&#39;</span><span class="p">,</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">decayRate</span><span class="p">,</span> <span class="s">&quot;1/s&quot;</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">energyComponent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>     <span class="c"># MF = 5 data is always in lab frame.</span>
            <span class="n">angularComponent</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="n">angularComponent</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">uncorrelated</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">angularComponent</span><span class="p">,</span> <span class="n">energyComponent</span> <span class="p">)</span>
            <span class="n">angularComponent</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span> <span class="n">component</span> <span class="p">);</span> <span class="n">energyComponent</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
            <span class="n">component</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">particle</span><span class="o">.</span><span class="n">distributions</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">particle</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="getFissionEnergies"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.getFissionEnergies">[docs]</a><span class="k">def</span> <span class="nf">getFissionEnergies</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF458Data</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For NPLY = 0 this data consists of pairs ( energy, standard deviation ).  The energies are:</span>
<span class="sd">    EFR: kinetic energy of all fission fragments</span>
<span class="sd">    ENP: energy of prompt fission neutrons</span>
<span class="sd">    END: energy of delayed fission neutrons</span>
<span class="sd">    EGP: energy of prompt fission gammas</span>
<span class="sd">    EGD: energy of delayed fission gammas</span>
<span class="sd">    EB: energy of delayed fission betas</span>
<span class="sd">    ENU: energy of fission neutrinos</span>
<span class="sd">    ER: EFR + ENP + END + EGP + EGD + EB, fission Q minus the neutrinos</span>
<span class="sd">    ET: ER + ENU, total fission Q</span>
<span class="sd">    For NPLY &gt; 0 the fission energies are polynomials of degree NPLY in the incident energy,</span>
<span class="sd">    and the structure of the above table is repeated, once for each polynomial coefficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MF1Data</span> <span class="o">=</span> <span class="n">MF458Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dataLine</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF1Data</span><span class="p">[</span><span class="n">dataLine</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>

    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NPLY</span><span class="p">,</span> <span class="n">lengthData</span><span class="p">,</span> <span class="n">numEnergies</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF1Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">NPLY</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NPLY</span> <span class="p">)</span>               <span class="c"># order of the polynomial representation of energy produced</span>
    <span class="n">lengthData</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">lengthData</span> <span class="p">)</span>   <span class="c"># how much data</span>
    <span class="n">numEnergies</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">numEnergies</span> <span class="p">)</span> <span class="c"># number of fission energies (9)</span>

    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">nFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">numEnergies</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF1Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">fissionEnergyReleased</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">labels</span>
    <span class="n">fissionEnergyData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="p">:</span> <span class="n">fissionEnergyData</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">numEnergies</span><span class="p">,</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">labels</span> <span class="p">)</span> <span class="p">:</span> <span class="n">fissionEnergyData</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">fissionEnergies</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">fissionEnergyReleased</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">fissionEnergies</span><span class="o">.</span><span class="n">addFormAsNativeData</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">fissionEnergyReleased</span><span class="o">.</span><span class="n">polynomial</span><span class="p">(</span> <span class="n">NPLY</span><span class="p">,</span> <span class="n">fissionEnergyData</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">hasUncertainties</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">fissionEnergies</span>
</div>
<div class="viewcode-block" id="angularLegendrePiecewiseToPointwiseIfPossible"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.angularLegendrePiecewiseToPointwiseIfPossible">[docs]</a><span class="k">def</span> <span class="nf">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">piecewiseForm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">energyFunctionInterpolation</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">piecewiseForm</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span>
    <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">frame</span><span class="p">,</span> <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">energyFunctionInterpolation</span> <span class="p">)</span>
    <span class="n">pointwiseForm</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">pointwiseForm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">energy</span><span class="o">.</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">value</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">pointwiseForm</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="angularLegendreToPointwiseOrPiecewiseLegendre"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.angularLegendreToPointwiseOrPiecewiseLegendre">[docs]</a><span class="k">def</span> <span class="nf">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePiecewise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>
    <span class="n">formLegendre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePiecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">lastRegion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">lists</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">end</span><span class="p">,</span> <span class="n">interpolationFlag</span> <span class="ow">in</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Unsupported interpolation = </span><span class="si">%s</span><span class="s"> for MF=</span><span class="si">%s</span><span class="s">, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">interpolationFlag</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationCl</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">)</span>
        <span class="n">regionsAxes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationAxes</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationCl</span> <span class="p">),</span> <span class="bp">None</span> <span class="p">)</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">W_XYs_LegendreSeries</span><span class="p">(</span> <span class="n">regionsAxes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">formLegendre</span> <span class="p">)</span>
        <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">priorEnergy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">lastRegion</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">lists</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="s">&#39;C2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">region</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">indexEnergyIn</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">lists</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="p">[</span> <span class="mf">1.0</span> <span class="p">]</span> <span class="o">+</span> <span class="n">lists</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;data&#39;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">priorEnergy</span> <span class="p">)</span> <span class="p">:</span>                           <span class="c"># This fixes a problem with some data having two same energy values.</span>
                <span class="n">energy</span> <span class="o">+=</span> <span class="n">FUDGE_EPS</span> <span class="o">*</span> <span class="n">energy</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: same energies, second one being incremented for MT = </span><span class="si">%d</span><span class="s">, MF = </span><span class="si">%d</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">priorEnergy</span> <span class="o">=</span> <span class="n">energy</span>
            <span class="n">region</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span>
            <span class="n">indexEnergyIn</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">formLegendre</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">lastRegion</span> <span class="o">=</span> <span class="p">[</span> <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="p">]</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">formLegendre</span> <span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="convertNuclearPlusInterferenceDataToPiecewise"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.convertNuclearPlusInterferenceDataToPiecewise">[docs]</a><span class="k">def</span> <span class="nf">convertNuclearPlusInterferenceDataToPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">identicalParticles</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return distributions.LegendreNuclearPlusCoulombInterference instance. This in turn contains</span>
<span class="sd">    Legendre sections for both the nuclear and interference contributions.&quot;&quot;&quot;</span>

    <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePiecewise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>
    <span class="n">nuclear</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePiecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
    <span class="n">interferenceReal</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePiecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
    <span class="n">interferenceImaginary</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePiecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">lastRegion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">lists</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">end</span><span class="p">,</span> <span class="n">interpolationFlag</span> <span class="ow">in</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationCl</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Unsupported interpolation = </span><span class="si">%s</span><span class="s"> for MF=</span><span class="si">%s</span><span class="s">, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">interpolationFlag</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationCl</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">)</span>
        <span class="n">regionsAxes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationAxes</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationCl</span> <span class="p">),</span> <span class="bp">None</span> <span class="p">)</span>
        <span class="n">region_Nuc</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">W_XYs_LegendreSeries</span><span class="p">(</span> <span class="n">regionsAxes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">nuclear</span> <span class="p">)</span>
        <span class="n">region_IntReal</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">W_XYs_LegendreSeries</span><span class="p">(</span> <span class="n">regionsAxes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">interferenceReal</span> <span class="p">)</span>
        <span class="n">region_IntImaginary</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">W_XYs_LegendreSeries</span><span class="p">(</span> <span class="n">regionsAxes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">interferenceImaginary</span> <span class="p">)</span>
        <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">priorEnergy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">lastRegion</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">lists</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="s">&#39;C2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastRegion</span> <span class="p">)</span> <span class="p">:</span> <span class="c"># ensure no gaps between regions</span>
                <span class="n">region_Nuc</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">nuclear_term</span><span class="p">,</span>      <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span> <span class="p">)</span>
                <span class="n">region_IntReal</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">interference_termReal</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span> <span class="p">)</span>
                <span class="n">region_IntImaginary</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">interference_termImaginary</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span> <span class="p">)</span>
                <span class="n">indexEnergyIn</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="p">)</span> <span class="p">:</span>
            <span class="nb">list</span> <span class="o">=</span> <span class="n">lists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">priorEnergy</span> <span class="p">)</span> <span class="p">:</span>                           <span class="c"># This fixes a problem with some data having two same energy values.</span>
                <span class="n">energy</span> <span class="o">+=</span> <span class="n">FUDGE_EPS</span> <span class="o">*</span> <span class="n">energy</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: same energies, second one being incremented for MT = </span><span class="si">%d</span><span class="s">, MF = </span><span class="si">%d</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">priorEnergy</span> <span class="o">=</span> <span class="n">energy</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">identicalParticles</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">splitPoint</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s">&#39;N2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">splitPoint</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s">&#39;N2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">nuclear_term</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][:</span><span class="n">splitPoint</span><span class="p">]</span>
            <span class="n">interference_term</span><span class="p">,</span> <span class="n">interference_termReal</span><span class="p">,</span> <span class="n">interference_termImaginary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="n">splitPoint</span><span class="p">:],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">interference_term</span> <span class="p">),</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">interference_termReal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">interference_term</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">interference_termImaginary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">interference_term</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">region_Nuc</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">nuclear_term</span><span class="p">,</span>      <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span>
            <span class="n">region_IntReal</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">interference_termReal</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span>
            <span class="n">region_IntImaginary</span><span class="p">[</span><span class="n">indexEnergyIn</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">interference_termImaginary</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexEnergyIn</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span>
            <span class="n">indexEnergyIn</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">lastRegion</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">nuclear</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_Nuc</span>
        <span class="n">interferenceReal</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_IntReal</span>
        <span class="n">interferenceImaginary</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_IntImaginary</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">nuclear</span> <span class="o">=</span> <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">nuclear</span> <span class="p">)</span>
    <span class="n">interferenceReal</span> <span class="o">=</span> <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">interferenceReal</span> <span class="p">)</span>
    <span class="n">interferenceImaginary</span> <span class="o">=</span> <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">interferenceImaginary</span> <span class="p">)</span>
    <span class="c"># nuclear and interference are both angularLegendrePiecewise objects, but need to specify which is which:</span>
    <span class="n">nuclear</span><span class="o">.</span><span class="n">moniker</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">LegendrePiecewise_NuclearFormToken</span>
    <span class="n">interferenceReal</span><span class="o">.</span><span class="n">moniker</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">LegendrePiecewise_CoulombInterferenceRealFormToken</span>
    <span class="n">interferenceImaginary</span><span class="o">.</span><span class="n">moniker</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">LegendrePiecewise_CoulombInterferenceImaginaryFormToken</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">nuclearPlusCoulombInterference</span><span class="p">(</span> <span class="n">nuclear</span><span class="p">,</span> <span class="n">interferenceReal</span><span class="p">,</span> <span class="n">interferenceImaginary</span> <span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="convertAngularToPointwiseOrPiecewise"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.convertAngularToPointwiseOrPiecewise">[docs]</a><span class="k">def</span> <span class="nf">convertAngularToPointwiseOrPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularLOrT</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">allowDuplicateEnergiesInMF4Table</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">interpolationE_in</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND3plusd</span><span class="p">(</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">interpolationFlagMin</span> <span class="o">=</span> <span class="n">LANG</span> <span class="o">-</span> <span class="mi">10</span>
        <span class="n">interpolationFlagMax</span> <span class="o">=</span> <span class="n">interpolationFlagMin</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">interpolationFlagMin</span> <span class="o">=</span> <span class="n">interpolationFlagMax</span> <span class="o">=</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MT = </span><span class="si">%d</span><span class="s">, MF = 4, LTT = 2&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">interpolationFlagMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">interpolationFlagMin</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">interpolationFlagMax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">interpolationFlagMax</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">interpolationFlagMin</span> <span class="o">!=</span> <span class="n">interpolationFlagMax</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: Some interpolation flags changing </span><span class="si">%s</span><span class="s"> for MF = 4, LTT = 2&#39;</span> <span class="o">%</span> <span class="n">interpolationFlagMin</span> <span class="p">)</span>
    <span class="n">interpolationx</span><span class="p">,</span> <span class="n">interpolationy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2d</span><span class="p">(</span> <span class="n">interpolationFlagMin</span> <span class="p">)</span>
    <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_in&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">byRegionToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">byRegionToken</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;mu&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">byRegionToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">byRegionToken</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;P(energy_in|mu)&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span> <span class="p">)</span>
    <span class="n">piecewiseForm</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">IKnowWhatIAmDoing</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">lastRegion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">lOrTs</span> <span class="o">=</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">]</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">lOrTs</span> <span class="o">=</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span>
    <span class="n">doInterpolationChangeWarning</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">endInterpolationFlag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">end</span><span class="p">,</span> <span class="n">interpolationFlag</span> <span class="o">=</span> <span class="n">endInterpolationFlag</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">mu_pdf_Interpolation</span> <span class="o">=</span> <span class="n">LANG</span> <span class="o">-</span> <span class="mi">10</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">mu_pdf_Interpolation</span> <span class="o">=</span> <span class="n">lOrTs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">lOrTs</span> <span class="p">:</span> <span class="n">mu_pdf_Interpolation</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">mu_pdf_Interpolation</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">lOrTs</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">mu_pdf_Interpolation</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: Some interpolation changed for angular data from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">mu_pdf_Interpolation</span><span class="p">,</span> 
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">mu_pdf_InterpolationString</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">interpolationString</span><span class="p">(</span> <span class="n">mu_pdf_Interpolation</span> <span class="p">)</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">piecewiseRegion</span><span class="p">(</span> <span class="n">index</span><span class="p">,</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">interpolationString</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">),</span> <span class="n">mu_pdf_InterpolationString</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">lastRegion</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">lOrTs</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="s">&#39;C2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">priorEnergy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">lOrT</span> <span class="o">=</span> <span class="n">lOrTs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;L1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">LANG</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;LANG = </span><span class="si">%d</span><span class="s"> changed from </span><span class="si">%d</span><span class="s">: LAW = 2, MT = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="nb">list</span> <span class="o">=</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">list</span> <span class="p">),</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">mu_pdf_Interpolation</span> <span class="o">!=</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">doInterpolationChangeWarning</span> <span class="p">)</span> <span class="p">:</span> 
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: Some interpolation flags changing to </span><span class="si">%s</span><span class="s"> for MF = 4, LTT = 2 or 3&#39;</span> <span class="o">%</span> <span class="n">mu_pdf_Interpolation</span> <span class="p">)</span>
                    <span class="n">doInterpolationChangeWarning</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">priorEnergy</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowDuplicateEnergiesInMF4Table</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: At Ein = </span><span class="si">%s</span><span class="s"> in MF = 4, LTT = 2, MT = </span><span class="si">%s</span><span class="s">, found duplicate energy&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">piecewiseForm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">piecewiseRegion</span><span class="p">(</span> <span class="n">index</span><span class="p">,</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">interpolationString</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">),</span> <span class="n">mu_pdf_InterpolationString</span> <span class="p">)</span>
            <span class="n">region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="n">data</span> <span class="p">)</span>       <span class="c"># Currently, only supports one interpolation mu, P region.</span>
            <span class="n">priorEnergy</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">lastRegion</span> <span class="o">=</span> <span class="p">[</span> <span class="n">lOrT</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="n">data</span> <span class="p">]</span>
        <span class="n">piecewiseForm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">energyFunctionInterpolation</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> \
            <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">angularLOrT</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">piecewiseRegion</span> <span class="o">=</span> <span class="n">piecewiseForm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">muInterpolation</span><span class="p">,</span> <span class="n">probabilityInterpolation</span> <span class="o">=</span> <span class="n">piecewiseRegion</span><span class="o">.</span><span class="n">yzInterpolationString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;,&#39;</span> <span class="p">)</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyInterpolation</span> <span class="o">=</span> <span class="n">energyInterpolation</span><span class="p">,</span> 
            <span class="n">energyFunctionInterpolation</span> <span class="o">=</span> <span class="n">energyFunctionInterpolation</span><span class="p">,</span> <span class="n">muProbabilityFrame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span> <span class="n">energyInterpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span><span class="p">,</span>
            <span class="n">muInterpolation</span> <span class="o">=</span> <span class="n">muInterpolation</span><span class="p">,</span> <span class="n">probabilityInterpolation</span> <span class="o">=</span> <span class="n">probabilityInterpolation</span> <span class="p">)</span>
        <span class="n">pointwiseForm</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">pointwise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
        <span class="n">axesMuP</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">referenceAxes</span><span class="p">(</span> <span class="n">pointwiseForm</span> <span class="p">)</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="o">=</span> <span class="n">piecewiseRegion</span><span class="o">.</span><span class="n">yzInterpolationString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;,&#39;</span> <span class="p">)</span>
        <span class="n">axesMuP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setInterpolation</span><span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="p">)</span> <span class="p">)</span> <span class="c"># This should be axes logic?????</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">piecewiseRegion</span><span class="o">.</span><span class="n">energies</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">pointwiseForm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axesMuP</span><span class="p">,</span> <span class="n">energy</span><span class="o">.</span><span class="n">xys</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">pointwiseForm</span> <span class="p">)</span>
        <span class="n">piecewiseForm</span> <span class="o">=</span> <span class="n">pointwiseForm</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">print</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">LTT</span><span class="p">,</span> <span class="n">piecewiseForm</span><span class="o">.</span><span class="n">data</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;piecewise len( </span><span class="si">%s</span><span class="s"> ) &gt; 1 not supported: MT=</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">),</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="toPointwiseEnergy"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.toPointwiseEnergy">[docs]</a><span class="k">def</span> <span class="nf">toPointwiseEnergy</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">wInterpolation</span><span class="p">,</span> <span class="n">dependentInterpolation</span><span class="p">,</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">xInterpolation</span><span class="p">,</span> <span class="n">yInterpolation</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_in&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">wInterpolation</span><span class="p">,</span> <span class="n">dependentInterpolation</span><span class="p">,</span>
        <span class="n">interpolationQualifier</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_out&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">xInterpolation</span><span class="p">,</span> <span class="n">yInterpolation</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;P(energy_in|energy_out)&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;1/eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span> <span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">pointwise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
    <span class="n">axes_xy</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">axes_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">axes_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">energyPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">EoutP</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">EoutP</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">EoutP</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">EoutP</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">energyPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="n">energy</span> <span class="o">*=</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axes_xy</span><span class="p">,</span> <span class="n">EoutP</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">energyPrior</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="convertToPointwiseOrPiecewiseEnergy"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.convertToPointwiseOrPiecewiseEnergy">[docs]</a><span class="k">def</span> <span class="nf">convertToPointwiseOrPiecewiseEnergy</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Currently only one interpolation flag is supported for MT=</span><span class="si">%d</span><span class="s">, MF=5, LF=1 data&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">doPointwise</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">doPointwise</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="n">interpolation2</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation2</span>
        <span class="n">doPointwise</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="n">interpolation2</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">doPointwise</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">data_</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">energy</span><span class="p">,</span> <span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">xys</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">independent</span><span class="p">,</span> <span class="n">dependent</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">toPointwiseEnergy</span><span class="p">(</span> <span class="n">data_</span><span class="p">,</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">independent</span><span class="p">,</span> <span class="n">dependent</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">NBT</span><span class="p">,</span> <span class="n">interpolation</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">energyFunctionInterpolation</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">interpolation</span> <span class="p">)</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">semiPiecewise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">semiPiecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
        <span class="n">regionsAxes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">referenceAxes</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">regions_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">regions__</span> <span class="o">=</span> <span class="n">regions</span><span class="o">.</span><span class="n">regionsXYs</span><span class="p">(</span> <span class="n">regionsAxes</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">form</span><span class="p">,</span> <span class="n">isPrimaryXData</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">regions_</span> <span class="p">)</span> <span class="p">:</span> <span class="n">regions__</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
            <span class="n">form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">regions__</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF2"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF2">[docs]</a><span class="k">def</span> <span class="nf">readMF2</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF2</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse MF2 into resonances class (and sub-classes)</span>
<span class="sd">    cmattoon, 11/09/2010</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PhysQuant</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span>
    <span class="kn">from</span> <span class="nn">fudge.core.math.table</span> <span class="kn">import</span> <span class="n">table</span> <span class="k">as</span> <span class="n">gndTable</span><span class="p">,</span> <span class="n">columnHeader</span> <span class="k">as</span> <span class="n">gndColumnId</span>

    <span class="c"># store MT #s for all reactions that need to include resonance data:</span>
    <span class="n">resonanceMTs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">readResonanceSection</span><span class="p">(</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span><span class="p">,</span> <span class="n">NRO</span><span class="p">,</span> <span class="n">NAPS</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; helper function, read in resonance info for one energy range &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">NRO</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>  <span class="c"># energy-dependent scattering radius</span>
            <span class="k">if</span> <span class="n">NAPS</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;NAPS=2 option not yet supported!&quot;</span><span class="p">)</span>
            <span class="n">line1</span> <span class="o">=</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NR</span><span class="p">,</span> <span class="n">NP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">line1</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">nLines</span> <span class="o">=</span> <span class="n">NR</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="n">NR</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span>  <span class="o">+</span>  <span class="n">NP</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="n">NP</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLines</span><span class="p">)]</span>
            <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">()</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;scattering radius must be pointwise linear&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;energy_in&quot;</span><span class="p">;</span> <span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">=</span><span class="s">&quot;eV&quot;</span><span class="p">;</span> <span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">=</span><span class="s">&quot;lab&quot;</span>
            <span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;radius&quot;</span><span class="p">;</span> <span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">=</span><span class="s">&quot;10*fm&quot;</span><span class="p">;</span> <span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">=</span><span class="s">&quot;lab&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">convertAxisToUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;fm&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;scatteringRadius&quot;</span>
            <span class="n">data</span><span class="o">.</span><span class="n">isPrimaryXData</span> <span class="o">=</span> <span class="bp">True</span><span class="p">;</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>  <span class="c"># scattering radius only. Note AP given in 10*fm</span>
            <span class="n">SPI</span><span class="p">,</span> <span class="n">AP</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NLS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># no parity information</span>
            <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">),</span> <span class="n">EL</span><span class="p">,</span> <span class="n">EH</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scatRadius</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>   <span class="c">#SLBW or MLBW form</span>
            <span class="n">SPI</span><span class="p">,</span> <span class="n">AP</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NLS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">NRO</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">resList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">negativeJs</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                <span class="n">AWRI</span><span class="p">,</span> <span class="n">QX</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">LRX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NRS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s">&quot;incorrect values in resonance section line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                    <span class="n">e</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gtot</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">negativeJs</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gtot</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">negativeJs</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;Encountered negative J-values for SLBW/MLBW&quot;</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">gndTable</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;energy&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;J&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;totalWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;neutronWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;captureWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">6</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;fissionWidthA&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span> <span class="p">],</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span><span class="p">(</span><span class="n">res</span><span class="p">):</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>   <span class="c"># sort by energy only</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;totalWidth&quot;</span><span class="p">,</span><span class="s">&quot;fissionWidthA&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span> <span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="p">):</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">SLBW</span><span class="p">(</span> <span class="n">table</span><span class="p">,</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span>
                        <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">MLBW</span><span class="p">(</span> <span class="n">table</span><span class="p">,</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span>
                        <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>     <span class="c"># Reich-Moore form</span>
            <span class="n">SPI</span><span class="p">,</span> <span class="n">AP</span><span class="p">,</span> <span class="n">LAD</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NLS</span><span class="p">,</span> <span class="n">NLSC</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># store spin in GND particle list</span>
            <span class="k">if</span> <span class="n">NRO</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">resList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">LdependentAP</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">negativeJs</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># in Reich-Moore, j&lt;0 indicates channel spin</span>
            <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                <span class="n">AWRI</span><span class="p">,</span> <span class="n">APL</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NRS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;incorrect values in resonance section line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">APL</span><span class="p">:</span> <span class="c"># and APL != AP:</span>
                    <span class="n">LdependentAP</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">APL</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                    <span class="n">e</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf1</span><span class="p">,</span><span class="n">gf2</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf1</span><span class="p">,</span><span class="n">gf2</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">negativeJs</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;energy&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;J&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;neutronWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;captureWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;fissionWidthA&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">6</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;fissionWidthB&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span> <span class="p">]</span>

            <span class="k">if</span> <span class="n">negativeJs</span><span class="p">:</span>
                <span class="c"># for incident neutrons, channel spin s = vector sum(target spin, 1/2)</span>
                <span class="c"># in Reich-Moore, the channel spin is encoded in the sign of J</span>
                <span class="n">e</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf1</span><span class="p">,</span><span class="n">gf2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">resList</span><span class="p">)</span>
                <span class="n">channelSpins</span> <span class="o">=</span> <span class="p">[</span><span class="n">SPI</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">jval</span><span class="p">)</span> <span class="k">for</span> <span class="n">jval</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">jlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">jval</span><span class="p">)</span> <span class="k">for</span> <span class="n">jval</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">resList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">e</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">jlist</span><span class="p">,</span><span class="n">channelSpins</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf1</span><span class="p">,</span><span class="n">gf2</span> <span class="p">)]</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;channelSpin&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)):</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">gndTable</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span><span class="p">(</span><span class="n">res</span><span class="p">):</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="c"># sort by resonance energy</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;fissionWidthA&#39;</span><span class="p">,</span><span class="s">&#39;fissionWidthB&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span> <span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="p">):</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">RM</span><span class="p">(</span> <span class="n">table</span><span class="p">,</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span>
                    <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">),</span> <span class="n">computeAngularDistribution</span><span class="o">=</span><span class="n">LAD</span><span class="p">,</span>
                    <span class="n">LvaluesNeededForConvergence</span><span class="o">=</span><span class="n">NLSC</span><span class="p">,</span> <span class="n">LdependentScatteringRadii</span><span class="o">=</span><span class="n">LdependentAP</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>     <span class="c"># Adler-Adler, not currently supported</span>
            <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s">&quot;Adler-Adler resonance formalism not yet supported!&quot;</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>     <span class="c"># R-Matrix Limited</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">IFG</span><span class="p">,</span><span class="n">KRM</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">KRL</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">KRM</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">approximation</span> <span class="o">=</span> <span class="s">&#39;Reich_Moore&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s">&quot;R-Matrix with KRM=</span><span class="si">%i</span><span class="s"> not yet implemented!</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">KRM</span> <span class="p">)</span>
            
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NPP</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp1</span><span class="p">,</span><span class="n">tmp2</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp1</span><span class="o">!=</span><span class="mi">12</span><span class="o">*</span><span class="n">NPP</span> <span class="ow">or</span> <span class="n">tmp2</span><span class="o">!=</span><span class="mi">2</span><span class="o">*</span><span class="n">NPP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s">&quot;incorrect LRF7 header!&quot;</span> <span class="p">)</span>
            
            <span class="c"># some helper functions:</span>
            <span class="k">def</span> <span class="nf">getOutgoingParticles</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">targZA</span><span class="p">,</span> <span class="n">projZA</span> <span class="p">):</span>
                <span class="n">reacStr</span> <span class="o">=</span> <span class="n">endf_endl</span><span class="o">.</span><span class="n">ENDF_MTZAEquation</span><span class="p">(</span><span class="n">projZA</span><span class="p">,</span><span class="n">targZA</span><span class="p">,</span> <span class="n">MT</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">outgoing</span> <span class="o">=</span> <span class="n">reacStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">pA</span><span class="p">,</span> <span class="n">pB</span> <span class="o">=</span> <span class="n">outgoing</span><span class="o">.</span><span class="n">split</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">pA</span><span class="p">,</span> <span class="n">pB</span>
            
            <span class="k">def</span> <span class="nf">translateENDFJpi</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">P</span><span class="p">):</span>
                <span class="c"># endf uses weird convention for Jpi. Translate to simpler version:</span>
                <span class="n">spin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">I</span><span class="p">:</span> <span class="n">parity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">/</span><span class="n">I</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">parity</span> <span class="o">=</span> <span class="n">P</span> <span class="ow">or</span> <span class="mi">1</span>   <span class="c"># if (I,P)=(0,0) treat as &#39;0+&#39;</span>
                <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span> <span class="n">spin</span> <span class="p">),</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">parity</span><span class="p">(</span> <span class="n">parity</span> <span class="p">)</span>
                
            <span class="c"># ENDF R-Matrix starts by listing outgoing particle pairs</span>
            <span class="c"># these are referred back to later on. Store in &#39;IPPlist&#39;:</span>
            <span class="n">openChannels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPP</span><span class="p">):</span>
                <span class="n">MA</span><span class="p">,</span> <span class="n">MB</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">ZB</span><span class="p">,</span> <span class="n">IA</span><span class="p">,</span> <span class="n">IB</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">Q</span><span class="p">,</span> <span class="n">PNT</span><span class="p">,</span> <span class="n">SHF</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">PB</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">MT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
                <span class="n">resonanceMTs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
                
                <span class="n">Qvalue</span> <span class="o">=</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">)</span>
                <span class="n">calculatePenetrability</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">PNT</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">PNT</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">102</span><span class="p">)):</span>
                    <span class="n">calculatePenetrability</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="c"># identify the channel using ZA and MT:</span>
                <span class="n">projectileZA</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">projectile</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pA</span><span class="p">,</span><span class="n">pB</span> <span class="o">=</span> <span class="n">getOutgoingParticles</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ZAM</span><span class="p">),</span><span class="n">projectileZA</span><span class="p">)</span>
                <span class="c"># get target spin. In future, this should already be present in particle list</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="n">pA</span><span class="p">]</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">IA</span><span class="p">,</span><span class="n">PA</span><span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="n">pB</span><span class="p">]</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">IB</span><span class="p">,</span><span class="n">PB</span><span class="p">)</span>
                
                <span class="n">channel</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pA</span><span class="p">,</span><span class="n">pB</span><span class="p">)</span>
                <span class="n">openChannels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">openChannel</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span><span class="n">ENDF_MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span><span class="n">Qvalue</span><span class="o">=</span><span class="n">Qvalue</span><span class="p">,</span>
                    <span class="n">calculatePenetrability</span><span class="o">=</span><span class="n">calculatePenetrability</span><span class="p">,</span><span class="n">calculateShift</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">SHF</span><span class="p">))</span> <span class="p">)</span>
                
            
            <span class="c"># next we have NJS spin groups, each containing channels and resonances</span>
            <span class="n">spinGroups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spinGroupIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                <span class="c"># read scattering radius, binding, etc:</span>
                <span class="n">AJ</span><span class="p">,</span> <span class="n">PJ</span><span class="p">,</span> <span class="n">KBK</span><span class="p">,</span> <span class="n">KPS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NCH</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NCH</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;incorrect LRF7 header, line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">channelData</span> <span class="o">=</span> <span class="p">[</span> <span class="n">gndColumnId</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;energy&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span><span class="p">)</span> <span class="p">]</span>
                <span class="n">channelNames</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">IPP</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">SCH</span><span class="p">,</span> <span class="n">BND</span><span class="p">,</span> <span class="n">APE</span><span class="p">,</span> <span class="n">APT</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">thisChannel</span> <span class="o">=</span> <span class="n">openChannels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">IPP</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">channelName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> width&quot;</span> <span class="o">%</span> <span class="n">thisChannel</span><span class="o">.</span><span class="n">channel</span>
                    <span class="n">jdx</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">channelName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channelNames</span><span class="p">:</span>
                            <span class="n">channelNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">channelName</span> <span class="p">);</span> <span class="k">break</span>
                        <span class="n">channelName</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> width_</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thisChannel</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">jdx</span><span class="p">)</span>
                        <span class="n">jdx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">APT</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">effectiveRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">APE</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">channelData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gndColumnId</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">channelName</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span><span class="p">,</span>
                        <span class="n">L</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">L</span><span class="p">),</span> <span class="n">channelSpin</span><span class="o">=</span><span class="n">SCH</span><span class="p">,</span><span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatteringRadius</span><span class="p">,</span>
                                <span class="n">effectiveRadius</span><span class="o">=</span><span class="p">(</span><span class="n">effectiveRadius</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">APT</span><span class="o">==</span><span class="n">APE</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span>
                                <span class="n">boundaryCondition</span><span class="o">=</span><span class="n">BND</span><span class="p">)</span> <span class="p">)</span>
                
                <span class="c"># resonances for this J:</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NRS</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NX</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NX</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;incorrect LRF7 header, line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">NRS</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>   <span class="c"># skip empty line</span>
                <span class="n">resonances</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="n">NCH</span><span class="o">/</span><span class="mf">6.0</span> <span class="p">))</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                        <span class="n">vals</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">resonances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">vals</span><span class="p">[:</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                
                <span class="n">table</span> <span class="o">=</span> <span class="n">gndTable</span><span class="p">(</span> <span class="n">columns</span><span class="o">=</span><span class="n">channelData</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">resonances</span> <span class="p">)</span>
                <span class="c"># done with this spin group:</span>
                <span class="n">J</span><span class="p">,</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">AJ</span><span class="p">,</span><span class="n">PJ</span><span class="p">)</span>
                <span class="n">spinGroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">spinGroup</span><span class="p">(</span><span class="n">spinGroupIndex</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">KBK</span><span class="p">,</span> <span class="n">KPS</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span> <span class="p">)</span>
            
            <span class="c"># fix up the data a bit: in ENDF, scatteringRadius etc are defined multiple times</span>
            <span class="c"># but are usually all identical. In GND, define only once for the whole resonance region</span>
            <span class="c"># only include in specific channels if we need to override the default value</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">chanList</span> <span class="o">=</span> <span class="p">[</span><span class="n">chan</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">spinGroups</span> <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">sg</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;scatteringRadius&#39;</span><span class="p">,</span><span class="s">&#39;boundaryCondition&#39;</span><span class="p">):</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chanList</span><span class="p">]</span>
                <span class="n">valSet</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valSet</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valSet</span><span class="p">]</span>
                <span class="n">mostCommon</span> <span class="o">=</span> <span class="n">valSet</span><span class="p">[</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">mostCommon</span>
                <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chanList</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="n">mostCommon</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span> <span class="n">option</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># also fix-up the penetrability and phase shift: define only once at the top if possible:</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;calculatePenetrability&#39;</span><span class="p">,</span><span class="s">&#39;calculateShift&#39;</span><span class="p">):</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">openChannels</span><span class="p">]</span>
                <span class="n">valSet</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span>
                <span class="n">mostCommon</span> <span class="o">=</span> <span class="n">valSet</span><span class="p">[</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">mostCommon</span>
                <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">openChannels</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span><span class="n">option</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="n">mostCommon</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            
            <span class="c"># end of spin groups. write RMatrix class:</span>
            <span class="c">#spinGroups.sort()   # sort by Jpi. Disable for easier comparison with ENDF-6</span>
            <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">RMatrix</span><span class="p">(</span> <span class="n">openChannels</span><span class="p">,</span> <span class="n">spinGroups</span><span class="p">,</span> <span class="n">approximation</span><span class="o">=</span><span class="n">approximation</span><span class="p">,</span>
                    <span class="n">relativisticKinematics</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">KRL</span><span class="p">),</span> <span class="n">reducedWidthAmplitudes</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">IFG</span><span class="p">),</span>
                    <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c"># unresolved</span>
            <span class="n">L_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">LRF_LFW</span> <span class="o">=</span> <span class="s">&quot;LRF,LFW=</span><span class="si">%i</span><span class="s">,</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LRF</span><span class="p">,</span> <span class="n">LFW</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">LFW</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>   <span class="c"># &#39;Case A&#39;, see ENDF 2010 manual page 70</span>
                <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">LSSF</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NLS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                    <span class="n">AWRI</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NJS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NJS</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;bad unresolved flag, line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">J_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">jidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">AJ</span><span class="p">,</span><span class="n">AMUN</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">AMUN</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="n">AMUN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AMUN</span><span class="p">)</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">GF</span> <span class="o">=</span> <span class="p">[</span><span class="n">PhysQuant</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">J_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">URR_Jsection</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">AJ</span><span class="p">),</span> <span class="n">eDepWidths</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">constantWidths</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;levelSpacing&#39;</span><span class="p">:</span><span class="n">D</span><span class="p">,</span><span class="s">&#39;neutronWidth&#39;</span><span class="p">:</span><span class="n">GNO</span><span class="p">,</span><span class="s">&#39;captureWidth&#39;</span><span class="p">:</span><span class="n">GG</span><span class="p">,</span>
                                <span class="s">&#39;fissionWidthA&#39;</span><span class="p">:</span><span class="n">GF</span><span class="p">},</span>
                            <span class="n">neutronDOF</span><span class="o">=</span><span class="n">AMUN</span><span class="p">,</span> <span class="n">gammaDOF</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">competitiveDOF</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fissionDOF</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">URR_Lsection</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">J_list</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">unresolvedTabulatedWidths</span><span class="p">(</span> <span class="n">L_list</span><span class="p">,</span>
                    <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span> <span class="n">forSelfShieldingOnly</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">LSSF</span><span class="p">),</span> 
                    <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">LRF_LFW</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">LFW</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c"># &#39;Case B&#39;</span>
                <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">LSSF</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NE</span><span class="p">,</span><span class="n">NLS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NE</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                <span class="n">energyList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                    <span class="c">#energyList += [PhysQuant(a,&#39;eV&#39;) for a in funkyF(mf2.next(), logFile = info.logs )]</span>
                    <span class="n">energyList</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                    <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">J_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">jidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">eDepWidths</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">MUF</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="n">NE</span><span class="o">+</span><span class="mi">6</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;Bad unresolved flag, line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">AJ</span><span class="p">,</span><span class="n">AMUN</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">AMUN</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="n">AMUN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AMUN</span><span class="p">)</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">GX</span> <span class="o">=</span> <span class="p">[</span><span class="n">PhysQuant</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">widthList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                            <span class="c">#widthList += [PhysQuant(a,&#39;eV&#39;) for a in funkyF( mf2.next(), logFile = info.logs )]</span>
                            <span class="n">widthList</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="n">gndTable</span><span class="p">(</span> <span class="p">[</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;energy&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;fissionWidthA&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NE</span><span class="p">):</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="p">[</span><span class="n">energyList</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">widthList</span><span class="p">[</span><span class="n">e</span><span class="p">]]</span> <span class="p">)</span>
                            <span class="c">#eDepWidths.append({&#39;energy&#39;:energyList[e], &#39;fissionWidthA&#39;:widthList[e]})</span>
                        <span class="n">J_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">URR_Jsection</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">AJ</span><span class="p">),</span> <span class="n">table</span><span class="p">,</span>
                            <span class="n">constantWidths</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;levelSpacing&#39;</span> <span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="s">&#39;neutronWidth&#39;</span> <span class="p">:</span> <span class="n">GNO</span><span class="p">,</span> <span class="s">&#39;captureWidth&#39;</span> <span class="p">:</span> <span class="n">GG</span><span class="p">,</span> <span class="s">&#39;competitiveWidth&#39;</span> <span class="p">:</span> <span class="n">GX</span> <span class="p">},</span>
                            <span class="n">interpolation</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">),</span> <span class="n">neutronDOF</span> <span class="o">=</span> <span class="n">AMUN</span><span class="p">,</span> <span class="n">fissionDOF</span> <span class="o">=</span> <span class="n">MUF</span><span class="p">,</span>
                            <span class="n">competitiveDOF</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">URR_Lsection</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">J_list</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">unresolvedTabulatedWidths</span><span class="p">(</span>
                        <span class="n">L_list</span><span class="p">,</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span> <span class="n">forSelfShieldingOnly</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">LSSF</span><span class="p">),</span>
                        <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">LRF_LFW</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>            <span class="c"># &#39;Case C&#39;, most common in ENDF-VII.1</span>
                <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">LSSF</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NLS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">writeErr</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">Lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                    <span class="n">J_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">jidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">resList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">AJ</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">INT</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NE</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NE</span><span class="o">+</span><span class="mi">6</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s">&quot;bad unresolved flag, line </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">dof</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUX&#39;</span><span class="p">],</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUN&#39;</span><span class="p">],</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUG&#39;</span><span class="p">],</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;AMUX&#39;</span><span class="p">,</span><span class="s">&#39;AMUN&#39;</span><span class="p">,</span><span class="s">&#39;AMUG&#39;</span><span class="p">,</span><span class="s">&#39;AMUF&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NE</span><span class="p">):</span>
                            <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="n">gndTable</span><span class="p">(</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;energy&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;levelSpacing&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;competitiveWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;neutronWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;captureWidth&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">gndColumnId</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;fissionWidthA&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;eV&quot;</span> <span class="p">),</span> <span class="p">],</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">resList</span> <span class="p">)</span>
                        <span class="n">J_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">URR_Jsection</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">AJ</span><span class="p">),</span> <span class="n">table</span><span class="p">,</span>
                                <span class="n">constantWidths</span><span class="o">=</span><span class="p">{},</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">interpolationString</span><span class="p">(</span><span class="n">INT</span><span class="p">),</span> 
                                <span class="n">competitiveDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUX&#39;</span><span class="p">],</span> <span class="n">neutronDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUN&#39;</span><span class="p">],</span> <span class="n">gammaDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUG&#39;</span><span class="p">],</span> 
                                <span class="n">fissionDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s">&#39;AMUF&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="c"># sometimes energy-dependent flag is used, but widths are constant in energy:</span>
                        <span class="k">if</span> <span class="n">J_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eliminateRedundantInfo</span><span class="p">()</span> <span class="ow">and</span> <span class="n">writeErr</span><span class="p">:</span>
                            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: Redundant information was removed in URR. ENDF format will differ&#39;</span> <span class="p">)</span>
                            <span class="n">writeErr</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">URR_Lsection</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">J_list</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">unresolvedTabulatedWidths</span><span class="p">(</span>
                        <span class="n">L_list</span><span class="p">,</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span> <span class="n">forSelfShieldingOnly</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">LSSF</span><span class="p">),</span>
                        <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">LRF_LFW</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;Unexpected LRU=</span><span class="si">%i</span><span class="s">, LRF=</span><span class="si">%i</span><span class="s"> encountered</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span> <span class="p">)</span> <span class="p">)</span>
    
    <span class="c"># end of helper functions.</span>
    <span class="c"># now read MF2 data:</span>
    <span class="n">mf2</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">MF2</span><span class="p">)</span> <span class="c"># mf2.next() to get each line</span>
    
    <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">resolvedList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unresolvedList</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c"># store particle spins, will be stored in the particle list:</span>
    <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c"># read MF2 header:</span>
    <span class="n">ZAM</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NIS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAM</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">NIS</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;careful, more than one isotope in MF2!&quot;</span> <span class="p">)</span>
    <span class="n">ZAI</span><span class="p">,</span> <span class="n">ABN</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">LFW</span><span class="p">,</span> <span class="n">NER</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">erange</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NER</span><span class="p">):</span>
        <span class="c"># each energy range</span>
        <span class="n">EL</span><span class="p">,</span> <span class="n">EH</span><span class="p">,</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span><span class="p">,</span> <span class="n">NRO</span><span class="p">,</span> <span class="n">NAPS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">EL</span><span class="p">,</span> <span class="n">EH</span> <span class="o">=</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">EL</span><span class="p">,</span><span class="s">&quot;eV&quot;</span><span class="p">),</span> <span class="n">PhysQuant</span><span class="p">(</span><span class="n">EH</span><span class="p">,</span><span class="s">&quot;eV&quot;</span><span class="p">)</span>
        <span class="n">nativeData</span> <span class="o">=</span> <span class="n">readResonanceSection</span><span class="p">(</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span><span class="p">,</span> <span class="n">NRO</span><span class="p">,</span> <span class="n">NAPS</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">nativeData</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resonanceMTs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">102</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">ZAI</span><span class="o">//</span><span class="mi">1000</span><span class="o">&gt;=</span><span class="mi">90</span><span class="p">:</span> <span class="n">resonanceMTs</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">resolvedList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">nativeData</span><span class="p">,</span><span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">unresolvedList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">nativeData</span><span class="p">,</span><span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolvedList</span><span class="p">:</span> <span class="n">resolved</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolvedList</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="p">(</span> <span class="o">*</span><span class="n">resolvedList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;       WARNING: multiple resolved energy intervals are deprecated!&quot;</span> <span class="p">)</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="p">(</span> <span class="n">multipleRegions</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nativeData</span><span class="p">,</span> <span class="n">EL</span><span class="p">,</span> <span class="n">EH</span> <span class="ow">in</span> <span class="n">resolvedList</span><span class="p">:</span>
            <span class="n">resolved</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">energyInterval</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">nativeData</span><span class="p">,</span><span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unresolvedList</span><span class="p">:</span> <span class="n">unresolved</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unresolvedList</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">unresolved</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">unresolved</span><span class="p">(</span> <span class="o">*</span><span class="n">unresolvedList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">,</span> <span class="s">&quot;multiple unresolved regions not supported&quot;</span>
    
<span class="c">#    if mf2.index != mf2.length: raise BadResonances(&quot;Not all resonance data converted!&quot;)</span>
    <span class="k">if</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">mf2</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;WARNING: Not all resonance data converted!&quot;</span><span class="p">)</span>
    <span class="n">resonances</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">resonances</span><span class="p">(</span> <span class="n">scatteringRadius</span><span class="p">,</span> <span class="n">resolved</span><span class="p">,</span> <span class="n">unresolved</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">resonances</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resonanceMTs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="readMF3"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF3">[docs]</a><span class="k">def</span> <span class="nf">readMF3</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF3Data</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">crossSectionRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MF3Data</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">allowInterpolation6</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">LR</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">breakupProducts</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span><span class="p">(</span>   <span class="n">LR</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="k">pass</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; : MF=3, LR=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LR</span> <span class="p">)</span>
        <span class="n">breakupProducts</span><span class="p">,</span> <span class="n">productCounts</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">endf_endl</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span><span class="p">[</span><span class="n">LR</span><span class="p">]</span><span class="o">.</span><span class="n">productCounts</span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productCounts</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>
        <span class="n">breakupProducts</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">del</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="o">==</span> <span class="mi">31</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: Invalid LR = </span><span class="si">%s</span><span class="s"> for MT = </span><span class="si">%s</span><span class="s"> is being ignored&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="k">if</span><span class="p">(</span> <span class="n">LR</span> <span class="o">==</span> <span class="mi">40</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: LR = </span><span class="si">%s</span><span class="s"> for MT = </span><span class="si">%s</span><span class="s"> is being ignored&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Breakup LR = </span><span class="si">%s</span><span class="s"> is not supported: MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Invalide breakup flag LR </span><span class="si">%s</span><span class="s">: MT = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">crossSection</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">crossSectionRegions</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>         <span class="c"># Store as pointwise:</span>
        <span class="n">ptwsXSec</span> <span class="o">=</span> <span class="n">getCrossSectionLinearOrPointwise</span><span class="p">(</span> <span class="n">crossSectionRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">crossSectionRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">crossSection</span><span class="o">.</span><span class="n">addFormAsNativeData</span><span class="p">(</span> <span class="n">ptwsXSec</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">piecewise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">piecewise</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">crossSectionRegions</span> <span class="p">:</span> 
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">piecewise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
        <span class="n">crossSection</span><span class="o">.</span><span class="n">addFormAsNativeData</span><span class="p">(</span> <span class="n">piecewise</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span><span class="p">[</span><span class="n">MT</span><span class="p">][</span><span class="s">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossSectionRegions</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">totalMT</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span><span class="p">[</span><span class="n">totalMT</span><span class="p">][</span><span class="s">&#39;MTs&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span><span class="p">[</span><span class="n">totalMT</span><span class="p">][</span><span class="s">&#39;partialPresent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">breakupProducts</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF4"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF4">[docs]</a><span class="k">def</span> <span class="nf">readMF4</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">componentClass</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">addAngularComponent</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LVT</span><span class="p">,</span> <span class="n">LTT</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF4Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">LVT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LVT</span> <span class="p">)</span>                <span class="c"># 1: transformation matrix given. Must be 0 for endf/b6 format but not older formats.</span>
    <span class="n">LTT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LTT</span> <span class="p">)</span>                <span class="c"># 0: isotropic, 1: Legendre, 2: table, 3: Legendre for low E and table for high E.</span>

    <span class="n">dummy</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">NM</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF4Data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">LI</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LI</span> <span class="p">)</span>                  <span class="c"># if 1, gammas isotropic</span>
    <span class="n">LCT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LCT</span> <span class="p">)</span>                <span class="c"># 1 for lab frame, 2 for center of mass</span>
    <span class="n">NK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span>                  <span class="c"># number of entries in transformation matrix</span>
    <span class="n">NM</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NM</span> <span class="p">)</span>                  <span class="c"># maximum Legendre order</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">LCT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">componentClass</span> <span class="o">==</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span> <span class="p">)</span> <span class="p">):</span> 
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Discrete two-body must be in the center-of-mass frame: LCT = </span><span class="si">%d</span><span class="s"> MT = </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">firstDataLine</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LVT</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: MF = 4, MT = 2 contains obsolete matrix used to transform Legendre coefficients between frames.&#39;</span> <span class="p">)</span>
        <span class="n">firstDataLine</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">NK</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>

    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; : MF=4, LTT = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LTT</span> <span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">LCT</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                <span class="c"># Purely isotropic angular distributions</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">componentClass</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>              <span class="c"># Legendre polynomial coefficient</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">firstDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;LTT = 1&#39;</span> <span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">componentClass</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>              <span class="c"># Tabulated probability distribution</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularTable</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">firstDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularTable</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">componentClass</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span>              <span class="c"># Mixed Legendre and Tabulated probability distribution</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">firstDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">formLegendre</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;LTT = 3&#39;</span> <span class="p">)</span>

        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularTable</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">formPointwise</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularTable</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">mixedRanges</span><span class="p">(</span> <span class="n">formLegendre</span><span class="p">,</span> <span class="n">formPointwise</span> <span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">componentClass</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>

    <span class="n">component</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
    <span class="n">form</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">addAngularComponent</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF5"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF5">[docs]</a><span class="k">def</span> <span class="nf">readMF5</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">delayNeutrons</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">product</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF5Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">NK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span>                 <span class="c"># number of partial energy distributions</span>
    <span class="n">dataLine</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">energyComponents</span><span class="p">,</span> <span class="n">energyForms</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">productData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">oneNR</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">oldInterpolations</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">oldInterpolations</span> <span class="o">==</span> <span class="p">[</span> <span class="p">[</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>       <span class="c"># This is a kludge for about 5 data sets, but does a good job.</span>
                <span class="n">productData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span> <span class="o">*</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">productData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported&quot;</span> <span class="p">)</span>
        <span class="n">LF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>           <span class="c"># breakup flag</span>
        <span class="n">xPrior</span><span class="p">,</span> <span class="n">addWarnging</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">xPrior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;xy[0] = </span><span class="si">%s</span><span class="s"> &lt; xPrior = </span><span class="si">%s</span><span class="s"> for MT=</span><span class="si">%d</span><span class="s">, MF=5&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xPrior</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">:</span> 
                    <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">addWarnging</span> <span class="p">)</span> <span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: weights have same energies, second one being incremented for MT=</span><span class="si">%d</span><span class="s">, MF=5&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                    <span class="n">addWarnging</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">xPrior</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">delayNeutrons</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for weight for MF=6, MT=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">interpolationx</span><span class="p">,</span> <span class="n">interpolationy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2d</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_in&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">interpolationx</span><span class="p">,</span> <span class="n">interpolationy</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;weight&#39;</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span>   <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span> <span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span>  <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">],</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span> <span class="p">)</span>
        <span class="n">energyInterpolation</span><span class="p">,</span> <span class="n">multiplicityInterpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2d</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyInterpolation</span> <span class="o">=</span> <span class="n">energyInterpolation</span><span class="p">,</span>
            <span class="n">multiplicityName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">multiplicityInterpolation</span> <span class="o">=</span> <span class="n">multiplicityInterpolation</span> <span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">],</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span> <span class="p">)</span> <span class="p">)</span>   <span class="c"># weights is only used for delayed nu_bar data</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                       <span class="c"># Always lab frame.</span>
        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; : MF=5, LF=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LF</span> <span class="p">)</span>
        <span class="c"># &#39;upper energy limit&#39;:</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="s">&#39;eV&#39;</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_out&#39;</span><span class="p">,</span>              <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span>   <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;P(energy_out|energy_in)&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;1/eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">asRegions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">convertToPointwiseOrPiecewiseEnergy</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">gs</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;1/eV&#39;</span><span class="p">,</span> <span class="n">gs</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">generalEvaporationSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">gs</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">7</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">simpleMaxwellianFissionSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">oneNR</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">thetas</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">oldInterpolations</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span>
                <span class="n">iMin</span> <span class="o">=</span> <span class="n">oldInterpolations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oldInterpolations</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iMin</span> <span class="p">)</span> <span class="p">:</span> <span class="n">iMin</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">thetas</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">thetas</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span> <span class="n">thetas</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="n">iMin</span> <span class="p">]</span> <span class="p">]</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: multiple interpolation = </span><span class="si">%s</span><span class="s"> reduce to </span><span class="si">%s</span><span class="s"> for particle </span><span class="si">%d</span><span class="s"> of </span><span class="si">%d</span><span class="s"> for MF = 5, LF = </span><span class="si">%d</span><span class="s">, MT = </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span> <span class="n">oldInterpolations</span><span class="p">,</span> <span class="n">thetas</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">],</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">evaporationSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">a</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;1/eV&#39;</span><span class="p">,</span> <span class="n">b</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">WattSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">Ts</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">EFL</span><span class="p">,</span> <span class="n">EFH</span> <span class="o">=</span> <span class="p">[</span><span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="n">Ts</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">])]</span>
            <span class="n">Ts</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&#39;T_M&#39;</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">Ts</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">MadlandNix</span><span class="p">(</span> <span class="n">EFL</span><span class="p">,</span> <span class="n">EFH</span><span class="p">,</span> <span class="n">Ts</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unsupported LF = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">LF</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">delayNeutrons</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="n">component</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

        <span class="n">energyForms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="n">energyComponents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">delayNeutrons</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;using energy.weightedFunctionals form&#39;</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">weightedFunctionals</span><span class="p">(</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">functional</span> <span class="ow">in</span> <span class="n">energyForms</span> <span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">functional</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">functional</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
                    <span class="n">ENDF_Accuracy</span><span class="p">,</span> <span class="n">isPrimaryXData</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">),</span> <span class="n">functional</span> <span class="p">)</span>
                <span class="n">form</span><span class="o">.</span><span class="n">addWeight</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span>
                <span class="k">del</span> <span class="n">functional</span><span class="o">.</span><span class="n">weight</span>
            <span class="n">energyComponents</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="n">energyComponents</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">energyComponents</span> <span class="o">=</span> <span class="n">energyComponents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">energyComponents</span><span class="p">,</span> <span class="n">weights</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF6"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF6">[docs]</a><span class="k">def</span> <span class="nf">readMF6</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span><span class="p">,</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LCT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LCT</span> <span class="p">)</span>
    <span class="n">LCTLight</span><span class="p">,</span> <span class="n">LCTWeight</span> <span class="o">=</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">LCT</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span> <span class="n">LCTLight</span><span class="p">,</span> <span class="n">LCTWeight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">NK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span>                  <span class="c"># number of outgoing particle data sets</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">discretePrimaryGammas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[]</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; : MF=6&#39;</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">outGoing</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">ifLegendreConvertedToEnergy</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">ZAP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">productData</span><span class="p">,</span> <span class="n">multiplicityRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">oneNR</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="c"># ZAP is ZA for outgoing particle; AWP is its atomic mass, LIP: 0 for residual in ground state, 1 for first excited state, etc</span>
        <span class="n">ZAP</span><span class="p">,</span> <span class="n">AWP</span><span class="p">,</span> <span class="n">LIP</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">NP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;L1&#39;</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;L2&#39;</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span>
        <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">AWP</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span> <span class="p">)</span> <span class="p">:</span> 
            <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">AWP</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">AWP</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ZAP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZAP</span> <span class="p">)</span>            <span class="c"># ZA for outgoing particle; AWP is its atomic mass</span>
        <span class="n">LCTp</span> <span class="o">=</span> <span class="n">LCTLight</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">:</span> <span class="n">LCTp</span> <span class="o">=</span> <span class="n">LCTWeight</span>
        <span class="n">LAW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LAW</span> <span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">LCTp</span><span class="p">]</span>

        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; : ZAP=</span><span class="si">%s</span><span class="s">, LAW=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">LAW</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">isTwoBodyGamma</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">NBodyGenre</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>                 <span class="c"># Need to check if this should be done for all reactions???????//</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">unknownComponentToken</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">unknownComponent</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">noneComponentToken</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">LEP</span><span class="p">,</span> <span class="n">NR</span><span class="p">,</span> <span class="n">NE</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">LANG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LANG</span> <span class="p">)</span>          <span class="c"># identifies the type of data</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;, LANG=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LANG</span> <span class="p">)</span>
            <span class="n">LEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LEP</span> <span class="p">)</span>            <span class="c"># interpolation type for outgoing energy</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LEP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only LEP = 1 or 2 (flat or linear) interpolation is allowed for MF = 6 data; LEP = </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">LEP</span> <span class="p">)</span>
            <span class="n">interpolationE_out</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span>                   <span class="c"># Only works because of LEP check a few lines above.</span>
            <span class="n">interpolationC_l</span> <span class="o">=</span> <span class="n">ENDFInterpolationToGND</span><span class="p">[</span><span class="n">LEP</span><span class="p">]</span>  <span class="c"># Only works because of LEP check a few lines above.</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">NR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NR</span> <span class="p">)</span>              <span class="c"># number of interpolation regions for incident energy</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">NR</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 1, LANG = 2; MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">NE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NE</span> <span class="p">)</span>              <span class="c"># number of incident energies</span>
        
                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">EinInterpolationTypes</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">nStringsToInts</span><span class="p">(</span> <span class="n">NR</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">EinInterpolationTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">NR</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>    <span class="c"># the next data is energy-angle distributions</span>
                <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">Legendre</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">energyInterpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span><span class="p">,</span>
                    <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span> <span class="n">energy_outInterpolation</span> <span class="o">=</span> <span class="n">interpolationE_out</span><span class="p">,</span> <span class="n">C_lInterpolation</span> <span class="o">=</span> <span class="n">interpolationC_l</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">Legendre</span><span class="o">.</span><span class="n">pointwise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
                <span class="n">axes__</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">referenceAxes</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                <span class="n">massRatio</span> <span class="o">=</span> <span class="n">AWR</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">AWR</span> <span class="p">)</span>
                <span class="n">maxLegendre</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">EinCount</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NE</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">dummy</span><span class="p">,</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">ND</span><span class="p">,</span> <span class="n">NA</span><span class="p">,</span> <span class="n">NW</span><span class="p">,</span> <span class="n">NEP</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">ND</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ND</span> <span class="p">)</span>          <span class="c"># number of discrete gammas (nonzero only for gammas)</span>
                    <span class="n">NA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NA</span> <span class="p">)</span>          <span class="c"># number of angular parameters (i.e., lMax).</span>
                    <span class="n">NW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NW</span> <span class="p">)</span>          <span class="c"># number of data values for this incident energy</span>
                    <span class="n">NEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEP</span> <span class="p">)</span>        <span class="c"># number of outgoing energy values</span>
                    <span class="n">maxLegendre</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="n">maxLegendre</span><span class="p">,</span> <span class="n">NA</span> <span class="p">)</span>
                    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ND</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">discreteGammasAtE</span><span class="p">,</span> <span class="n">EoutData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">readDiscreteAndLegendre</span><span class="p">(</span> <span class="n">ND</span><span class="p">,</span> <span class="n">NEP</span><span class="o">-</span><span class="n">ND</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="n">NA</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="n">discreteEnergies</span> <span class="o">=</span> <span class="p">[</span><span class="n">discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">discrete</span> <span class="ow">in</span> <span class="n">discreteGammasAtE</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discreteEnergies</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">discreteEnergies</span><span class="p">)):</span>
                            <span class="c"># Have two or more gammas with identical energy (Fm255 MT91 for example).</span>
                            <span class="c"># For now, just add a small epsilon</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discreteEnergies</span><span class="p">)):</span>
                                <span class="k">while</span> <span class="n">discreteGammasAtE</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                                    <span class="n">discreteGammasAtE</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">FUDGE_EPS</span>
                                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discreteGammasAtE</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">discretePrimaryGammasAtE</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">discreteGammasAtE</span> <span class="p">:</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">Eg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">Ein</span> <span class="o">&lt;</span> <span class="mf">1e-2</span> <span class="p">)</span> <span class="p">:</span>              <span class="c"># Generally, Eg ~ 1e6 and first Ein ~ 1e-5, so ignore Ein correction here.</span>
                                    <span class="n">Epg</span> <span class="o">=</span> <span class="o">-</span><span class="n">Eg</span>
                                <span class="k">else</span> <span class="p">:</span>
                                    <span class="n">Epg</span> <span class="o">=</span> <span class="o">-</span><span class="n">Eg</span> <span class="o">-</span> <span class="n">massRatio</span> <span class="o">*</span> <span class="n">Ein</span>
                                <span class="n">discretePrimaryGammasAtE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">Epg</span><span class="p">,</span> <span class="p">[</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">P</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                            <span class="k">else</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">Eg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="p">:</span> <span class="n">discreteGammas</span><span class="p">[</span><span class="n">Eg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">discreteGammas</span><span class="p">[</span><span class="n">Eg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">P</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammasAtE</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="n">discretePrimaryGammas</span> <span class="o">=</span> <span class="n">discretePrimaryGammasAtE</span>
                            <span class="k">else</span> <span class="p">:</span>      <span class="c"># Now we need to match level energies (aka binding energies) from prior with Ein&#39;s with current Ein.</span>
                                        <span class="c"># This is needed since for different Ein&#39;s, the calculation of Epg will vary slightly (hopefully less than 1e-4).</span>
                                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammasAtE</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;number of primary gammas at Ein = </span><span class="si">%s</span><span class="s"> is different then first incident energy&#39;</span> <span class="o">%</span> <span class="n">Ein</span> <span class="p">)</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">Eg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">if</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">Eg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">discretePrimaryGammasAtE</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-4</span> <span class="o">*</span> <span class="n">Eg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> \
                                        <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;primary energy of </span><span class="si">%s</span><span class="s"> is not close to primary energy </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">Eg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">discretePrimaryGammasAtE</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                                    <span class="n">Eg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">discretePrimaryGammasAtE</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">EoutData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">nFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">NEP</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">NA</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">EoutData</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="c"># test for some common TENDL problems:</span>
                        <span class="c"># 1: all outgoing energies==0 for continuum gammas.</span>
                        <span class="c"># This usually only affects one incident energy, so just replace that energy with empty outgoing distribution:</span>
                        <span class="n">energy_out_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">EoutData</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">energy_out_list</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Format error! At Ein=</span><span class="si">%s</span><span class="s"> eV, continuum gamma outgoing energies are all 0.0 (MT=</span><span class="si">%i</span><span class="s">, ZAP=</span><span class="si">%i</span><span class="s">)!&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">Ein</span><span class="p">,</span><span class="n">MT</span><span class="p">,</span><span class="n">ZAP</span><span class="p">))</span>
                            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                            <span class="n">EoutData</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]]</span>
                        <span class="c"># 2: trouble with duplicate outgoing energies:</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span> <span class="p">[</span><span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">energy_out_list</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
                                <span class="ow">or</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Too many duplicate outgoing energies for Ein=</span><span class="si">%s</span><span class="s"> eV in W_XYs_LegendreSeries (MT=</span><span class="si">%i</span><span class="s">, ZAP=</span><span class="si">%i</span><span class="s">)!&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">Ein</span><span class="p">,</span><span class="n">MT</span><span class="p">,</span><span class="n">ZAP</span><span class="p">))</span>
                            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">finalZeroIndex</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                                <span class="n">energy_out_list</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="p">[</span> <span class="n">finalZeroIndex</span><span class="p">:</span> <span class="p">]</span>
                                <span class="n">EoutData</span> <span class="o">=</span> <span class="n">EoutData</span><span class="p">[</span> <span class="n">finalZeroIndex</span><span class="p">:</span> <span class="p">]</span>
                            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_out_list</span><span class="p">):</span>
                                <span class="n">eout</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">eoutCount</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">eout</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">eoutCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">EoutData</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">eoutCount</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
                                    <span class="n">i</span> <span class="o">+=</span> <span class="n">eoutCount</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">EoutData</span> <span class="o">=</span> <span class="n">tmp</span>
                        <span class="c"># end of TENDL-specific tests</span>
                        <span class="n">w_xys_LegendreSeries</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">W_XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes__</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">EinCount</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Ein</span> <span class="p">)</span>
                        <span class="n">nm1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">EoutData</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">EpCs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">EoutData</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">e_out</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">EpCs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EpCs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">nm1</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">e_out</span> <span class="o">==</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">e_out</span> <span class="o">*=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
                            <span class="n">w_xys_LegendreSeries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e_out</span> <span class="p">)</span>
                        <span class="n">form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">w_xys_LegendreSeries</span> <span class="p">)</span>
                    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="n">NW</span> <span class="o">-</span>  <span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>    <span class="c"># Offset for the next incident energy</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">Legendre</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>

                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">maxLegendre</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>        <span class="c"># Only have l=0 for each outgoing energy. Convert this to</span>
                                                                    <span class="c"># uncorrelated with P(E_out|E_in) and isotropic angular distribution.</span>
                    <span class="n">ifLegendreConvertedToEnergy</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">componentAngular</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">isotropicFormToken</span> <span class="p">)</span>
                    <span class="n">componentAngular</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">componentEnergy</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">pointwiseFormToken</span> <span class="p">)</span>
                    <span class="n">pointwiseData</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">w_xys_LegendreSeries</span> <span class="ow">in</span> <span class="n">form</span> <span class="p">:</span>
                        <span class="n">energy_in</span> <span class="o">=</span> <span class="n">w_xys_LegendreSeries</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">pointwiseData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">energy_in</span><span class="p">,</span> <span class="p">[</span> <span class="p">[</span> <span class="n">lco</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">lco</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">lco</span> <span class="ow">in</span> <span class="n">w_xys_LegendreSeries</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="n">smearXYs</span><span class="p">(</span> <span class="n">pointwiseData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">form2</span> <span class="o">=</span> <span class="n">toPointwiseEnergy</span><span class="p">(</span> <span class="n">pointwiseData</span><span class="p">,</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationE_out</span><span class="p">,</span> <span class="n">interpolationC_l</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span>
                    <span class="n">componentEnergy</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form2</span> <span class="p">)</span>
                    <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">uncorrelated</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">componentAngular</span><span class="p">,</span> <span class="n">componentEnergy</span> <span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>             <span class="c"># Kalbach-Mann data</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LCTp</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;LCT = </span><span class="si">%s</span><span class="s"> != 2 as required for Kalbach-Mann data for MF=6, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LCTp</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">dataLine</span><span class="p">,</span> <span class="n">KalbachMannData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 1, LANG = 2; MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> \
                    <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">)</span>
                <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_in&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_out&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">interpolationE_out</span><span class="p">,</span> <span class="n">interpolationC_l</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">axes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;f&#39;</span><span class="p">,</span>          <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;1/eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">KMForm</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energyAngular</span><span class="o">.</span><span class="n">KalbachMann_Form_fr_Token</span>
                <span class="n">NA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">NA</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="n">KMForm</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energyAngular</span><span class="o">.</span><span class="n">KalbachMann_Form_fra_Token</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energyAngular</span><span class="o">.</span><span class="n">KalbachMann</span><span class="p">(</span> <span class="n">KMForm</span><span class="p">,</span> <span class="n">axes_</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="c"># test for another common TENDL problem: repeated incident energy in Kalbach-Mann:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energyAngular</span><span class="o">.</span><span class="n">KalbachMannCoefficients</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;Format error! Duplicate KalbachMann incident energy for MT</span><span class="si">%i</span><span class="s">, ZAP</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MT</span><span class="p">,</span><span class="n">ZAP</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energyAngular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unsupported LANG = </span><span class="si">%d</span><span class="s"> for continuum energy-angle distribution MF = 6: ZAP = </span><span class="si">%d</span><span class="s">, LAW = </span><span class="si">%d</span><span class="s">: MT = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Discrete two-body must be in the center-of-mass frame: LCT = </span><span class="si">%d</span><span class="s"> MT = </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="p">(</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">isTwoBody</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">isTwoBodyGamma</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">LANG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;L1&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;, LANG=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LANG</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 2, LANG = </span><span class="si">%s</span><span class="s">; MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">interpolationE_in</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND3plusd</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">AWP</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;primary gamma data for LAW=2 with LANG=</span><span class="si">%s</span><span class="s"> != 0&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c"># This only works as later its length is check and if 0, set to none.</span>
                <span class="n">discretePrimaryGammas</span> <span class="o">=</span> <span class="p">[</span> <span class="n">AWP</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">angularDatum</span> <span class="ow">in</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">discretePrimaryGammas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">angularDatum</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="p">[</span> <span class="mf">1.0</span> <span class="p">]</span> <span class="o">+</span> <span class="n">angularDatum</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">discretePrimaryGammas</span> <span class="o">=</span> <span class="p">[</span> <span class="n">discretePrimaryGammas</span> <span class="p">]</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;LAW = 2, LANG = 0&#39;</span> <span class="p">)</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LANG</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;LANG = </span><span class="si">%d</span><span class="s"> for LAW = </span><span class="si">%d</span><span class="s"> not supported: MT = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">angularTwoBodyGenre</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">angularTwoBodyGenre</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">recoil</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">angularTwoBodyGenre</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>  <span class="c"># charged-particle elastic scattering</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Charged-particle elastic must be in the center-of-mass frame: LCT = </span><span class="si">%d</span><span class="s"> MT = </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="p">(</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">SPI</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">]</span>
            <span class="n">LIDP</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;L1&#39;</span><span class="p">]</span>
            <span class="n">LTP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;L1&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;, LTP=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LTP</span> <span class="p">)</span>
            <span class="n">interpolationE_in</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND3plusd</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="c"># LTP flag changes interpretation of the data:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LTP</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">convertNuclearPlusInterferenceDataToPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;LAW = 5, LTP = </span><span class="si">%i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">LTP</span><span class="p">,</span> <span class="n">LIDP</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LTP</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;MF=6 LAW=5 LTP=2 not yet implemented (MT</span><span class="si">%i</span><span class="s">)!&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LTP</span> <span class="ow">in</span> <span class="p">(</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LTP</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">pointwise</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Have we hit this yet. If not, we have not tested it: LTP = </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LTP</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;unknown LTP encountered for MF=6, LAW=5, MT=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">CoulombElasticComponent</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">identicalParticles</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">LIDP</span><span class="p">),</span> <span class="n">spin</span><span class="o">=</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">genre</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">angularTwoBodyGenre</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">APSX</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NPSX</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">APSX</span> <span class="o">*=</span> <span class="n">info</span><span class="o">.</span><span class="n">masses</span><span class="o">.</span><span class="n">getMassFromZA</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="n">componentAngular</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">isotropicFormToken</span> <span class="p">)</span>
            <span class="n">componentAngular</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>        <span class="c"># Some data has the wrong frame, should always be com.</span>
            <span class="n">componentEnergy</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">NBodyPhaseSpaceFormToken</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">NBodyPhaseSpace</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NPSX</span> <span class="p">),</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">APSX</span><span class="p">,</span> <span class="s">&#39;amu&#39;</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">componentEnergy</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">uncorrelated</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">componentAngular</span><span class="p">,</span> <span class="n">componentEnergy</span> <span class="p">)</span>

        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">7</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">NEData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2Header</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">NR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="p">)</span>                    <span class="c"># number of interpolation regions for this incident energy</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">NR</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 7; MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">iE</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEData</span><span class="p">[</span><span class="s">&#39;NZ&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>   <span class="c"># Loop over incident energies</span>
                <span class="n">dataLine</span><span class="p">,</span> <span class="n">muEpETable</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">iE</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">energy_inInterpolation</span><span class="p">,</span> <span class="n">energy_inFunctionInterpolation</span><span class="p">,</span> <span class="n">energy_inInterpolationQualifier</span> <span class="o">=</span> \
                        <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">NEData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">interpolationXYFlag</span> <span class="o">=</span> <span class="n">muEpETable</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">muInterpolation</span><span class="p">,</span> <span class="n">dummy1</span><span class="p">,</span> <span class="n">dummy2</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">interpolationXYFlag</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">dummy1</span> <span class="o">!=</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;mu functional interpolation not linear but </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">dummy1</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">dummy2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;mu interpolation qualifier not None but </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">dummy2</span> <span class="p">)</span>
                    <span class="n">energy_outInterpolation</span><span class="p">,</span> <span class="n">probabilityInterpolation</span><span class="p">,</span> <span class="n">dummy2</span> <span class="o">=</span> \
                        <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">muEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">dummy2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;energy_out interpolation qualifier not None but </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">dummy2</span> <span class="p">)</span>
                    <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angularEnergy</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyInterpolation</span> <span class="o">=</span> <span class="n">energy_inInterpolation</span><span class="p">,</span> 
                        <span class="n">energyFunctionInterpolation</span> <span class="o">=</span> <span class="n">energy_inFunctionInterpolation</span><span class="p">,</span> <span class="n">energyInterpolationQualifier</span> <span class="o">=</span> <span class="n">energy_inInterpolationQualifier</span><span class="p">,</span>
                        <span class="n">muInterpolation</span> <span class="o">=</span> <span class="n">muInterpolation</span><span class="p">,</span> <span class="n">energy_outInterpolation</span> <span class="o">=</span> <span class="n">energy_outInterpolation</span><span class="p">,</span> 
                        <span class="n">probabilityInterpolation</span> <span class="o">=</span> <span class="n">probabilityInterpolation</span><span class="p">,</span> <span class="n">othersFrame</span> <span class="o">=</span> <span class="n">frame</span> <span class="p">)</span>
                    <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angularEnergy</span><span class="o">.</span><span class="n">pointwise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
                    <span class="n">axesW_XY</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">referenceAxes</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">)</span>
                    <span class="n">axesXY</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">referenceAxes</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">muEpETable</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 7; MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">w_xys</span> <span class="o">=</span> <span class="n">W_XYs</span><span class="o">.</span><span class="n">W_XYs</span><span class="p">(</span> <span class="n">axesW_XY</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">iE</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">muEpETable</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">iMu</span><span class="p">,</span> <span class="n">TAB1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">muEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 7; MT = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">interpolationXYFlag</span> <span class="p">)</span> <span class="p">:</span> 
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;interpolationXYFlag = </span><span class="si">%s</span><span class="s"> changing to </span><span class="si">%s</span><span class="s"> is not allowed&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">interpolationXYFlag</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">w_xys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axesXY</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">],</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">iMu</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">w_xys</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">w_xys</span> <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angularEnergy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;LAW = </span><span class="si">%d</span><span class="s"> not implemented: MT = </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span>  <span class="p">(</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">multiplicityData</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">yMin</span><span class="p">,</span> <span class="n">intergerMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityData</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">False</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">yMin</span> <span class="p">)</span> <span class="o">==</span> <span class="n">yMin</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">intergerMultiplicity</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">multiplicityData</span> <span class="p">:</span> <span class="n">intergerMultiplicity</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="n">yMin</span> <span class="o">==</span> <span class="n">y</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">intergerMultiplicity</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">yMin</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">multiplicityRegions</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">yMin</span><span class="p">(</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;       WARNING: Negative multiplicity encountered for MF6, MT</span><span class="si">%i</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> 
                <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>

            <span class="k">def</span> <span class="nf">addGammaProduct</span><span class="p">(</span> <span class="n">component</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">:</span>

                <span class="n">firstGamma</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">firstGamma_Multiplicity</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">firstGamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span> <span class="n">firstGamma</span> <span class="p">)</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="bp">None</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">firstGamma</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">firstGamma_Multiplicity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span>
                <span class="n">component</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
                <span class="k">return</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>       <span class="c"># May be required for LAW = 4 logic.</span>

            <span class="k">def</span> <span class="nf">addGammaWeightedMultiplicity</span><span class="p">(</span> <span class="n">component</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;Have Legendre section with only L=0 for discrete gammas. </span>
<span class="sd">                Convert to a weighted multiplicity (with link to continuum gamma mult) along with isotropic angular dist.&quot;&quot;&quot;</span>

                <span class="n">firstGamma</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">firstGamma_Multiplicity</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">firstGamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">lco</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">lco</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">lco</span> <span class="ow">in</span> <span class="n">form</span> <span class="p">]</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">lco</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">lco</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">lco</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span> <span class="p">]</span>
                    <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">multiplicityName</span> <span class="o">=</span> <span class="s">&#39;weight&#39;</span> <span class="p">)</span>
                    <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">ENDF_Accuracy</span><span class="p">,</span> <span class="n">isPrimaryXData</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">weightedReference</span><span class="p">(</span> <span class="n">firstGamma</span><span class="p">,</span> <span class="n">weights</span> <span class="p">)</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="bp">None</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">firstGamma</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">firstGamma_Multiplicity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span>
                <span class="n">component</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">component</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">isotropicFormToken</span>
                <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
                <span class="k">return</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>       <span class="c"># May be required for LAW = 4 logic.</span>

            <span class="k">def</span> <span class="nf">addGamma</span><span class="p">(</span> <span class="n">distinctType</span><span class="p">,</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">ELegenres</span><span class="p">,</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">axes</span> <span class="p">)</span> <span class="p">:</span>

                <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span><span class="p">(</span> <span class="n">axes</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ELegenre</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">ELegenres</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">form</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="n">ELegenre</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ELegenre</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="n">distinctType</span> <span class="p">:</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">Eg</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span> <span class="p">)</span> <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBodyGamma</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>

                <span class="n">maxLegendre</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ELegenres</span> <span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">maxLegendre</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">firstGamma_Multiplicity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>  <span class="p">)</span> <span class="p">:</span> <span class="c"># Only have L_0 for each incident energy, convert to weighted multiplicity</span>
                    <span class="k">return</span><span class="p">(</span> <span class="n">addGammaWeightedMultiplicity</span><span class="p">(</span> <span class="n">component</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="p">)</span> <span class="p">)</span>

                <span class="k">return</span><span class="p">(</span> <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">component</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="p">)</span> <span class="p">)</span>

            <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">form</span> <span class="o">!=</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">dgInterpolationE_in</span><span class="p">,</span> <span class="n">dgInterpolationCl</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">getInterpolationTokens</span><span class="p">(</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>  
                <span class="n">dgInterpolationE_in</span><span class="p">,</span> <span class="n">dgInterpolationCl</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span>
            <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">frame</span><span class="p">,</span> <span class="n">dgInterpolationE_in</span><span class="p">,</span> <span class="n">dgInterpolationCl</span><span class="p">,</span> 
                <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
            <span class="n">firstGamma_Multiplicity</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">None</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span> <span class="o">=</span> <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">component</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">firstGamma_Multiplicity</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">Eg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span> <span class="o">=</span> <span class="n">addGamma</span><span class="p">(</span> <span class="s">&#39;discrete&#39;</span><span class="p">,</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">[</span><span class="n">Eg</span><span class="p">],</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">axes_</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">EgEinPs</span> <span class="ow">in</span> <span class="n">discretePrimaryGammas</span> <span class="p">:</span> <span class="n">product</span> <span class="o">=</span> <span class="n">addGamma</span><span class="p">(</span> <span class="s">&#39;primary&#39;</span><span class="p">,</span> <span class="n">EgEinPs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EgEinPs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">firstGamma_Multiplicity</span><span class="p">,</span> <span class="n">axes_</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">thisParticle</span> <span class="o">=</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LIP</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">thisParticle</span> <span class="o">=</span> <span class="n">thisParticle</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">LIP</span><span class="p">)</span> <span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c"># this excited level is missing from MF8. Make a level with unknown energy:</span>
                    <span class="n">excitedStateName</span> <span class="o">=</span> <span class="n">thisParticle</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_e</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">LIP</span><span class="p">)</span>
                    <span class="n">unknownLevel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">miscellaneous</span><span class="o">.</span><span class="n">undefinedLevel</span><span class="p">(</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">thisParticle</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">LIP</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">nuclearLevel</span><span class="p">(</span> <span class="n">excitedStateName</span><span class="p">,</span> <span class="n">unknownLevel</span><span class="p">,</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">LIP</span><span class="p">),</span> <span class="n">groundState</span><span class="o">=</span><span class="n">thisParticle</span> <span class="p">)</span>
                    <span class="n">thisParticle</span> <span class="o">=</span> <span class="n">thisParticle</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">LIP</span><span class="p">)</span> <span class="p">]</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;       WARNING: unknown excited state </span><span class="si">%s</span><span class="s"> encountered in MF6&quot;</span> <span class="o">%</span> <span class="n">thisParticle</span> <span class="p">)</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">thisParticle</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">genre</span> <span class="o">!=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">noneComponentToken</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">genre</span> <span class="o">!=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">unknownComponentToken</span> <span class="p">)</span> <span class="p">:</span> <span class="n">component</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
            <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ifLegendreConvertedToEnergy</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="s">&#39;MF6&#39;</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;interpolation </span><span class="si">%s</span><span class="s"> is not linear for gamma multiplicity&#39;</span> <span class="o">%</span> <span class="n">productData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productList</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="ow">in</span> <span class="p">[</span> <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;gamma&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="s">&#39;MF6&#39;</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF8"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF8">[docs]</a><span class="k">def</span> <span class="nf">readMF8</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">454</span><span class="p">,</span> <span class="mi">459</span> <span class="p">]:</span> <span class="c"># this is fission yield data</span>
        <span class="n">MF8Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LE1</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF8Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">iLine</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">allData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iLE</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">LE1</span> <span class="p">):</span>
            <span class="n">iLine</span><span class="p">,</span> <span class="n">thisData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="n">iLine</span><span class="p">,</span> <span class="n">MF8Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">NFP</span> <span class="o">=</span> <span class="n">thisData</span><span class="p">[</span> <span class="s">&#39;N2&#39;</span> <span class="p">]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">thisData</span><span class="p">[</span> <span class="s">&#39;C1&#39;</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">iFP</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">NFP</span> <span class="p">):</span>
                <span class="n">ZAFP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">thisData</span><span class="p">[</span> <span class="s">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">FPS</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span> <span class="n">thisData</span><span class="p">[</span> <span class="s">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">Y</span> <span class="o">=</span>    <span class="n">thisData</span><span class="p">[</span> <span class="s">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span>
                <span class="n">DY</span> <span class="o">=</span>   <span class="n">thisData</span><span class="p">[</span> <span class="s">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ZAFP</span><span class="p">,</span> <span class="n">FPS</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allData</span><span class="p">:</span> <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">E</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">DY</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">allData</span>

    <span class="k">else</span><span class="p">:</span> <span class="c"># this is regular decay data</span>
        <span class="n">firstLMF</span><span class="p">,</span> <span class="n">radioactiveDatas</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">if</span><span class="p">(</span> <span class="mi">8</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF8Data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">LISO</span><span class="p">,</span> <span class="n">NS</span><span class="p">,</span> <span class="n">NO</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF8Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
            <span class="n">MF9Data</span> <span class="o">=</span> <span class="n">readMF9or10</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">LIS</span> <span class="p">)</span>
            <span class="n">MF10Data</span> <span class="o">=</span> <span class="n">readMF9or10</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">LIS</span> <span class="p">)</span>
            <span class="n">residualXSecWeight</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NS</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">ZAP</span><span class="p">,</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">LFS</span><span class="p">,</span> <span class="n">ND6</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF8Data</span><span class="p">[</span><span class="n">dataLine</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">firstLMF</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">firstLMF</span> <span class="o">=</span> <span class="n">LMF</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">!=</span> <span class="n">firstLMF</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;LMF changing from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s"> is not allowed&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">firstLMF</span><span class="p">,</span> <span class="n">LMF</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">ELFS</span>
                <span class="k">try</span> <span class="p">:</span>
                    <span class="n">residual</span> <span class="o">=</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">LFS</span> <span class="p">)</span>
                <span class="k">except</span> <span class="p">:</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">MT = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                    <span class="k">raise</span>
                <span class="n">crossSection</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
                <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">ND6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;LMF = 6 not supported for MF = 8 data, MT = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span> <span class="n">LMF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">MF9Data</span> <span class="ow">or</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">MF10Data</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">LMF1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="k">if</span> <span class="n">LMF</span><span class="o">==</span><span class="mi">9</span> <span class="k">else</span> <span class="mi">9</span><span class="p">)</span>
                        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;LMF = </span><span class="si">%i</span><span class="s">, but no MF=</span><span class="si">%i</span><span class="s"> found for MT</span><span class="si">%i</span><span class="s">. Trying LMF=</span><span class="si">%i</span><span class="s"> instead&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LMF1</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                        <span class="n">LMF</span> <span class="o">=</span> <span class="n">LMF1</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">):</span>
                        <span class="n">TAB1</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">MF9Data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">TAB1</span><span class="p">,</span> <span class="n">crossSection</span> <span class="o">=</span> <span class="n">MF10Data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">IZAP</span><span class="p">,</span> <span class="n">LFS</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;L1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">ELFS9or10</span> <span class="o">=</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ELFS</span> <span class="o">-</span> <span class="n">ELFS9or10</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">2e-4</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ELFS</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> 
                        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;MF8 residual level energy = </span><span class="si">%s</span><span class="s"> for level </span><span class="si">%s</span><span class="s"> of ZA = </span><span class="si">%d</span><span class="s"> not close to MF</span><span class="si">%s</span><span class="s">&#39;s value = </span><span class="si">%s</span><span class="s"> for MT = </span><span class="si">%s</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">ELFS9or10</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                        <span class="n">ELFS9or10</span> <span class="o">=</span> <span class="n">ELFS</span>    <span class="c"># assume MF=8 has the correct value</span>
                <span class="n">radioactiveDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">LFS</span><span class="p">,</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span> <span class="p">]</span> <span class="p">)</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">NO</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">dataLine</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">ND6</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">radioactiveDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span><span class="p">(</span> <span class="n">firstLMF</span><span class="p">,</span> <span class="n">radioactiveDatas</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF9or10"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF9or10">[docs]</a><span class="k">def</span> <span class="nf">readMF9or10</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">targetLIS</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MTData</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="bp">None</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">MFData</span><span class="p">,</span> <span class="n">MF9or10</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="n">MF</span><span class="p">],</span> <span class="p">[]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NS</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MFData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LIS</span> <span class="o">!=</span> <span class="n">targetLIS</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;residual&#39;s LIS = </span><span class="si">%s</span><span class="s"> does not match target&#39;s LIS = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">targetLIS</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">crossSectionUnit</span> <span class="o">=</span> <span class="s">&#39;b&#39;</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span><span class="n">labelsUnits</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="s">&#39;energy_in&#39;</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">:(</span><span class="s">&#39;weight&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)})</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NS</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">IZAP</span><span class="p">,</span> <span class="n">LFS</span><span class="p">,</span> <span class="n">NR</span><span class="p">,</span> <span class="n">NP</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MFData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MFData</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">oneNR</span> <span class="o">=</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">regions</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>         <span class="c"># Store as pointwise:</span>
                <span class="n">XSec</span> <span class="o">=</span> <span class="n">getCrossSectionLinearOrPointwise</span><span class="p">(</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">piecewise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">crossSectionUnit</span> <span class="o">=</span> <span class="s">&#39;b&#39;</span> <span class="p">)</span>
                <span class="n">XSec</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">regions</span> <span class="p">)</span> <span class="p">:</span> <span class="n">XSec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">XSec</span> <span class="o">=</span> <span class="n">regions</span>
        <span class="n">MF9or10</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">XSec</span> <span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">MF9or10</span>  <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF12_13"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF12_13">[docs]</a><span class="k">def</span> <span class="nf">readMF12_13</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gammaBRTolerance</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">def</span> <span class="nf">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">gList</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">region</span> <span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;EGk is the gamma&#39;s energy and ESk is the gamma&#39;s origination level energy.&quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">EGk</span> <span class="ow">in</span> <span class="n">gList</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Gammas with the same energy (</span><span class="si">%s</span><span class="s">) are not supported: MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">gList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span> <span class="s">&#39;EGk&#39;</span> <span class="p">:</span> <span class="n">EGk</span><span class="p">,</span> <span class="s">&#39;ESk&#39;</span> <span class="p">:</span> <span class="n">ESk</span><span class="p">,</span> <span class="s">&#39;LP&#39;</span> <span class="p">:</span> <span class="n">LP</span><span class="p">,</span> <span class="s">&#39;LF&#39;</span> <span class="p">:</span> <span class="n">LF</span><span class="p">,</span> <span class="s">&#39;yield&#39;</span> <span class="p">:</span> <span class="n">region</span><span class="p">,</span> <span class="s">&#39;angular&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;energy&#39;</span> <span class="p">:</span> <span class="bp">None</span> <span class="p">}</span> <span class="p">)</span>
        <span class="c">#if( ( EGk != 0. ) and ( len( region ) &gt; 1 ) ) :     # There are many continuum gammas with multiple yield regions</span>
        <span class="c">#    raise Exception( &#39;Gamma yield with multiple regions not implemented: MT=%s EGk=%s&#39; % ( MT, EGk ) )</span>

    <span class="k">def</span> <span class="nf">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">angularForm</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">angularForm</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">angularForm</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>             <span class="c"># Why lab frame????????</span>
        <span class="n">angularComponent</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">angularForm</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="n">angularComponent</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">angularForm</span> <span class="p">)</span>
        <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angularComponent</span>

    <span class="k">def</span> <span class="nf">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">ESk</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">yields_</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;yield&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">yields_</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">yields_</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">yUnit</span> <span class="o">=</span> <span class="n">yields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span> <span class="n">yields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">yield_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">yields_</span> <span class="p">)</span> <span class="p">:</span> <span class="n">multiplicity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yield_</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">yields_</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="n">yields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">xsc</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">toPointwiseLinear</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mult</span><span class="p">):</span>
                    <span class="n">xsc_i</span> <span class="o">=</span> <span class="n">xsc</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">xsc_i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">mult</span><span class="p">[</span> <span class="n">index</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">xsc_i</span> <span class="p">]</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="p">[</span><span class="n">mult</span><span class="p">],</span> <span class="n">warningList</span><span class="p">,</span>
                        <span class="n">yUnit</span> <span class="o">=</span> <span class="n">yields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Multiple MF=13 regions for MT=</span><span class="si">%s</span><span class="s"> not yet supported&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;originationLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">ESk</span><span class="p">,</span> <span class="s">&quot; eV&quot;</span> <span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">MF</span><span class="o">==</span><span class="mi">13</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;ENDFconversionFlag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;MF13&#39;</span>
        <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="mi">12</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="mi">13</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;MF = 12 and 13 present for MT=</span><span class="si">%s</span><span class="s">, this is not suppored&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="n">MF</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">13</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">MF</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="mi">14</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">15</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;MF 14 and/or 15 data and no MF 12 or 13 data: MT=</span><span class="si">%s</span><span class="s"> MFs=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">return</span>

    <span class="n">MF12_13Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="n">MF</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LO</span><span class="p">,</span> <span class="n">LG</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF12_13Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; : MF=</span><span class="si">%s</span><span class="s"> LO=</span><span class="si">%s</span><span class="s"> : ZAP=0 &#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">LO</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">branchingGammas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LO</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">13</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LO</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">axes_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">pointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">multiplicityName</span> <span class="o">=</span> <span class="s">&#39;yield&#39;</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF12_13Data</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span> <span class="c"># Total is not stored.</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF12_13Data</span><span class="p">,</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;L1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">EGk</span> <span class="o">==</span> <span class="mf">0.</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;LP = </span><span class="si">%s</span><span class="s"> != 0 for continuous gamma for MT = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LP</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;continuous gamma information for MF=</span><span class="si">%s</span><span class="s">, MT = </span><span class="si">%s</span><span class="s"> already exist&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LP</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LO</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">LO2</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF12_13Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">LP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">LO2</span><span class="p">[</span><span class="s">&#39;L1&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">LP</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">91</span><span class="p">,</span><span class="mi">649</span><span class="p">,</span><span class="mi">699</span><span class="p">,</span><span class="mi">749</span><span class="p">,</span><span class="mi">799</span><span class="p">,</span><span class="mi">849</span><span class="p">):</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;       WARNING: Incorrect &#39;primary gamma&#39; flag for MF12 MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span><span class="p">)</span>
        <span class="n">NT</span><span class="p">,</span> <span class="n">LGp</span> <span class="o">=</span> <span class="n">LO2</span><span class="p">[</span><span class="s">&#39;N2&#39;</span><span class="p">],</span> <span class="n">LG</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">NK</span> <span class="o">=</span> <span class="n">NT</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NT</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">parentEnergy</span><span class="p">,</span> <span class="n">finalEnergy</span> <span class="o">=</span> <span class="n">LO2</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="n">LO2</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">LGp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parentEnergy</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Gamma decay from ground state in MF12 MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">parentEnergy</span><span class="o">-</span><span class="n">finalEnergy</span><span class="p">)</span><span class="o">/</span><span class="n">parentEnergy</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Zero-energy gamma from </span><span class="si">%f</span><span class="s"> eV to </span><span class="si">%f</span><span class="s"> eV in MF12 MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parentEnergy</span><span class="p">,</span><span class="n">finalEnergy</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
            <span class="n">branchingGammas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s">&#39;ES&#39;</span> <span class="p">:</span> <span class="n">LO2</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="s">&#39;EGk&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;ESk&#39;</span> <span class="p">:</span> <span class="n">LO2</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">LGp</span><span class="p">],</span> <span class="s">&#39;angular&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;branching&#39;</span> <span class="p">:</span> <span class="n">LO2</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">LGp</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">LGp</span><span class="o">+</span><span class="n">LGp</span><span class="p">]}</span> <span class="p">)</span>
        <span class="n">gammaBRList</span> <span class="o">=</span> <span class="p">[</span> <span class="n">g</span><span class="p">[</span><span class="s">&#39;branching&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">branchingGammas</span> <span class="p">]</span>
        <span class="n">sumGammaBRList</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">gammaBRList</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">sumGammaBRList</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">gammaBRTolerance</span><span class="p">:</span> 
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;       WARNING: sum of gamma BR&#39;s for MT=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; MF=12 is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sumGammaBRList</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; != 1.0&#39;</span> <span class="p">)</span>
            <span class="c"># leave re-normalization for checker/fixer codes</span>
            <span class="c">#for i in xrange( len( branchingGammas ) ): branchingGammas[ i ][ &#39;branching&#39; ][ 0 ] /= sumGammaBRList</span>
        <span class="n">info</span><span class="o">.</span><span class="n">MF12_LO2</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="n">branchingGammas</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;LO=</span><span class="si">%s</span><span class="s"> is not valid for MF=</span><span class="si">%s</span><span class="s">, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LO</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">readMF14</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">branchingGammas</span> <span class="p">)</span>
    <span class="n">readMF15</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">branchingGammas</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;NON-isotropic gamma&#39;</span> <span class="p">)</span>
            <span class="k">break</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">14</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;: MF=14 &#39;</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">15</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;: MF=15 &#39;</span> <span class="p">)</span>

    <span class="n">products</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">continuousGamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">uncorrelated</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="p">{},</span> <span class="n">component</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">discreteGammas</span> <span class="p">:</span>
        <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;discrete&#39;</span> <span class="p">:</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;EGk&#39;</span><span class="p">],</span> <span class="s">&quot; eV&quot;</span> <span class="p">)</span> <span class="p">}</span>
        <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">],</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">primaryGammas</span> <span class="p">:</span>
        <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;primary&#39;</span> <span class="p">:</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;EGk&#39;</span><span class="p">],</span> <span class="s">&quot; eV&quot;</span> <span class="p">)</span> <span class="p">}</span>
        <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">],</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">branchingGammas</span> <span class="p">:</span> <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF14"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF14">[docs]</a><span class="k">def</span> <span class="nf">readMF14</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">branchingGammas</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">allGammas</span> <span class="o">=</span> <span class="n">discreteGammas</span> <span class="o">+</span> <span class="n">primaryGammas</span> <span class="o">+</span> <span class="n">continuousGamma</span> <span class="o">+</span> <span class="n">branchingGammas</span>

    <span class="k">def</span> <span class="nf">addAngularData</span><span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">form</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">possibleGammas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">allGammas</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">EGk</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;EGk&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ESk</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">possibleGammas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">possibleGammas</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;MF = 14 gamma data: EGk = </span><span class="si">%s</span><span class="s">, ESk = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;MF = </span><span class="si">%s</span><span class="s"> gamma list is,</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MF</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">allGammas</span> <span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;    EGk = </span><span class="si">%s</span><span class="s">, ESk = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;EGk&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;No matching gamma from MF = </span><span class="si">%s</span><span class="s"> found for MF = 14 gamma: MT=</span><span class="si">%s</span><span class="s">: see above&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">possibleGammas</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Multiple possible gammas found for MF=14 data: EGk=</span><span class="si">%s</span><span class="s">, ESk=</span><span class="si">%s</span><span class="s">, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">possibleGammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">gamma</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Gamma already has MF=14 angular data: EGk=</span><span class="si">%s</span><span class="s">, ESk=</span><span class="si">%s</span><span class="s">, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="mi">14</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span>
    <span class="n">MF14Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LTT</span><span class="p">,</span> <span class="n">NK14</span><span class="p">,</span> <span class="n">NI</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF14Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">NK14</span> <span class="o">!=</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="p">(</span> <span class="n">NK14</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">info</span><span class="o">.</span><span class="n">ignoreBadNK14</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: MF14 NK = </span><span class="si">%s</span><span class="s"> != MF12/13 NK = </span><span class="si">%s</span><span class="s"> for MT = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">NK14</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">NI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                                     <span class="c"># All distributions are isotropic</span>
        <span class="k">pass</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span> <span class="n">NK14</span> <span class="o">-</span> <span class="n">NI</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF14Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Currently only one interpolation flag is supported: NR=</span><span class="si">%s</span><span class="s">, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;NR&#39;</span><span class="p">],</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;C1&#39;</span><span class="p">],</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">]</span>

            <span class="n">dgInterpolationE_in</span><span class="p">,</span> <span class="n">dgInterpolationCl</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">axes_</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">frame</span><span class="p">,</span> <span class="n">dgInterpolationE_in</span><span class="p">,</span> <span class="n">dgInterpolationCl</span> <span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s">&#39;Lists&#39;</span><span class="p">]</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">LegendrePointwise</span><span class="p">(</span> <span class="n">axes_</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ELegenre</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">lists</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LegendreSeries</span><span class="o">.</span><span class="n">XYs_LegendreSeries</span><span class="p">(</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">(</span> <span class="p">),</span> <span class="p">[</span> <span class="mf">1.0</span> <span class="p">]</span> <span class="o">+</span> <span class="n">ELegenre</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ELegenre</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">addAngularData</span><span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">form</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;MF=14, LI=</span><span class="si">%s</span><span class="s"> not implemented&#39;</span> <span class="o">%</span> <span class="n">LI</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="readMF15"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF15">[docs]</a><span class="k">def</span> <span class="nf">readMF15</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="mi">15</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Continous gamma with no MF=15 data: MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;MF=15 data and no continous gamma MF=</span><span class="si">%s</span><span class="s"> data: MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">13</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">MF15Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NC</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF15Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">countZAMasses</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">NC</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;NC = </span><span class="si">%s</span><span class="s"> &gt; 1 is not supported: MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">NC</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MF15Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>    <span class="c"># Why are we not checking weights here???????</span>
    <span class="n">LF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">weights</span><span class="p">[</span><span class="s">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LF</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;For MF=15 data, only LF=1 is supported, not LF=</span><span class="si">%s</span><span class="s"> : MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;energy_out&#39;</span><span class="p">,</span>              <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">linearToken</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span> <span class="s">&#39;P(energy_out|energy_in)&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;1/eV&#39;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF15Data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">pointwiseData</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">EEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">interpolationE_out</span><span class="p">,</span> <span class="n">interpolationP</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2d</span><span class="p">(</span> <span class="n">interpolation</span> <span class="p">)</span>
    <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">ENDFInterpolationToGNDAxes3plusd</span><span class="p">(</span> <span class="n">EEpETable</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">projectile</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Ni59&#39;</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">102</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">specialNi59</span> <span class="o">=</span> <span class="p">(</span> <span class="n">EEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">tab1</span> <span class="ow">in</span> <span class="n">EEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">specialNi59</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">specialNi59</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">specialNi59</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: Changing linear interpolation to flat for special Ni59 gamma energy data&#39;</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">tab1</span> <span class="ow">in</span> <span class="n">EEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">tab1</span> <span class="ow">in</span> <span class="n">EEpETable</span><span class="p">[</span><span class="s">&#39;TAB1s&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Need to implement piecewise energy here. Interpolations differ, </span><span class="si">%s</span><span class="s"> vs </span><span class="si">%s</span><span class="s">, MF=15, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">],</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">interpolation</span> <span class="o">!=</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Need to implement piecewise energy here. Interpolations differ, </span><span class="si">%s</span><span class="s"> vs </span><span class="si">%s</span><span class="s">, MF=15, MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;interpolationInfo&#39;</span><span class="p">],</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">pointwiseData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;C2&#39;</span><span class="p">],</span> <span class="n">tab1</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">toPointwiseEnergy</span><span class="p">(</span> <span class="n">pointwiseData</span><span class="p">,</span> <span class="n">interpolationE_in</span><span class="p">,</span> <span class="n">interpolationF</span><span class="p">,</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationE_out</span><span class="p">,</span> <span class="n">interpolationP</span><span class="p">,</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
    <span class="n">component</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
    <span class="n">continuousGamma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component</span>

<span class="c"># for covariances we need a unique id for each section, and also need link info.</span>
<span class="c"># this is messy: lots of special cases</span></div>
<div class="viewcode-block" id="genID"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.genID">[docs]</a><span class="k">def</span> <span class="nf">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">MF2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">MAT2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">QI</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">QI2</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
    <span class="n">MTdict</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTdict&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">getReaction</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">QI</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="c"># find the &lt;reaction&gt; corresponding to this covariance info, if any</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">452</span><span class="p">,</span><span class="mi">455</span><span class="p">,</span><span class="mi">456</span><span class="p">):</span>
            <span class="n">MTold</span> <span class="o">=</span> <span class="n">MT</span>
            <span class="n">MT</span> <span class="o">=</span> <span class="mi">18</span> <span class="c"># nubar actually refers to fission</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">MTdict</span><span class="p">:</span>
            <span class="n">chThisMT</span> <span class="o">=</span> <span class="n">MTdict</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chThisMT</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chThisMT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">40</span><span class="p">:</span>   <span class="c"># MF40 section may contain covariances for multiple excited states of residual</span>
                <span class="n">thisChannel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chThisMT</span> <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">getQ</span><span class="p">(</span><span class="s">&#39;eV&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">QI</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">production</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thisChannel</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">thisChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">:</span>
                    <span class="c"># Q-values disagree between MF10/MF40. Assume 1st covariance is for lowest-energy residual, etc</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>
                    <span class="n">cov_info</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cov_info</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">thisChannel</span><span class="p">[</span> <span class="n">index</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">33</span><span class="p">:</span>
                <span class="c"># residual must be in ground state unless MT in 51-90, etc</span>
                <span class="n">thisChannel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chThisMT</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">reaction</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">getLevelAsFloat</span><span class="p">(</span><span class="s">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ch</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">]</span> <span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">summedReaction</span><span class="o">.</span><span class="n">summedReaction</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thisChannel</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;MF33 MT</span><span class="si">%i</span><span class="s"> covariance doesn&#39;t correspond to any channel!&quot;</span>
                        <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">thisChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Can&#39;t determine which reaction this covariance (MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">) corresponds to!&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">rowReaction</span> <span class="o">=</span> <span class="n">getReaction</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">QI</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">makeID</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="n">reaction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c">#Id = str( reaction.outputChannel )</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">reaction</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">452</span><span class="p">,</span><span class="mi">455</span><span class="p">,</span><span class="mi">456</span><span class="p">):</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">452</span><span class="p">:</span><span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="mi">455</span><span class="p">:</span><span class="s">&#39;delayed&#39;</span><span class="p">,</span> <span class="mi">456</span><span class="p">:</span><span class="s">&#39;prompt&#39;</span><span class="p">}[</span><span class="n">MT</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">107</span><span class="p">):</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="s">&#39;sum(z,n)&#39;</span><span class="p">,</span> <span class="mi">103</span><span class="p">:</span><span class="s">&#39;sum(z,p)&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">:</span><span class="s">&#39;sum(z,d)&#39;</span><span class="p">,</span>
                    <span class="mi">105</span><span class="p">:</span><span class="s">&#39;sum(z,t)&#39;</span><span class="p">,</span> <span class="mi">106</span><span class="p">:</span><span class="s">&#39;sum(z,He3)&#39;</span><span class="p">,</span> <span class="mi">107</span><span class="p">:</span><span class="s">&#39;sum(z,a)&#39;</span><span class="p">}[</span><span class="n">MT</span><span class="p">]</span>
        <span class="k">elif</span> <span class="mi">850</span> <span class="o">&lt;</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">871</span><span class="p">:</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;lump</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MT</span><span class="o">-</span><span class="mi">851</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;MF</span><span class="si">%i</span><span class="s">_MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Id</span>

    <span class="n">rowId</span> <span class="o">=</span> <span class="n">makeID</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">rowReaction</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">MAT2</span><span class="p">:</span>
        <span class="c"># cross-material covariance</span>
        <span class="n">colReaction</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># must create an &#39;externalReaction&#39; and link to it below</span>
        <span class="n">versus</span> <span class="o">=</span> <span class="s">&#39; vs. &#39;</span>
        <span class="n">colId</span> <span class="o">=</span> <span class="s">&quot;MAT</span><span class="si">%i</span><span class="s">_MF</span><span class="si">%i</span><span class="s">_MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MAT2</span><span class="p">,</span><span class="n">MF2</span><span class="p">,</span><span class="n">MT2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">MT2</span> <span class="ow">and</span> <span class="n">MT2</span><span class="o">!=</span><span class="n">MT</span><span class="p">):</span>
        <span class="n">MF2</span> <span class="o">=</span> <span class="n">MF2</span> <span class="ow">or</span> <span class="n">MF</span>
        <span class="n">colReaction</span> <span class="o">=</span> <span class="n">getReaction</span><span class="p">(</span> <span class="n">MT2</span><span class="p">,</span> <span class="n">MF2</span><span class="p">,</span> <span class="n">QI2</span> <span class="p">)</span>
        <span class="n">versus</span> <span class="o">=</span> <span class="s">&#39; vs. &#39;</span>
        <span class="n">colId</span> <span class="o">=</span> <span class="n">makeID</span><span class="p">(</span> <span class="n">MT2</span><span class="p">,</span> <span class="n">colReaction</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colId</span> <span class="o">=</span> <span class="n">versus</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">qualifier</span> <span class="o">=</span> <span class="p">{</span><span class="mi">31</span><span class="p">:</span><span class="s">&#39; [nubar]&#39;</span><span class="p">,</span> <span class="mi">33</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">34</span><span class="p">:</span><span class="s">&#39; [angular distribution]&#39;</span><span class="p">,</span> <span class="mi">35</span><span class="p">:</span><span class="s">&#39; [spectrum]&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}[</span><span class="n">MF</span><span class="p">]</span>
    <span class="n">ID</span> <span class="o">=</span> <span class="n">rowId</span> <span class="o">+</span> <span class="n">versus</span> <span class="o">+</span> <span class="n">colId</span> <span class="o">+</span> <span class="n">qualifier</span>

    <span class="sd">&quot;&quot;&quot; also, create links from covariances to data. If we&#39;re trying to point to nonexistant data</span>
<span class="sd">    (ie for lumped channels), make a &#39;fake channel&#39; &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>   <span class="c"># should hold file for covariances</span>
    <span class="k">def</span> <span class="nf">makeLink</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">MAT2</span> <span class="p">):</span>
        <span class="n">link_</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">ENDF_MFMT</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%i</span><span class="s">,</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">33</span><span class="p">,</span><span class="mi">40</span><span class="p">):</span> <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">crossSection</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">31</span><span class="p">:</span> <span class="n">link_</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">toXLink</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;/multiplicity&#39;</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">34</span><span class="p">:</span> <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distributions</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">35</span><span class="p">:</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;energy&#39;</span> <span class="ow">in</span> <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">&#39;uncorrelated&#39;</span> <span class="ow">in</span> <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="p">[</span><span class="s">&#39;uncorrelated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">energyComponent</span>
        <span class="k">elif</span> <span class="n">MAT2</span><span class="p">:</span>
            <span class="c"># cross-material covariance: get other isotope from the MAT number</span>
            <span class="n">otherTarget</span> <span class="o">=</span> <span class="n">endf_endl</span><span class="o">.</span><span class="n">getParticleNameFromMAT</span><span class="p">(</span> <span class="n">MAT2</span> <span class="p">)</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">externalReaction</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">otherTarget</span><span class="p">,</span> <span class="n">ENDF_MFMT</span><span class="o">=</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
            <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;externalReactions&#39;</span><span class="p">][(</span><span class="n">MAT2</span><span class="p">,</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="n">quant</span>
            <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">850</span> <span class="o">&lt;</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">871</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">92</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">41</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">103</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span><span class="mi">650</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">104</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">651</span><span class="p">,</span><span class="mi">700</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">105</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">701</span><span class="p">,</span><span class="mi">750</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">106</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">751</span><span class="p">,</span><span class="mi">800</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">107</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">801</span><span class="p">,</span><span class="mi">850</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1000</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">998</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;lumpedChannels&#39;</span><span class="p">]:</span>
                <span class="n">quant</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">reactionSum</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">ENDF_MFMT</span><span class="o">=</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
                <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;lumpedChannels&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="n">quant</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;lumpedChannels&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span>

            <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">quant</span>

        <span class="k">return</span> <span class="n">link_</span>

    <span class="n">rowData</span> <span class="o">=</span> <span class="n">makeLink</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">rowReaction</span><span class="p">,</span> <span class="n">rowId</span><span class="p">,</span> <span class="n">MAT2</span> <span class="p">)</span>
    <span class="n">rowData</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&#39;rowData&#39;</span>
    <span class="n">colData</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MT2</span> <span class="ow">and</span> <span class="n">MT2</span><span class="o">!=</span><span class="n">MT</span><span class="p">)</span> <span class="ow">or</span> <span class="n">MAT2</span><span class="p">:</span>
        <span class="n">colData</span> <span class="o">=</span> <span class="n">makeLink</span><span class="p">(</span> <span class="n">MT2</span><span class="p">,</span> <span class="n">colReaction</span><span class="p">,</span> <span class="n">colId</span><span class="p">,</span> <span class="n">MAT2</span> <span class="p">)</span>
        <span class="n">colData</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&#39;columnData&#39;</span>
    <span class="k">return</span> <span class="n">ID</span><span class="p">,</span> <span class="p">[</span><span class="n">rowData</span><span class="p">,</span> <span class="n">colData</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="readMatrix"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMatrix">[docs]</a><span class="k">def</span> <span class="nf">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span> <span class="n">NT</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span> <span class="n">dat</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; matrix format is very similar for MF31, MF33 and MF35, so we can</span>
<span class="sd">    generalize parsing the matrix &quot;&quot;&quot;</span>
    
    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NT</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
    <span class="n">subsec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="c"># LB flag tells how to interpret this data:</span>
    <span class="k">if</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span> <span class="c"># diagonal</span>
        <span class="n">subsec</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[:</span><span class="n">NT</span><span class="p">]</span>
        <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c"># writing full matrix for now</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">LB</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">LS</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c">#symmetric upper-diagonal</span>
            <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NP</span><span class="p">],]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NP</span><span class="p">:</span><span class="n">NT</span><span class="p">]</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NP</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">])</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">;</span> <span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>   <span class="c"># copy to lower-diagonal portion</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># asymmetric, but same energy grids for both axes:</span>
            <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NP</span><span class="p">]]</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NP</span><span class="p">:]</span>
            <span class="n">NP</span> <span class="o">=</span> <span class="n">NP</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="n">NP</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">NP</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">NP</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NP</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">LB</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span> <span class="c"># asymmetric</span>
        <span class="n">NER</span> <span class="o">=</span> <span class="n">NP</span>
        <span class="n">NEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">NER</span>
        <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NER</span><span class="p">],</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NER</span><span class="p">:</span><span class="n">NER</span><span class="o">+</span><span class="n">NEC</span><span class="p">]]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NER</span><span class="o">+</span><span class="n">NEC</span><span class="p">:</span><span class="n">NT</span><span class="p">]</span>
        <span class="n">NEC</span><span class="o">-=</span><span class="mi">1</span><span class="p">;</span> <span class="n">NER</span><span class="o">-=</span><span class="mi">1</span>  <span class="c"># matrix dimensions</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="n">NEC</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">NEC</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">NEC</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NER</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

    <span class="n">axes_</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceAxis</span><span class="p">(</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;row_energy_bounds&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;eV&quot;</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span><span class="s">&#39;linear&#39;</span><span class="p">,</span><span class="s">&#39;flat&#39;</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">energyBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceAxis</span><span class="p">(</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;column_energy_bounds&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;eV&quot;</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">interpolationXY</span><span class="p">(</span><span class="s">&#39;linear&#39;</span><span class="p">,</span><span class="s">&#39;flat&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">energyBounds</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">energyBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mirrorOtherAxis</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">axes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceAxis</span><span class="p">(</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;matrix_elements&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">axes_</span>
</div>
<div class="viewcode-block" id="readMF31_33"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF31_33">[docs]</a><span class="k">def</span> <span class="nf">readMF31_33</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; nubar and cross section covariances have basically the same form</span>
<span class="sd">    in ENDF, so we can treat them the same way: &quot;&quot;&quot;</span>
    
    <span class="n">endfPrecision</span> <span class="o">=</span> <span class="mi">6</span>
    
    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="c"># dat contains one MFMT section, but in gnd each cross-correlation gets its own section:</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    
    <span class="n">ZA</span><span class="p">,</span><span class="n">AWR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MTL</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NL</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MTL</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="c"># MTL!=0 implies section is a placeholder pointing to a lumped channel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">MTL</span><span class="p">,</span><span class="n">mf</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL&#39;</span><span class="p">]:</span>
            <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL&#39;</span><span class="p">][(</span><span class="n">MTL</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL&#39;</span><span class="p">][(</span><span class="n">MTL</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NL</span><span class="p">):</span>
        <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span><span class="p">,</span><span class="n">MAT1</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">NI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MAT1</span> <span class="o">==</span> <span class="n">info</span><span class="o">.</span><span class="n">MAT</span><span class="p">:</span>
            <span class="c"># Some files explicitly give MAT1==MAT for internal covariance.</span>
            <span class="c"># for simplicity, just set MAT1=0 unless it is actually a different material</span>
            <span class="n">MAT1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">XMF1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">XLFS1</span><span class="p">)</span>

        <span class="n">covarsThisSection</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">XMF1</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">XLFS1</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="c">#info.logs.write( &quot;non-zero XMF1/XLFS1!!!&quot; ) # may not be properly dealt with</span>
            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;non-zero XMF1/XLFS1 in covariances not currently handled!&quot;</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">NCdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NC</span><span class="p">):</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LTY</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">LTY</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NCI2</span><span class="p">,</span><span class="n">NCI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="n">subsec</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NCI2</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="c">#coefs = subsec[:NCI2][::2]</span>
                <span class="n">pointerList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">coef</span><span class="p">,</span><span class="n">mtnum</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">Id</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtnum</span><span class="p">),</span> <span class="n">mf</span> <span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">pointers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;coefficient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;summand&quot;</span>
                    <span class="n">pointerList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">link</span> <span class="p">)</span>
                <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">summedCovariance</span><span class="p">(</span>
                        <span class="n">lowerBound</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">E1</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span>
                        <span class="n">upperBound</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">E2</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span>
                        <span class="n">pointerList</span><span class="o">=</span><span class="n">pointerList</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;NC_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">covarsThisSection</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING, non-zero LTY in MF33&#39;</span> <span class="p">)</span>    

        <span class="k">for</span> <span class="n">NIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">,</span> <span class="n">axes_</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">LB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: skipping LB</span><span class="si">%i</span><span class="s"> section for MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LB</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">Type</span><span class="o">=</span><span class="s">&#39;relative&#39;</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">endfPrecision</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">LS</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;symmetric&#39;</span>
            <span class="k">elif</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;diagonal&#39;</span>
                <span class="k">if</span> <span class="n">LB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s">&#39;absolute&#39;</span>
                    <span class="n">axes_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">=</span><span class="s">&#39;b**2&#39;</span>
            <span class="k">elif</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;asymmetric&#39;</span>
            
            <span class="n">ENDFconversionFlag</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,):</span> <span class="n">ENDFconversionFlag</span> <span class="o">=</span> <span class="s">&quot;LB=</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">LB</span>

            <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes_</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
                <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">ENDFconversionFlag</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="c"># create unique id for each section:</span>
        <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">MT2</span><span class="o">=</span><span class="n">MT1</span><span class="p">,</span> <span class="n">MF2</span><span class="o">=</span><span class="p">(</span><span class="n">XMF1</span> <span class="ow">or</span> <span class="n">mf</span><span class="p">),</span> <span class="n">MAT2</span><span class="o">=</span><span class="n">MAT1</span> <span class="p">)</span>
        <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="nb">id</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">mixedForm</span><span class="p">(</span> <span class="n">covarsThisSection</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">)):</span> <span class="n">form</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">covarsThisSection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#raise Exception(&quot;Encountered empty covariance section!!!&quot;)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Missing covariance data from section!&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">section</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span>
        <span class="n">section</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

        <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
        <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">XMF1</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
        <span class="c"># end loop over NL subsections</span>

    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Not all covariance data converted, MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span>
</div>
<div class="viewcode-block" id="readMF32"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF32">[docs]</a><span class="k">def</span> <span class="nf">readMF32</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="c"># MF=32 resonance parameter covariances. Must be synchronized with MF=2 resonance parameters</span>

    <span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;      WARNING! Skipping MF32 since NumPy is unavailable&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],[]</span>
    <span class="n">endfPrecision</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">resonances</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;resonances&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">swaprows</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">nrows</span> <span class="p">):</span>
        <span class="c"># matrix rows may be out-of-order and need resorting</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matrix</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">];</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:,</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matrix</span><span class="p">[:,</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:,</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">];</span> <span class="n">matrix</span><span class="p">[:,</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">ZA</span><span class="p">,</span><span class="n">AWR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NIS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NIS</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Can&#39;t handle multi-isotope file 32!&quot;</span> <span class="p">)</span>
    <span class="n">ZAI</span><span class="p">,</span><span class="n">ABN</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LFW</span><span class="p">,</span><span class="n">NER</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>

    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NER</span><span class="p">):</span>
        <span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">,</span><span class="n">LRU</span><span class="p">,</span><span class="n">LRF</span><span class="p">,</span><span class="n">NRO</span><span class="p">,</span><span class="n">NAPS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NRO</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Can&#39;t handle non-zero NRO in MF32!&quot;</span> <span class="p">)</span>
        <span class="c"># format is determined mainly by combination of LCOMP and LRU/LRF</span>
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>  <span class="c"># resolved resonance covariance section</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;      WARNING: skipping LRF=7 resonance covariances!&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>  <span class="c"># Breit-Wigner and simplified Reich-Moore formats are similar</span>
                <span class="n">mf2_elist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">nativeData</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s">&#39;energy&#39;</span><span class="p">),</span>
                        <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">nativeData</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s">&#39;neutronWidth&#39;</span><span class="p">),</span>
                        <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">nativeData</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s">&#39;captureWidth&#39;</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LCOMP</span><span class="p">,</span><span class="n">NLS</span><span class="p">,</span><span class="n">ISR</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="n">DAP</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ISR</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c"># scattering radius uncertainty</span>
                    <span class="n">MLS</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MLS</span><span class="p">,</span><span class="n">one</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">MLS</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span> <span class="p">)</span> <span class="p">):</span>
                        <span class="n">DAP</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">DAP</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">*</span><span class="n">dap</span> <span class="k">for</span> <span class="n">dap</span> <span class="ow">in</span> <span class="n">DAP</span><span class="p">[:</span><span class="n">MLS</span><span class="p">]]</span> <span class="c"># convert from 10*fm to fm</span>
                <span class="k">if</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c"># internal correlations given for each resonance, no cross-resonance terms</span>
                    <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;LCOMP=0&#39;</span>
                    <span class="n">AWRI</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">mf32_resonances</span><span class="p">,</span> <span class="n">mf32_covars</span> <span class="o">=</span> <span class="p">[],[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                        <span class="n">mf32_resonances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">mf32_covars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="o">+</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="p">)</span>

                    <span class="n">dEsq</span><span class="p">,</span> <span class="n">dNsq</span><span class="p">,</span> <span class="n">dNdG</span><span class="p">,</span> <span class="n">dGsq</span><span class="p">,</span> <span class="n">dNdF</span><span class="p">,</span> <span class="n">dGdF</span><span class="p">,</span> <span class="n">dFsq</span><span class="p">,</span> <span class="n">dJdN</span><span class="p">,</span> <span class="n">dJdG</span><span class="p">,</span> <span class="n">dJdF</span><span class="p">,</span> <span class="n">dJsq</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">mf32_covars</span><span class="p">)</span>
                    <span class="n">MPAR</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dFsq</span><span class="p">):</span> <span class="n">MPAR</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dJsq</span><span class="p">):</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Encountered uncertainty on J in MF32!&quot;</span><span class="p">)</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MPAR</span><span class="o">*</span><span class="n">NRS</span><span class="p">,</span><span class="n">MPAR</span><span class="o">*</span><span class="n">NRS</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="p">]</span> <span class="o">=</span> <span class="n">dEsq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNsq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dNdG</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dGsq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
                            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dNdF</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dGdF</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dFsq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="c"># symmetrize:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">MPAR</span><span class="o">*</span><span class="n">NRS</span> <span class="p">):</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span><span class="n">i</span><span class="p">]</span>

                    <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">]</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s">&quot;absolute&quot;</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s">&quot;sparse_symmetric&quot;</span> <span class="p">)</span>

                <span class="k">if</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NSRS</span><span class="p">,</span><span class="n">NLRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MPAR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NRB</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">NRB</span> <span class="o">*</span> <span class="n">MPAR</span>  <span class="c"># num. of resonances * num. parameters per resonance</span>
                    <span class="n">matrixSize</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">*</span> <span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">matrixSize</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="n">NRB</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Incorrect dimension for the matrix!&quot;</span><span class="p">)</span>

                    <span class="c"># resonanances are listed again (redundant!):</span>
                    <span class="n">mf32_resonances</span> <span class="o">=</span> <span class="p">[</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRB</span><span class="p">)</span> <span class="p">]</span>
                    <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">]</span>
                    <span class="c"># then the matrix:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">nLines</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span> <span class="n">matrixSize</span><span class="p">,</span> <span class="mi">6</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLines</span><span class="p">):</span> <span class="n">data</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rem</span><span class="p">:</span> <span class="n">data</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)[:</span><span class="n">rem</span><span class="p">]</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                        <span class="c"># data stores upper-diagonal matrix. Symmetrize:</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">]</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">;</span> <span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s">&quot;absolute&quot;</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s">&quot;symmetric&quot;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">endfPrecision</span> <span class="p">)</span>

                <span class="k">elif</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;LCOMP=2&#39;</span>
                    <span class="n">AWRI</span><span class="p">,</span> <span class="n">QX</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">LRX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRSA</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="c"># resonance parameters + uncertainties:</span>
                    <span class="n">mf32_resonances</span> <span class="o">=</span> <span class="p">[</span><span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRSA</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="c"># for LCOMP==2, off-diagonal terms are given as correlation matrix:</span>
                    <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NDIGIT</span><span class="p">,</span><span class="n">NNN</span><span class="p">,</span><span class="n">NM</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">MPAR</span> <span class="o">=</span> <span class="n">NNN</span><span class="o">/</span><span class="n">NRSA</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">NNN</span><span class="p">)</span>
                    <span class="n">diagonal</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRSA</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">dE</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">,</span><span class="n">dGammaF</span> <span class="o">=</span> <span class="n">mf32_resonances</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dE</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">]</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dGammaF</span> <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                            <span class="n">dE</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">,</span><span class="n">dGammaF1</span><span class="p">,</span><span class="n">dGammaF2</span> <span class="o">=</span> <span class="n">mf32_resonances</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dE</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">]</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dGammaF1</span><span class="p">,</span><span class="n">dGammaF2</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span><span class="o">!=</span><span class="n">NNN</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Incorrect dimensions for LCOMP=2 matrix!&quot;</span> <span class="p">)</span>

                    <span class="c"># off-diagonal parts of matrix are stored as sparse correlation matrix:</span>
                    <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;,NDIGIT=</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">NDIGIT</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">NNN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">NDIGIT</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NM</span><span class="p">):</span>
                        <span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">vals</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">readEndfINTG</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">NDIGIT</span> <span class="p">)</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:</span><span class="n">row</span><span class="o">-</span><span class="n">col</span><span class="p">]</span>
                        <span class="c"># go to 0-based index:</span>
                        <span class="n">row</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="n">col</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">row</span><span class="o">&gt;=</span><span class="n">NNN</span> <span class="ow">or</span> <span class="n">col</span><span class="o">&gt;=</span><span class="n">row</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Matrix indices out of range for MF32 LCOMP=2 matrix&quot;</span><span class="p">)</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">:</span><span class="n">col</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vals</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NNN</span><span class="p">):</span>    <span class="c"># symmetrize</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">matrix</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">NDIGIT</span><span class="p">)</span>

                    <span class="c"># convert correlation -&gt; relative covariance matrix</span>
                    <span class="n">rsd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">diagonal</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">rsd</span><span class="p">,</span><span class="n">rsd</span><span class="p">)</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s">&quot;absolute&quot;</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s">&quot;sparse_symmetric&quot;</span> <span class="p">)</span>

                <span class="c"># mf32 may cover only the low-energy portion of the resonance region:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf32_elist</span><span class="p">):</span>
                    <span class="n">mf2_elist</span> <span class="o">=</span> <span class="n">mf2_elist</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">mf32_elist</span><span class="p">)]</span>

                <span class="c"># check whether resonances are sorted by L rather than by energy. If so, rearrange:</span>
                <span class="k">if</span> <span class="n">mf32_elist</span> <span class="o">!=</span> <span class="n">mf2_elist</span> <span class="ow">or</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;sortByL&#39;</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;endfConversionFlags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;,sortByL&#39;</span>
                <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mf32_elist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="n">mf2_elist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;MF32 resonance parameters don&#39;t match MF2 parameters!&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">)):</span>
                    <span class="n">i2</span> <span class="o">=</span> <span class="n">mf32_elist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">mf2_elist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">i2</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">swaprows</span><span class="p">(</span> <span class="n">GNDmatrix</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">MPAR</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">MPAR</span><span class="o">*</span><span class="n">mf32_elist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">mf2_elist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">),</span> <span class="n">MPAR</span> <span class="p">)</span>
                        <span class="c"># also need to swap values in elist2:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">mf32_elist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">mf32_elist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf32_elist</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span> <span class="n">mf32_elist</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                <span class="k">if</span> <span class="n">DAP</span><span class="p">:</span> <span class="c"># scattering radius uncertainty was specified. Expand matrix to include it:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BadCovariances</span><span class="p">(</span><span class="s">&quot;Energy-dependent scat. radius uncertainty not yet handled!&quot;</span><span class="p">)</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">)</span>
                    <span class="n">new_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">)):</span> <span class="n">new_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">new_matrix</span><span class="p">[</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">):,</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">):</span> <span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">new_matrix</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">GNDmatrix</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
                            <span class="n">precision</span><span class="o">=</span><span class="n">GNDmatrix</span><span class="o">.</span><span class="n">precision</span> <span class="p">)</span>

                <span class="c"># switch to diagonal matrix if possible (much more compact):</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">matrix</span><span class="o">==</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span> <span class="o">*</span> <span class="n">matrix</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="p">)</span> <span class="p">):</span>
                    <span class="n">GNDmatrix</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="s">&quot;diagonal&quot;</span>

                <span class="c"># store into GND:</span>
                <span class="n">resData</span> <span class="o">=</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">nativeData</span><span class="o">.</span><span class="n">resonanceParameters</span>
                <span class="n">nResonances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">mf32_elist</span> <span class="p">)</span>
                <span class="n">parametersPerResonance</span> <span class="o">=</span> <span class="s">&quot;energy,neutronWidth,captureWidth&quot;</span>
                <span class="k">if</span> <span class="n">MPAR</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">:</span> <span class="n">parametersPerResonance</span> <span class="o">=</span> <span class="n">parametersPerResonance</span> <span class="o">+</span> <span class="s">&#39;,fissionWidthA&#39;</span>
                <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> <span class="n">parametersPerResonance</span> <span class="o">=</span> <span class="n">parametersPerResonance</span> <span class="o">+</span> <span class="s">&#39;,fissionWidthB&#39;</span>
                <span class="n">inputParameters</span> <span class="o">=</span> <span class="p">[</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">loopOverResonanceParameters</span><span class="p">(</span> <span class="n">nResonances</span><span class="p">,</span>
                        <span class="n">parametersPerResonance</span><span class="p">,</span> <span class="n">resData</span> <span class="p">)</span> <span class="p">]</span>
                <span class="k">if</span> <span class="n">DAP</span><span class="p">:</span>
                    <span class="n">inputParameters</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">inputParameter</span><span class="p">(</span><span class="s">&quot;scatteringRadius&quot;</span><span class="p">,</span>
                        <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">nativeData</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">resonanceParameterCovariance</span><span class="p">(</span> <span class="bp">None</span><span class="p">,</span> <span class="n">inputParameters</span><span class="p">,</span>
                    <span class="n">GNDmatrix</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># unresolved resonance parameters</span>
            <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NLS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">lval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NJS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NJS</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Incorrect header in MF32 unresolved section!&quot;</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">jval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                    <span class="n">D</span><span class="p">,</span><span class="n">AJ</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">GF</span><span class="p">,</span><span class="n">GX</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

            <span class="c"># matrix:</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MPAR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NPAR</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="p">(</span><span class="n">NPAR</span><span class="o">*</span><span class="p">(</span><span class="n">NPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Incorrect header in MF32 unresolved section!&quot;</span> <span class="p">)</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tmp</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">data</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NPAR</span><span class="p">,</span><span class="n">NPAR</span><span class="p">))</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NPAR</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPAR</span><span class="p">):</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">]</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">;</span> <span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">matrix</span><span class="o">==</span><span class="mi">0</span> <span class="p">):</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;       WARNING: ignoring empty unresolved covariance matrix!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;       WARNING: non-empty unresolved covariance!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sections</span><span class="p">,</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="readMF34"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF34">[docs]</a><span class="k">def</span> <span class="nf">readMF34</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; angular distribution covariances: &quot;&quot;&quot;</span>
    <span class="n">endfPrecision</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c"># dat contains one MFMT section</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    
    <span class="n">ZA</span><span class="p">,</span><span class="n">AWR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LTT</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NMT</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">LegendreOrderCovarianceForm</span><span class="p">()</span>
    <span class="n">groupIndex</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMT</span><span class="p">):</span>
        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MAT1</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">NL</span><span class="p">,</span><span class="n">NL1</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MT1</span> <span class="o">==</span> <span class="n">mt</span><span class="p">:</span>
            <span class="n">NSS</span> <span class="o">=</span> <span class="n">NL</span><span class="o">*</span><span class="p">(</span><span class="n">NL</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NSS</span><span class="o">=</span><span class="n">NL</span><span class="o">*</span><span class="n">NL1</span>
        <span class="k">if</span> <span class="n">MAT1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Cross material angular distribution covariance is not allowed in ENDF format.  Found MAT1 =&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">MAT1</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">MT1</span> <span class="o">!=</span> <span class="n">mt</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s">&quot;Cross reaction covariances in angular distribution covariance data not supported&quot;</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">iNSS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NSS</span><span class="p">):</span>
            <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">NI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;frameOfMF4&quot;</span><span class="p">,</span><span class="s">&quot;lab&quot;</span><span class="p">,</span><span class="s">&quot;centerOfMass&quot;</span><span class="p">][</span><span class="n">LCT</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="s">&#39;frameOfMF4&#39;</span><span class="p">:</span> 
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;       WARNING: did not look up what frame MF4 data given in, so frame of covariance unknown&quot;</span> <span class="p">)</span>

            <span class="n">Lsection</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">LegendreLValue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">L1</span><span class="p">,</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">covarsThisL</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">NIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NE</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LS</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="ow">and</span> <span class="n">LB</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">):</span>
                    <span class="c">#info.logs.write( &quot;Unexpected LS%i LB%i in MF35&quot; % LB )</span>
                    <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Unexpected LS</span><span class="si">%i</span><span class="s"> LB</span><span class="si">%i</span><span class="s"> in MF34&quot;</span> <span class="o">%</span> <span class="n">LB</span> <span class="p">)</span>
                <span class="c"># pretend it&#39;s MF33 file:</span>
                <span class="n">matrix</span><span class="p">,</span> <span class="n">axes_</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NE</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">endfPrecision</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">LS</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;symmetric&#39;</span>
                <span class="k">elif</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
                    <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;diagonal&#39;</span>
                    <span class="k">if</span> <span class="n">LB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;LB=0 in Legendre covariances&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;asymmetric&#39;</span>
                <span class="n">covarsThisL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;relative&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes_</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisL</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sectionForm</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">mixedForm</span><span class="p">(</span> <span class="n">covarsThisL</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sectionForm</span><span class="p">)):</span> <span class="n">sectionForm</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisL</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sectionForm</span> <span class="o">=</span> <span class="n">covarsThisL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">Lsection</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">=</span> <span class="n">sectionForm</span><span class="o">.</span><span class="n">moniker</span>
            <span class="n">Lsection</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span> <span class="n">Lsection</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">]</span> <span class="o">=</span> <span class="n">sectionForm</span>

            <span class="c"># end loop over subsubsections</span>
            <span class="n">form</span><span class="o">.</span><span class="n">lvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Lsection</span> <span class="p">)</span>
       
        <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Not all covariance data converted, MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
        
        <span class="c"># add unique id to the section:</span>
        <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span> <span class="p">)</span>
        <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="nb">id</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span><span class="p">)</span>
        <span class="n">section</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span>
        <span class="n">section</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
    
        <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
        <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span>

</div>
<div class="viewcode-block" id="readMF35"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF35">[docs]</a><span class="k">def</span> <span class="nf">readMF35</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; spectra covariances are fairly simple: &quot;&quot;&quot;</span>
    <span class="n">endfPrecision</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c"># dat contains one MFMT section</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    
    <span class="n">ZA</span><span class="p">,</span><span class="n">AWR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NK</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">energyIntervalForm</span><span class="p">()</span>
    <span class="n">groupIndex</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NK</span><span class="p">):</span>
        <span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NE</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LS</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LB</span><span class="o">==</span><span class="mi">7</span><span class="p">):</span>
            <span class="c">#info.logs.write( &quot;Unexpected LS%i LB%i in MF35&quot; % LB )</span>
            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;Unexpected LS</span><span class="si">%i</span><span class="s"> LB</span><span class="si">%i</span><span class="s"> in MF35&quot;</span> <span class="o">%</span> <span class="n">LB</span> <span class="p">)</span>
        <span class="c"># pretend it&#39;s MF33 file:</span>
        <span class="n">LS</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">LB</span><span class="o">=</span><span class="mi">5</span>
        <span class="n">E1</span><span class="p">,</span><span class="n">E2</span> <span class="o">=</span> <span class="p">[</span><span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">)]</span>
        
        <span class="n">matrix</span><span class="p">,</span> <span class="n">axes_</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">NT</span><span class="p">,</span> <span class="n">NE</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">endfPrecision</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">LS</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;symmetric&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;asymmetric&#39;</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;relative&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes_</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span> <span class="n">energyBounds</span><span class="o">=</span><span class="p">(</span><span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="n">covar</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">groupIndex</span><span class="p">;</span> <span class="n">groupIndex</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span> <span class="n">covar</span> <span class="p">)</span>
        <span class="c"># end loop over NK subsections</span>
    
    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s">&quot;Not all covariance data converted, MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
    
    <span class="c"># add unique id to the section:</span>
    <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span> <span class="p">)</span>
    <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="nb">id</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span><span class="p">)</span>
    <span class="n">section</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span>
    <span class="n">section</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

    <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
    <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span>
</div>
<div class="viewcode-block" id="readMF40"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.readMF40">[docs]</a><span class="k">def</span> <span class="nf">readMF40</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">cov_info</span><span class="p">,</span><span class="n">warningList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; production of radioactive isotopes. Also very similar to MF33 &quot;&quot;&quot;</span>

    <span class="n">endfPrecision</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],[]</span>
    <span class="n">ZA</span><span class="p">,</span><span class="n">AWR</span><span class="p">,</span><span class="n">LIS</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="c"># each subsection represents different excited state of residual</span>
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NS</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">QM</span><span class="p">,</span><span class="n">QI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LFS</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NL</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;       WARNING: MF40 MT</span><span class="si">%i</span><span class="s"> lists incorrect number of subsections!&#39;</span> <span class="o">%</span> <span class="n">mt</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">subsubsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NL</span><span class="p">):</span>
            <span class="c"># each subsubsection is a single matrix</span>
            <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span><span class="p">,</span><span class="n">MAT1</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">NI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">XMF1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">XLFS1</span><span class="p">)</span> <span class="c"># XLFS1: level index</span>

            <span class="n">covarsThisSection</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">XMF1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s">&quot;non-zero XMF1/XLFS1 in covariances not currently handled!&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">MAT1</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;       WARNING: cross-material covariance with MAT=</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MAT1</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">NCdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NC</span><span class="p">):</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LTY</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LTY</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NCI2</span><span class="p">,</span><span class="n">NCI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">subsec</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NCI2</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="c">#coefs = subsec[:NCI2][::2]</span>
                    <span class="n">pointerList</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">gnd</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">link</span><span class="p">(</span> <span class="s">&#39;summand&#39;</span><span class="p">,</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtnum</span><span class="p">),</span> <span class="n">mf</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;ENDF_MFMT&#39;</span><span class="p">:</span><span class="s">&quot;</span><span class="si">%i</span><span class="s">,</span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mtnum</span><span class="p">),</span> <span class="s">&#39;coefficient&#39;</span><span class="p">:</span><span class="n">coef</span><span class="p">})</span>
                            <span class="k">for</span> <span class="n">coef</span><span class="p">,</span><span class="n">mtnum</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
                            <span class="p">]</span>
                    <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">summedCovariance</span><span class="p">(</span>
                            <span class="n">lowerBound</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">E1</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span>
                            <span class="n">upperBound</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">E2</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span>
                            <span class="n">pointerList</span><span class="o">=</span><span class="n">pointerList</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING, non-zero LTY in MF40&#39;</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">NIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="n">matrix</span><span class="p">,</span> <span class="n">axes_</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">LB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: skipping LB</span><span class="si">%i</span><span class="s"> section for MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LB</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">Type</span><span class="o">=</span><span class="s">&#39;relative&#39;</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">gndMatrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">endfPrecision</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">LS</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;symmetric&#39;</span>
                <span class="k">elif</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;diagonal&#39;</span>
                    <span class="k">if</span> <span class="n">LB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">Type</span><span class="o">=</span><span class="s">&#39;absolute&#39;</span>
                        <span class="n">axes_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">=</span><span class="s">&#39;b**2&#39;</span>
                <span class="k">elif</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span> <span class="n">matrix</span><span class="o">.</span><span class="n">form</span><span class="o">=</span><span class="s">&#39;asymmetric&#39;</span>

                <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes_</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">MAT1</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
               <span class="k">continue</span>

            <span class="c"># create unique id for each section:</span>
            <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">MT2</span><span class="o">=</span><span class="n">MT1</span><span class="p">,</span> <span class="n">MF2</span><span class="o">=</span><span class="p">(</span><span class="n">XMF1</span> <span class="ow">or</span> <span class="n">mf</span><span class="p">),</span> <span class="n">MAT2</span><span class="o">=</span><span class="n">MAT1</span><span class="p">,</span> <span class="n">QI</span><span class="o">=</span><span class="n">QI</span> <span class="p">)</span>
            <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="nb">id</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span> <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">mixedForm</span><span class="p">(</span> <span class="n">covarsThisSection</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">)):</span> <span class="n">form</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">covarsThisSection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#raise Exception(&quot;Encountered empty covariance section!!!&quot;)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Missing covariance data from section!&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">section</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span>
            <span class="n">section</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

            <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
            <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">XMF1</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
            <span class="c"># end loop over NL subsections</span>

    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;Not all covariance data converted for MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span>
</div>
<div class="viewcode-block" id="fillRemainingProductsResidualForBreakup"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.fillRemainingProductsResidualForBreakup">[docs]</a><span class="k">def</span> <span class="nf">fillRemainingProductsResidualForBreakup</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">lightIsotopeNames</span><span class="p">,</span> <span class="n">breakupProducts</span><span class="p">,</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">residualZA2</span> <span class="o">=</span> <span class="n">residualZA</span>
    <span class="k">for</span> <span class="n">productName</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">productName</span> <span class="ow">in</span> <span class="n">breakupProducts</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span>
            <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">residualZA</span> <span class="o">%</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">residualZA2</span> <span class="o">-=</span> <span class="n">multiplicity</span> <span class="o">*</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">residualZA2</span> <span class="o">-=</span> <span class="n">multiplicity</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">residualZA2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="parseReaction"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.parseReaction">[docs]</a><span class="k">def</span> <span class="nf">parseReaction</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">targetZA</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">parseCrossSectionOnly</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span> <span class="p">:</span>
    <span class="s">&quot;Currently, the following logic only supports neutron as projectile.&quot;</span>

    <span class="n">warningList</span><span class="p">,</span> <span class="n">productList</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">info</span><span class="o">.</span><span class="n">newIndices</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">MFKeys</span> <span class="o">=</span> <span class="n">MTData</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;    </span><span class="si">%3d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span> <span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span> <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">MF</span> <span class="p">)</span>

    <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">breakupProducts</span> <span class="o">=</span> <span class="n">readMF3</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">3</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">parseCrossSectionOnly</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">),</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MFKeys</span> <span class="p">)</span>

    <span class="k">try</span> <span class="p">:</span>
        <span class="n">fissionGenre</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">18</span> <span class="p">:</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">fissionGenreTotal</span><span class="p">,</span> <span class="mi">19</span> <span class="p">:</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">fissionGenreFirstChance</span><span class="p">,</span> 
            <span class="mi">20</span> <span class="p">:</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">fissionGenreSecondChance</span><span class="p">,</span> <span class="mi">21</span> <span class="p">:</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">fissionGenreThirdChance</span><span class="p">,</span> <span class="mi">38</span> <span class="p">:</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">fissionGenreFourthChance</span> <span class="p">}[</span><span class="n">MT</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="n">fissionGenre</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">neutronMFs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span> <span class="n">neutronMFs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">MF</span> <span class="p">)</span>

    <span class="n">endfMTProductList</span> <span class="o">=</span> <span class="n">endf_endl</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>
    <span class="n">compoundZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">targetZA</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span>
    <span class="n">lightIsotopeZAs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">[</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">lightIsotopeZAsMultiplicity</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]]</span> <span class="o">=</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="mi">4</span> <span class="ow">in</span> <span class="n">neutronMFs</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">18</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>          <span class="c"># MT == 18 and neutronMFs == [ 5 ] is a special case for bad data.</span>
        <span class="n">ZAP</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span> <span class="p">]</span> <span class="p">)</span>  <span class="p">:</span>                <span class="c"># Not elastic or fission.</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>

    <span class="n">levelIndex</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">twoBodyResidualZA</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span><span class="p">(</span>    <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">91</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">50</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">600</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">649</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">600</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">650</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">699</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">650</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">700</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">749</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">700</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">750</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">799</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">750</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">800</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">849</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">800</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">875</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">891</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">875</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span><span class="p">,</span> <span class="mi">891</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="s">&#39;c&#39;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="s">&#39;s&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span>                                                 <span class="c"># If level &gt; 0., residual is in an excited state.</span>
    <span class="n">isUndefinedTwoBody</span> <span class="o">=</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">91</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">102</span> <span class="o">&lt;</span> <span class="n">MT</span> <span class="o">&lt;=</span> <span class="mi">107</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">isTwoBody</span> <span class="o">=</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">91</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">600</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">849</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">isUndefinedTwoBody</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="ow">or</span> <span class="n">isUndefinedTwoBody</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="n">projectileZA</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">productName</span> <span class="ow">in</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productName</span> <span class="o">==</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">ZAP</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">ZAP</span> <span class="o">=</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span>
        <span class="n">twoBodyResidualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span>
    <span class="n">undefinedLevelInfo</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;ZA&#39;</span> <span class="p">:</span> <span class="n">twoBodyResidualZA</span><span class="p">,</span> <span class="s">&#39;level&#39;</span> <span class="p">:</span> <span class="n">level</span><span class="p">,</span> <span class="s">&#39;levelIndex&#39;</span> <span class="p">:</span> <span class="n">levelIndex</span><span class="p">,</span> <span class="s">&#39;count&#39;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">4</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>                     <span class="c"># This is a two-body reaction with only angular data.</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;With only MF = 4 data present, reaction is assumed to be two-body and it is not for MT = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">readMF4</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">twoBodyComponent</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">4</span> <span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="n">component</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">distributions</span> <span class="p">)</span>
        <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="c"># cmattoon, Mar2011: don&#39;t check ZAP if MT=5. Currently this combination, MT=5, MF=4/5 appears only for incident gammas</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span><span class="o">!=</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">ZAP</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;ZAP = </span><span class="si">%d</span><span class="s"> != 1 for MFs = [ 4, 5 ] for MT = </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span> <span class="p">]</span> <span class="p">)</span>  <span class="p">:</span>                <span class="c"># Not elastic or fission.</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>             <span class="c"># MF = 5 data is always in lab frame.</span>
            <span class="n">angularComponent</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
            <span class="n">angularComponent</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">angularComponent</span> <span class="o">=</span> <span class="n">readMF4</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">distributions</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">addAngularComponent</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span>
            <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">4</span> <span class="p">)</span>

        <span class="n">energyComponent</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">readMF5</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">product</span> <span class="o">=</span> <span class="n">product</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">5</span> <span class="p">)</span>

        <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">uncorrelated</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">angularComponent</span><span class="p">,</span> <span class="n">energyComponent</span> <span class="p">)</span>
        <span class="n">angularComponent</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span> <span class="n">component</span> <span class="p">);</span> <span class="n">energyComponent</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
        <span class="n">component</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">distributions</span>
        <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
        <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">6</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">isTwoBody</span> <span class="o">=</span> <span class="n">readMF6</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span><span class="p">,</span> <span class="n">isTwoBody</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">6</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="ow">and</span> <span class="bp">False</span> <span class="p">)</span> <span class="p">:</span>                 <span class="c"># ????????? Why False</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;How did we get here.&#39;</span> <span class="p">)</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">levelIndex</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">levelIndex</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">QI</span> <span class="o">!=</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">:</span>     <span class="c"># Residual is in an excited state.</span>
                <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyDecayChannel</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="p">),</span> <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">decayChannel</span> <span class="p">)</span>
            <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
            <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">residual</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">info</span><span class="o">.</span><span class="n">crossSection</span> <span class="o">=</span> <span class="n">crossSection</span>
    <span class="n">readMF12_13</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="k">del</span> <span class="n">info</span><span class="o">.</span><span class="n">crossSection</span>

    <span class="k">for</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span> <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">MF</span> <span class="p">)</span>
    <span class="n">specialBe9n2nExcited</span><span class="p">,</span> <span class="n">specialBe9n2nExcitedLevel</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">875</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">892</span> <span class="p">)</span> <span class="p">:</span>                                         <span class="c"># Special case for (z,2n[?])</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">targetZA</span> <span class="o">==</span> <span class="mi">4009</span> <span class="p">)</span> <span class="p">:</span>                                    <span class="c"># Special case for Be9(n,2n[?]He4)He4</span>
            <span class="n">specialBe9n2nExcited</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">specialBe9n2nExcitedLevel</span> <span class="o">=</span> <span class="p">(</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">QM</span> <span class="o">!=</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;    --QM </span><span class="si">%s</span><span class="s"> != QI = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">sumOfRemainingOutputChannels</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">102</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">residualIndex</span><span class="p">,</span> <span class="n">gammaMissing</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="p">:</span> <span class="n">residualIndex</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">gammaMissing</span> <span class="o">=</span> <span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">==</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="n">gammaMissing</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">residualIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> 
            <span class="n">productList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">residualIndex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">productList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">productList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="n">residualIndex</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">gammaMissing</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">)</span>        <span class="c"># Q????? What about QI?</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">QI</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">QM</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;QI = 0, QM = </span><span class="si">%f</span><span class="s"> for MT=</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">QM</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">twoBodyOutputChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAs</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;product data for reaction MT = </span><span class="si">%s</span><span class="s"> needs to be implemented&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">decayProductList</span> <span class="o">=</span> <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">productList</span> <span class="o">=</span> <span class="n">productList</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>                               <span class="c"># Assume first product is &quot;b&quot; in &quot;a + A -&gt; b + B&quot; where B is the larger product.</span>
        <span class="n">ZA</span> <span class="o">=</span> <span class="n">productList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="n">ZA</span> <span class="p">)</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;levelIndex&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">levelIndex</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">levelIndex</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;levelIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">levelIndex</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">decayProductList</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">ZA</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">residualZA</span> <span class="o">==</span> <span class="n">ZA</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">decayProductList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="n">index</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> 
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">target</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="o">==</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;ZA&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s">&#39;ZA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">decayZAs</span><span class="p">,</span> <span class="n">decayGammaList</span><span class="p">,</span> <span class="n">decayNonGammaList</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">decayProduct</span> <span class="ow">in</span> <span class="n">decayProductList</span> <span class="p">:</span> 
            <span class="n">decayZAs</span> <span class="o">+=</span> <span class="n">decayProduct</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">decayProduct</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">==</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">decayGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">decayProduct</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">decayNonGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">decayProduct</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">decayZAs</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayGammaList</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayNonGammaList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> 
                    <span class="n">decayNonGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayNonGammaList</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> 
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayGammaList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">decayGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">decayProductList</span> <span class="o">=</span> <span class="n">decayNonGammaList</span> <span class="o">+</span> <span class="n">decayGammaList</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;decayZAs = </span><span class="si">%d</span><span class="s"> != 0&quot;</span> <span class="o">%</span> <span class="n">decayZAs</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">breakupProducts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;breakupProducts and decayChannel both not None&#39;</span> <span class="p">)</span>
            <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyDecayChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">fillRemainingProductsResidualForBreakup</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">lightIsotopeNames</span><span class="p">,</span> <span class="n">breakupProducts</span><span class="p">,</span> 
                <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addDecayChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayProductList</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                         <span class="c"># At this point, both two bodies are in productList and second one is redisual.</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">QI</span> <span class="o">&gt;=</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Negative decay Q-value for MT</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyDecayChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">)</span>     <span class="c"># Q????? Not right.</span>
            <span class="k">for</span> <span class="n">decayProduct</span> <span class="ow">in</span> <span class="n">decayProductList</span> <span class="p">:</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">decayProduct</span> <span class="p">)</span>
            <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addDecayChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>

    <span class="k">elif</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">isFission</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s">&#39;fissionEnergies&#39;</span> <span class="p">):</span> 
            <span class="n">ER</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">fissionEnergies</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">fissionEnergies</span><span class="o">.</span><span class="n">nativeData</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span> <span class="s">&#39;nonNeutrinoEnergy&#39;</span> <span class="p">]</span> <span class="c"># gets whole polynomial + uncertianty</span>
            <span class="n">useThisQM</span> <span class="o">=</span> <span class="n">ER</span><span class="p">[</span> <span class="mi">0</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">]</span> <span class="c"># grab constant term and take the value, not the uncertainty</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">useThisQM</span> <span class="p">)</span><span class="o">/</span><span class="n">QM</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;WARNING: Fission QM inconsistent with energy release data for MT = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">useThisQM</span> <span class="o">=</span> <span class="n">QM</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">fissionChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">useThisQM</span> <span class="p">),</span> <span class="n">fissionGenre</span> <span class="o">=</span> <span class="n">fissionGenre</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">18</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s">&#39;fissionEnergies&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">addFissionEnergyReleased</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">fissionEnergies</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">productList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">outputChannel</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">unknown</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
                <span class="n">outputChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">outputChannel</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
                <span class="n">info</span><span class="o">.</span><span class="n">firstFissionNeutron</span> <span class="o">=</span> <span class="n">product</span>
                <span class="k">if</span><span class="p">(</span> <span class="s">&#39;prompt&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">setMultiplicity</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span><span class="p">[</span><span class="s">&#39;prompt&#39;</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">removeForm</span><span class="p">(</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;emissionMode&#39;</span><span class="p">,</span> <span class="s">&#39;prompt&#39;</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="s">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: have prompt fission nu_bar so not including total&#39;</span> <span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span> <span class="s">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">setMultiplicity</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">removeForm</span><span class="p">(</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;emissionMode&#39;</span><span class="p">,</span> <span class="s">&#39;total&#39;</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s">&#39;delayedFissionDecayChannel&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">for</span> <span class="n">delayedNeutron</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">delayedFissionDecayChannel</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">delayedNeutron</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s">&#39;firstFissionNeutron&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">firstFissionNeutron</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>                                              <span class="c"># When singleMTOnly is fission MT != 18.</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">unknown</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s">&#39;firstFissionNeutron&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">component</span> <span class="o">=</span> <span class="n">distributions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">referenceComponent</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">firstFissionNeutron</span><span class="o">.</span><span class="n">distributions</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">addDistributionComponent</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">setNativeData</span><span class="p">(</span> <span class="n">component</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                <span class="n">outputChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>

        <span class="c"># July 2011: some files have distributions for 1stChanceFission etc, but should still link to total nubar:</span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productList</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">nativeData</span> <span class="o">==</span> <span class="n">gnd</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">constantFormToken</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">getConstant</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s">&#39;firstFissionNeutron&#39;</span> <span class="p">):</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">productData</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">firstFissionNeutron</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">addFormAsNativeData</span><span class="p">(</span> <span class="n">multiplicity</span> <span class="p">)</span>

        <span class="k">while</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">productList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">)</span>                    <span class="c"># Q?????</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">residualZA</span><span class="p">,</span> <span class="n">ZAsMultiplicities</span><span class="p">,</span> <span class="n">productAsResidual</span><span class="p">,</span> <span class="n">biggestProduct</span> <span class="o">=</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="p">{},</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">==</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>
                <span class="n">Z</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">ZA</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">(</span> <span class="p">)</span>
                <span class="k">try</span> <span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">getConstant</span><span class="p">(</span> <span class="p">)</span>
                <span class="k">except</span> <span class="p">:</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Incorrect multiplicity in ENDF file! MT = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;Multiplicity should be constant but is (</span><span class="si">%s</span><span class="s">).</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">getFormByToken</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAs</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
                        <span class="c"># If we have different distributions for both neutrons in (n,2n), n shows up twice in the productList.</span>
                    <span class="k">if</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">ZAsMultiplicities</span><span class="p">:</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">+=</span> <span class="n">m</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">productAsResidual</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> 
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;multiple residuals for MT = %, </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">productAsResidual</span><span class="o">.</span><span class="n">getToken</span><span class="p">(</span> <span class="p">),</span> <span class="n">product</span><span class="o">.</span><span class="n">getToken</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">productAsResidual</span> <span class="o">=</span> <span class="n">product</span>

            <span class="n">_residualZA</span> <span class="o">=</span> <span class="n">compoundZA</span>
            <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAsMultiplicity</span> <span class="p">:</span> <span class="n">_residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">_residualZA</span><span class="p">,</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">*</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">residualZA</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAs</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ZAsMultiplicities</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">==</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>       <span class="c"># All this ZA accounted for.</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;negative multiplicity for ZA = </span><span class="si">%s</span><span class="s"> for MT = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span>
                    <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="bp">None</span> <span class="p">),</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">*</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">productAsResidual</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">residualZA</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span><span class="p">,</span> <span class="mi">891</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">gammaIndices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="o">==</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="p">:</span> <span class="n">gammaIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">index</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">gammaIndices</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">NBodyDecayChannel</span><span class="p">(</span> <span class="n">returnConstantQ</span><span class="p">(</span> <span class="o">-</span><span class="n">QI</span> <span class="p">)</span> <span class="p">)</span>          <span class="c"># Q?????</span>
                    <span class="n">finalResidual</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">finalResidual</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span> <span class="s">&#39;ENDFconversionFlag&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">finalResidual</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span> <span class="s">&#39;ENDFconversionFlag&#39;</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">gammaIndices</span> <span class="p">:</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">gammaIndices</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">gammaIndices</span> <span class="p">:</span> <span class="k">del</span> <span class="n">productList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addDecayChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getDistributionNativeData</span><span class="p">(</span> <span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;none&#39;</span> <span class="p">)</span> <span class="p">:</span>  <span class="c"># One must be careful here as this assumes that distributions</span>
                        <span class="n">u_distributions</span> <span class="o">=</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distributions</span>             <span class="c"># can be simply traded.</span>
                        <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distributions</span> <span class="o">=</span> <span class="n">finalResidual</span><span class="o">.</span><span class="n">distributions</span>
                        <span class="n">finalResidual</span><span class="o">.</span><span class="n">distributions</span> <span class="o">=</span> <span class="n">u_distributions</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productList</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">outputChannel</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MFKeys</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="parseCovariances"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.parseCovariances">[docs]</a><span class="k">def</span> <span class="nf">parseCovariances</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">,</span> <span class="n">MTdict</span><span class="p">,</span> <span class="n">singleMTOnly</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resonances</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>

    <span class="n">covarianceSuite</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceSuite</span><span class="p">()</span>
    <span class="n">linkData</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c"># which mf/mts need to be linked for each covariance?</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">singleMTOnly</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">covarianceSuite</span><span class="p">,</span> <span class="n">linkData</span> <span class="p">)</span>

    <span class="c"># make list of available covariance information:</span>
    <span class="n">warningList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cov_info</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;MTL&#39;</span><span class="p">:{},</span> <span class="s">&#39;MTL_2&#39;</span><span class="p">:{},</span> <span class="s">&#39;lumpedChannels&#39;</span><span class="p">:{},</span> <span class="s">&#39;externalReactions&#39;</span><span class="p">:{},</span> <span class="s">&#39;mfmts&#39;</span><span class="p">:[],</span> <span class="s">&#39;MTdict&#39;</span><span class="p">:</span><span class="n">MTdict</span><span class="p">,</span>
            <span class="s">&#39;resonances&#39;</span><span class="p">:</span><span class="n">resonances</span><span class="p">,</span> <span class="s">&#39;NC_data&#39;</span><span class="p">:[]}</span>
    <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">MTDatas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">singleMTOnly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mt</span><span class="o">!=</span><span class="n">singleMTOnly</span><span class="p">):</span> <span class="k">continue</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mf</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>    <span class="c"># all covariance-type data</span>
                <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;mfmts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
    <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;mfmts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c"># sorting first by MF, then by MT</span>

    <span class="k">for</span> <span class="n">mf</span><span class="p">,</span><span class="n">mt</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;mfmts&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mf</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="mi">33</span><span class="p">):</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF31_33</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF32</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">151</span><span class="p">][</span><span class="mi">32</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">34</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF34</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">35</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF35</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF40</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: MF</span><span class="si">%i</span><span class="s"> not yet supported&#39;</span> <span class="o">%</span> <span class="n">mf</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span> <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addModelParameterCovariance</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
            <span class="n">linkData</span> <span class="o">+=</span> <span class="n">tmp</span>
        <span class="k">except</span> <span class="n">BadCovariance</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;       WARNING: MF</span><span class="si">%i</span><span class="s"> MT</span><span class="si">%i</span><span class="s"> covariance conversion failed with message &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="c"># fix links for summed matrices:</span>
    <span class="k">for</span> <span class="n">summedMatrix</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;NC_data&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">pointer</span> <span class="ow">in</span> <span class="n">summedMatrix</span><span class="o">.</span><span class="n">pointerList</span><span class="p">:</span>
            <span class="n">pointed_to</span> <span class="o">=</span> <span class="p">[</span><span class="n">sec</span> <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">sections</span> <span class="k">if</span> <span class="n">sec</span><span class="o">.</span><span class="n">columnData</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">sec</span><span class="o">.</span><span class="n">rowData</span><span class="p">[</span><span class="s">&#39;ENDF_MFMT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pointer</span><span class="p">[</span><span class="s">&#39;ENDF_MFMT&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pointed_to</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Can&#39;t resolve links for summed covariance matrix!&quot;</span><span class="p">)</span>
            <span class="n">pointer</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">pointed_to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># fix lumped channel covariances (MT851-871) and summed channels (MT1,4,103-107)</span>
    <span class="n">summedReactions</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>  <span class="n">summedReactions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTL_2&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)</span> <span class="ow">in</span> <span class="n">summedReactions</span><span class="p">:</span>
        <span class="n">lumpedChannels</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;lumpedChannels&#39;</span><span class="p">][(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">mt2</span><span class="p">,</span><span class="n">mf2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">summedReactions</span><span class="p">[(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">mt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">851</span><span class="p">,</span><span class="mi">872</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mt2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;MTdict&#39;</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span><span class="n">cov_info</span><span class="p">,</span> <span class="n">mt2</span><span class="p">,</span> <span class="n">mf2</span><span class="p">)</span>
            <span class="n">lumpedChannels</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">pointers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;lumpedChannels&#39;</span><span class="p">]):</span>
        <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addReactionSum</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;lumpedChannels&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">exReac</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;externalReactions&#39;</span><span class="p">]):</span>
        <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addExternalReaction</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">[</span><span class="s">&#39;externalReactions&#39;</span><span class="p">][</span><span class="n">exReac</span><span class="p">]</span> <span class="p">)</span>

    <span class="c"># add labels</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">covarianceSuite</span><span class="o">.</span><span class="n">sections</span> <span class="o">+</span> <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">modelParameterCovariances</span><span class="p">):</span>
        <span class="n">section</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warningList</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">warning</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">covarianceSuite</span><span class="p">,</span> <span class="n">linkData</span>
</div>
<div class="viewcode-block" id="endfFileToGND"><a class="viewcode-back" href="../../../../fudge/fudge.legacy.converting.html#fudge.legacy.converting.endfFileToGND.endfFileToGND">[docs]</a><span class="k">def</span> <span class="nf">endfFileToGND</span><span class="p">(</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">xenslIsotopes</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">useFilesQAlways</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">singleMTOnly</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">parseCrossSectionOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
        <span class="n">toStdOut</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">toStdErr</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">skipBadData</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">deprecatedOptions</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">logs</span> <span class="o">=</span> <span class="n">logFiles</span><span class="p">(</span> <span class="n">toStdOut</span> <span class="o">=</span> <span class="n">toStdOut</span><span class="p">,</span> <span class="n">toStdErr</span> <span class="o">=</span> <span class="n">toStdErr</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logFile</span><span class="p">,</span> <span class="n">defaultIsStderrWriting</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">MAT</span><span class="p">,</span> <span class="n">MTDatas</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">parseENDFByMT_MF</span><span class="p">(</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>

    <span class="n">targetZA</span><span class="p">,</span> <span class="n">targetMass</span><span class="p">,</span> <span class="n">LRP</span><span class="p">,</span> <span class="n">LFI</span><span class="p">,</span> <span class="n">NLIB</span><span class="p">,</span> <span class="n">NMOD</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>
    <span class="n">targetZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">targetZA</span> <span class="p">)</span>      <span class="c"># Target&#39;s ZA</span>
    <span class="n">LRP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LRP</span> <span class="p">)</span>            <span class="c"># Resonance parameter data info</span>
    <span class="n">LFI</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LFI</span> <span class="p">)</span>            <span class="c"># Is fission present</span>
    <span class="n">NLIB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NLIB</span> <span class="p">)</span>          <span class="c"># What library (e.g., 0 = ENDF/B</span>
    <span class="n">NMOD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NMOD</span> <span class="p">)</span>          <span class="c"># Version modification flag</span>
    <span class="n">isNaturalTarget</span> <span class="o">=</span> <span class="p">(</span> <span class="n">targetZA</span> <span class="o">%</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">targetExcitationEnergy</span><span class="p">,</span> <span class="n">STA</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">LISO</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NFOR</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>
    <span class="n">STA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">STA</span> <span class="p">)</span>            <span class="c"># Is nucleus unstable</span>
    <span class="n">LIS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LIS</span> <span class="p">)</span>            <span class="c"># Excitation number</span>
    <span class="n">LISO</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LISO</span> <span class="p">)</span>          <span class="c"># Isomeric state number</span>
    <span class="n">NFOR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NFOR</span> <span class="p">)</span>          <span class="c"># Must be 6 for ENDF/B6 format</span>

    <span class="n">projectileMass</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LREL</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NSUB</span><span class="p">,</span> <span class="n">NVER</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>
    <span class="n">NSUB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NSUB</span> <span class="p">)</span>          <span class="c"># 10 * ZA + iType for projectile</span>
    <span class="n">NVER</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NVER</span> <span class="p">)</span>          <span class="c"># Evaluation version number</span>
    <span class="n">LREL</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LREL</span> <span class="p">)</span>          <span class="c"># Evaluation sub-version number</span>
    <span class="n">projectileZA</span><span class="p">,</span> <span class="n">ITYPE</span> <span class="o">=</span> <span class="n">NSUB</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">NSUB</span> <span class="o">%</span> <span class="mi">10</span>
    <span class="c">#if( ITYPE != 0 ) : raise Exception( &quot;Currently, only ITYPE = 0 files are supported&quot; )</span>
    <span class="c">#if( projectileZA != 1 ) : raise Exception( &quot;Currently, only neutron as projectile is supported&quot; )</span>

    <span class="n">targetTemperature</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LDRZ</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NWD</span><span class="p">,</span> <span class="n">NXC</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>
    <span class="n">LDRZ</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LDRZ</span> <span class="p">)</span>          <span class="c"># Primary or special evaluation of this material</span>
    <span class="n">NWD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NWD</span> <span class="p">)</span>            <span class="c"># </span>
    <span class="n">NXC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NXC</span> <span class="p">)</span>            <span class="c">#</span>

    <span class="c">#evaluation = MTDatas[451][1][6][4:22].strip( )</span>
    <span class="n">evaluation</span> <span class="o">=</span> <span class="p">{</span>\
        <span class="mi">0</span><span class="p">:</span> <span class="s">&quot;ENDF/B&quot;</span><span class="p">,</span> \
        <span class="mi">1</span><span class="p">:</span> <span class="s">&quot;ENDF/A&quot;</span><span class="p">,</span> \
        <span class="mi">2</span><span class="p">:</span> <span class="s">&quot;JEFF&quot;</span><span class="p">,</span> \
        <span class="mi">3</span><span class="p">:</span> <span class="s">&quot;EFF&quot;</span><span class="p">,</span>\
        <span class="mi">4</span><span class="p">:</span> <span class="s">&quot;ENDF/B (HE)&quot;</span><span class="p">,</span>\
        <span class="mi">5</span><span class="p">:</span> <span class="s">&quot;CENDL&quot;</span><span class="p">,</span> \
        <span class="mi">6</span><span class="p">:</span> <span class="s">&quot;JENDL&quot;</span><span class="p">,</span> \
        <span class="mi">21</span><span class="p">:</span> <span class="s">&quot;SG-23&quot;</span><span class="p">,</span>\
        <span class="mi">31</span><span class="p">:</span> <span class="s">&quot;INDL/V&quot;</span><span class="p">,</span> \
        <span class="mi">32</span><span class="p">:</span> <span class="s">&quot;INDL/A&quot;</span><span class="p">,</span> \
        <span class="mi">33</span><span class="p">:</span> <span class="s">&quot;FENDL&quot;</span><span class="p">,</span>\
        <span class="mi">34</span><span class="p">:</span> <span class="s">&quot;IRDF&quot;</span><span class="p">,</span> \
        <span class="mi">35</span><span class="p">:</span> <span class="s">&quot;BROND (IAEA version)&quot;</span><span class="p">,</span>\
        <span class="mi">36</span><span class="p">:</span> <span class="s">&quot;INGDB-90&quot;</span><span class="p">,</span>\
        <span class="mi">37</span><span class="p">:</span> <span class="s">&quot;FENDL/A&quot;</span><span class="p">,</span>\
        <span class="mi">41</span><span class="p">:</span> <span class="s">&quot;BROND&quot;</span><span class="p">,</span>\
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">NLIB</span><span class="p">,</span> <span class="s">&#39;Unknown&#39;</span> <span class="p">)</span>
    <span class="n">documentation</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">documentation</span><span class="o">.</span><span class="n">documentation</span><span class="p">(</span> <span class="s">&#39;endfDoc&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">NWD</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">evaluatedStyle</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">miscellaneous</span><span class="o">.</span><span class="n">style</span><span class="p">(</span> <span class="s">&#39;evaluated&#39;</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;library&#39;</span> <span class="p">:</span> <span class="n">evaluation</span><span class="p">,</span> <span class="s">&#39;version&#39;</span> <span class="p">:</span> <span class="s">&quot;</span><span class="si">%i</span><span class="s">.</span><span class="si">%i</span><span class="s">.</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NVER</span><span class="p">,</span><span class="n">LREL</span><span class="p">,</span><span class="n">NMOD</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
    <span class="n">transportables</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;gamma&#39;</span> <span class="p">]</span>                          <span class="c"># ???? Check this with Gerry?</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">endlToGND</span><span class="o">.</span><span class="n">infos</span><span class="p">(</span> <span class="n">xenslIsotopes</span><span class="p">,</span> <span class="n">transportables</span> <span class="o">=</span> <span class="n">transportables</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ignoreBadNK14</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">deprecatedOptionList</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;ignoreBadNK14&#39;</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">deprecatedOptions</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">options</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deprecatedOptionList</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;invalid deprecated option &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">options</span> <span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">deprecatedOptions</span><span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="n">logs</span>
    <span class="n">info</span><span class="o">.</span><span class="n">projectile</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">:</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span>  <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="mi">1001</span> <span class="p">:</span> <span class="s">&#39;H1&#39;</span><span class="p">,</span> <span class="mi">1002</span> <span class="p">:</span> <span class="s">&#39;H2&#39;</span><span class="p">,</span> <span class="mi">1003</span> <span class="p">:</span> <span class="s">&#39;H3&#39;</span><span class="p">,</span> <span class="mi">2003</span> <span class="p">:</span> <span class="s">&#39;He3&#39;</span><span class="p">,</span> <span class="mi">2004</span> <span class="p">:</span> <span class="s">&#39;He4&#39;</span> <span class="p">}[</span><span class="n">projectileZA</span><span class="p">]</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">projectileZA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">projectileMass</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">targetZA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">targetMass</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">projectileZA</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">masses</span><span class="o">.</span><span class="n">getMassFromZA</span><span class="p">(</span> <span class="n">projectileZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">targetZA</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetMass</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">masses</span><span class="o">.</span><span class="n">getMassFromZA</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">masses</span><span class="o">.</span><span class="n">getMassFromZA</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="c"># always need neutron mass in table</span>
    
    <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;total&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;MTs&#39;</span> <span class="p">:</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">91</span> <span class="p">),</span> <span class="s">&#39;partialPresent&#39;</span> <span class="p">:</span> <span class="bp">False</span> <span class="p">},</span> 
        <span class="mi">103</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;total&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;MTs&#39;</span> <span class="p">:</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">650</span> <span class="p">),</span> <span class="s">&#39;partialPresent&#39;</span> <span class="p">:</span> <span class="bp">False</span> <span class="p">},</span>
        <span class="mi">104</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;total&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;MTs&#39;</span> <span class="p">:</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">650</span><span class="p">,</span> <span class="mi">700</span> <span class="p">),</span> <span class="s">&#39;partialPresent&#39;</span> <span class="p">:</span> <span class="bp">False</span> <span class="p">},</span>
        <span class="mi">105</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;total&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;MTs&#39;</span> <span class="p">:</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">750</span> <span class="p">),</span> <span class="s">&#39;partialPresent&#39;</span> <span class="p">:</span> <span class="bp">False</span> <span class="p">},</span>
        <span class="mi">106</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;total&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;MTs&#39;</span> <span class="p">:</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">800</span> <span class="p">),</span> <span class="s">&#39;partialPresent&#39;</span> <span class="p">:</span> <span class="bp">False</span> <span class="p">},</span>
        <span class="mi">107</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;total&#39;</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;MTs&#39;</span> <span class="p">:</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">850</span> <span class="p">),</span> <span class="s">&#39;partialPresent&#39;</span> <span class="p">:</span> <span class="bp">False</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">info</span><span class="o">.</span><span class="n">MF12_LO2</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span> <span class="n">Date</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">getENDFDate</span><span class="p">(</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">)</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="mi">33</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span>

    <span class="n">projectile</span> <span class="o">=</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">projectileZA</span> <span class="p">)</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">targetExcitationEnergy</span>
    <span class="n">levelIndex</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LIS</span>  <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">LIS</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">targetZA</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">levelIndex</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">STA</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">nuclearLevel</span><span class="p">):</span> <span class="n">target</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;unstable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">reactionSuite</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactionSuite</span><span class="p">(</span> <span class="n">projectile</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">particleList</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">particleList</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="n">evaluatedStyle</span><span class="p">,</span> <span class="n">documentation</span> <span class="o">=</span> <span class="n">documentation</span> <span class="p">)</span>
    <span class="n">reactionSuite</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span> <span class="s">&#39;temperature&#39;</span><span class="p">,</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">targetTemperature</span><span class="p">,</span> <span class="s">&#39;K&#39;</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LISO</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">metaStableName</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;_&#39;</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metaStableName</span> <span class="o">+=</span> <span class="s">&#39;_m</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">LISO</span>
        <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addAlias</span><span class="p">(</span> <span class="n">metaStableName</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">setReactionSuite</span><span class="p">(</span> <span class="n">reactionSuite</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">target</span>
    <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="o">=</span> <span class="n">LIS</span>

    <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">451</span><span class="p">][</span><span class="mi">1</span><span class="p">][:</span><span class="mi">4</span><span class="o">+</span><span class="n">NWD</span><span class="p">]</span>
    <span class="n">warningList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">452</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getTotalOrPromptFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">452</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="c">#MTDatas.pop( 452 ) # don&#39;t remove these yet, still need the covariance info</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">455</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">delayedFissionNeutron</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">info</span><span class="o">.</span><span class="n">delayedFissionDecayChannel</span> <span class="o">=</span> <span class="n">getDelayedFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">455</span><span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">delayedFissionNeutron</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#MTDatas.pop( 455 )</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">456</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span><span class="p">[</span><span class="s">&#39;prompt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getTotalOrPromptFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">456</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;prompt&#39;</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="c">#MTDatas.pop( 456 )</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">458</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">fissionEnergies</span> <span class="o">=</span> <span class="n">getFissionEnergies</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">458</span><span class="p">]</span> <span class="p">)</span>
        <span class="c">#MTDatas.pop( 458 )</span>
    <span class="k">if</span> <span class="p">(</span> <span class="mi">454</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="n">info</span><span class="o">.</span><span class="n">independentFissionYields</span> <span class="o">=</span> <span class="n">readMF8</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">454</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">454</span><span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span> <span class="mi">459</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span> 
        <span class="n">info</span><span class="o">.</span><span class="n">cumulativeFissionYields</span> <span class="o">=</span> <span class="n">readMF8</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">459</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">459</span><span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warningList</span> <span class="p">:</span> <span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">warning</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">MTDatas</span> <span class="p">)</span> <span class="p">:</span>
        <span class="c"># MT3 is a redundant quantity (&#39;nonelastic&#39;). Remove any product information, and store only the cross section</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">MTDatas</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
                <span class="n">removed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
            <span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;     WARNING: distributions for MT=3 (nonelastic) are not supported and have been ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>

    <span class="n">MTList</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">niceSortOfMTs</span><span class="p">(</span> <span class="n">MTDatas</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">),</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>
    <span class="n">haveTotalFission</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span> <span class="ow">in</span> <span class="n">MTList</span><span class="p">)</span>
    <span class="n">fissionMTs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mt</span> <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">MTList</span> <span class="k">if</span> <span class="n">mt</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">38</span><span class="p">)]</span>
    <span class="n">iChannel</span><span class="p">,</span> <span class="n">totalReactions</span><span class="p">,</span> <span class="n">MT5Reaction</span><span class="p">,</span> <span class="n">summedReactions</span><span class="p">,</span> <span class="n">fissionComponents</span><span class="p">,</span> <span class="n">productions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{},</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">MTList</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">singleMTOnly</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">!=</span> <span class="n">singleMTOnly</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>
        <span class="n">MTData</span> <span class="o">=</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>

        <span class="k">if</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">MTData</span><span class="p">:</span> <span class="c"># normal reaction, with cross section and distributions</span>
            <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">outputChannel</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MFKeys</span> <span class="o">=</span> <span class="n">parseReaction</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span>
                    <span class="n">targetZA</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">parseCrossSectionOnly</span> <span class="o">=</span> <span class="n">parseCrossSectionOnly</span> <span class="p">)</span>
            <span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warningList</span> <span class="p">:</span> <span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">warning</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;       WARNING: For reaction MT = </span><span class="si">%d</span><span class="s">, the following MFs were not converted: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">outputChannel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="n">reactionOutputChannel</span> <span class="o">=</span> <span class="n">outputChannel</span>

            <span class="n">reaction</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">reaction</span><span class="p">(</span> <span class="n">reactionOutputChannel</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span><span class="p">,</span> <span class="n">ENDF_MT</span> <span class="o">=</span> <span class="n">MT</span><span class="p">,</span> <span class="n">crossSection</span> <span class="o">=</span> <span class="n">crossSection</span> <span class="p">)</span>
            <span class="n">reaction</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span> <span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="n">Date</span> <span class="p">)</span>
<span class="c">#            if( useFilesQAlways or ( MT in [ 18, 19, 20, 21, 38 ] ) or ( isNaturalTarget and ( QM != 0. ) ) ) : </span>
<span class="c">#                reaction.setAttribute( &#39;Q&#39;, physicalQuantityWithUncertainty.PhysicalQuantityWithUncertainty( QM, &#39;eV&#39; ) )  # Q????? The meaning of Q needs to be clarified.</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">totalReactions</span> <span class="p">)</span> <span class="p">:</span> <span class="n">totalReactions</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">totalReactions</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">reaction</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">MT5Reaction</span> <span class="o">=</span> <span class="n">reaction</span>
            <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">channelId</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s">&#39;nonelastic&#39;</span><span class="p">}</span>
                <span class="n">reaction</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">summedReaction</span><span class="o">.</span><span class="n">summedReaction</span><span class="p">(</span> <span class="n">channelId</span><span class="p">[</span><span class="n">MT</span><span class="p">],</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span><span class="p">,</span> <span class="n">ENDF_MT</span> <span class="o">=</span> <span class="n">MT</span><span class="p">,</span> <span class="n">crossSection</span> <span class="o">=</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">reactionOutputChannel</span><span class="o">.</span><span class="n">Q</span> <span class="p">)</span>
                <span class="n">reaction</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span> <span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="n">Date</span> <span class="p">)</span>
                <span class="n">summedReactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">reaction</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">fissionMTs</span> <span class="ow">and</span> <span class="n">haveTotalFission</span><span class="p">:</span> <span class="c"># this is 1st, 2nd, etc fission but total is also present</span>
                <span class="n">fissionComponents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">reaction</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addReaction</span><span class="p">(</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">iChannel</span> <span class="p">)</span>
                <span class="n">iChannel</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c"># get radioactive production data (if any) from MF 8-10. x-section form depends on value of LMF:</span>
        <span class="c"># LMF=3 says just use MF3, LMF=9 says multiply MF3 by MF9 weights, LMF=10 explicitly gives x-section</span>
        <span class="n">LMF</span><span class="p">,</span> <span class="n">radioactiveDatas</span> <span class="o">=</span> <span class="n">readMF8</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">LMF</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">radioactiveData</span> <span class="ow">in</span> <span class="n">radioactiveDatas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;eV&#39;</span> <span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">component</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">channelData</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span> <span class="n">Q</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">productionCrossSection</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">component</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">LMF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span>
                    <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span><span class="n">labelsUnits</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="s">&#39;energy_in&#39;</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">:(</span><span class="s">&#39;weight&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)})</span>
                    <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="p">(</span><span class="n">crossSection</span><span class="o">.</span><span class="n">getDomain</span><span class="p">(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">ENDF_Accuracy</span><span class="p">,</span>
                            <span class="n">moniker</span><span class="o">=</span><span class="s">&quot;weight&quot;</span><span class="p">,</span> <span class="n">isPrimaryXData</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dataForm</span><span class="o">=</span><span class="s">&quot;XsAndYs&quot;</span> <span class="p">)</span>
                    <span class="n">productionCrossSection</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">weightedPointwise</span><span class="p">(</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">weights</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">LMF</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
                    <span class="c"># product yield = MF6 multiplicity * MF3 xsc</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span>
                    <span class="n">prod</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">outputChannel</span> <span class="k">if</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getZ_A_SuffixAndZA</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">getLevelIndex</span><span class="p">()</span> <span class="o">==</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">prod</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">axes_</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span><span class="n">labelsUnits</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="s">&#39;energy_in&#39;</span><span class="p">,</span><span class="s">&#39;eV&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">:(</span><span class="s">&#39;weight&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)})</span>
                        <span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">axes_</span><span class="p">,</span> <span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span> <span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                <span class="n">ENDF_Accuracy</span><span class="p">,</span> <span class="n">moniker</span><span class="o">=</span><span class="s">&quot;weight&quot;</span><span class="p">,</span> <span class="n">isPrimaryXData</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dataForm</span><span class="o">=</span><span class="s">&quot;XYs&quot;</span> <span class="p">)</span>
                        <span class="n">productionCrossSection</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">weightedPointwise</span><span class="p">(</span>
                            <span class="n">crossSection</span><span class="p">,</span> <span class="n">weights</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Cannot find unique product in MF6 corresponding to MT</span><span class="si">%i</span><span class="s"> LMF6 data!&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">LMF</span><span class="o">==</span><span class="mi">9</span><span class="p">:</span>
                    <span class="n">radioactiveWeight</span> <span class="o">=</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">radioactiveWeight</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="n">XYs</span><span class="o">.</span><span class="n">XYs</span><span class="p">(</span> <span class="n">radioactiveWeight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">radioactiveWeight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ENDF_Accuracy</span><span class="p">,</span>
                                <span class="n">moniker</span><span class="o">=</span><span class="s">&quot;weight&quot;</span><span class="p">,</span> <span class="n">isPrimaryXData</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
                        <span class="n">weights</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">labToken</span>
                        <span class="n">productionCrossSection</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">weightedPointwise</span><span class="p">(</span>
                            <span class="n">crossSection</span><span class="p">,</span> <span class="n">weights</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;Piecewise weighted cross section (MF=9) not supported: MT=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">LMF</span><span class="o">==</span><span class="mi">10</span><span class="p">:</span>
                    <span class="n">productionCrossSection</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unknown LMF=</span><span class="si">%i</span><span class="s"> encountered in MF=8 for MT=</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LMF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
                <span class="n">production</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">production</span><span class="p">(</span> <span class="n">radioactiveData</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ENDF_MT</span> <span class="o">=</span> <span class="n">MT</span><span class="p">,</span> <span class="n">crossSection</span> <span class="o">=</span> <span class="n">productionCrossSection</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="p">)</span>
                <span class="n">productions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">production</span> <span class="p">)</span>

    <span class="c"># end loop over MT sections</span>

    <span class="n">totalReactionMTs</span> <span class="o">=</span> <span class="n">endfFileToGNDMisc</span><span class="o">.</span><span class="n">niceSortOfMTs</span><span class="p">(</span> <span class="n">totalReactions</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">),</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logs</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">totalReactionMTs</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span><span class="p">[</span><span class="n">MT</span><span class="p">][</span><span class="s">&#39;partialPresent&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">totalReaction</span> <span class="ow">in</span> <span class="n">totalReactions</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="p">:</span>
                <span class="n">totalReaction</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span> <span class="p">)</span>
                <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addReaction</span><span class="p">(</span> <span class="n">totalReaction</span><span class="p">,</span> <span class="n">iChannel</span> <span class="p">)</span>
                <span class="n">iChannel</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">totalReaction</span> <span class="ow">in</span> <span class="n">totalReactions</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="p">:</span>
                <span class="n">channelId</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span><span class="s">&#39;(z,n)&#39;</span><span class="p">,</span> <span class="mi">103</span><span class="p">:</span><span class="s">&#39;(z,p)&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">:</span><span class="s">&#39;(z,d)&#39;</span><span class="p">,</span> <span class="mi">105</span><span class="p">:</span> <span class="s">&#39;(z,t)&#39;</span><span class="p">,</span> <span class="mi">106</span><span class="p">:</span><span class="s">&#39;(z,He3)&#39;</span><span class="p">,</span> <span class="mi">107</span><span class="p">:</span><span class="s">&#39;(z,alpha)&#39;</span><span class="p">}</span>
                <span class="n">summands</span> <span class="o">=</span> <span class="p">[</span><span class="n">gnd</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="s">&#39;summand&#39;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactions</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;ENDF_MT&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">sumCrossSections</span><span class="p">[</span><span class="n">MT</span><span class="p">][</span><span class="s">&#39;MTs&#39;</span><span class="p">]]</span>
                <span class="n">reaction</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">summedReaction</span><span class="o">.</span><span class="n">summedReaction</span><span class="p">(</span> <span class="n">channelId</span><span class="p">[</span><span class="n">MT</span><span class="p">],</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span><span class="p">,</span> <span class="n">ENDF_MT</span> <span class="o">=</span> <span class="n">MT</span><span class="p">,</span>
                        <span class="n">crossSection</span> <span class="o">=</span> <span class="n">totalReaction</span><span class="o">.</span><span class="n">crossSection</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">totalReaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">summands</span> <span class="o">=</span> <span class="n">summands</span><span class="p">)</span>
                <span class="n">reaction</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span> <span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="n">Date</span> <span class="p">)</span>
                <span class="n">summedReactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">reaction</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">MT5Reaction</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">MT5Reaction</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addReaction</span><span class="p">(</span> <span class="n">MT5Reaction</span><span class="p">,</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">iChannel</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">summedReac</span> <span class="ow">in</span> <span class="n">summedReactions</span><span class="p">:</span>  <span class="c"># [total], [nonelastic]</span>
        <span class="n">summedReac</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addSummedReaction</span><span class="p">(</span> <span class="n">summedReac</span><span class="p">,</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">iChannel</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">fissionComponent</span> <span class="ow">in</span> <span class="n">fissionComponents</span><span class="p">:</span>  <span class="c"># 1st-chance, 2nd-chance, etc</span>
        <span class="n">fissionComponent</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">fissionComponent</span><span class="o">.</span><span class="n">__class__</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">fissionComponent</span><span class="o">.</span><span class="n">fissionComponent</span>
        <span class="n">fissionComponent</span><span class="o">.</span><span class="n">moniker</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">fissionComponentToken</span>
        <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addFissionComponent</span><span class="p">(</span> <span class="n">fissionComponent</span><span class="p">,</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">iChannel</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">production</span> <span class="ow">in</span> <span class="n">productions</span><span class="p">:</span>
        <span class="n">production</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">production</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span> <span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="n">Date</span> <span class="p">)</span>
        <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addProductionReaction</span><span class="p">(</span> <span class="n">production</span><span class="p">,</span> <span class="n">iChannel</span> <span class="p">)</span>
        <span class="n">iChannel</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">warningList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># parse resonance section:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">151</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MTDatas</span><span class="p">:</span> <span class="n">mf2</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># no resonance data available</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">mf2</span> <span class="o">=</span> <span class="n">MTDatas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">151</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">mf2</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">singleMTOnly</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">resonances</span><span class="p">,</span> <span class="n">resonanceMTs</span> <span class="o">=</span> <span class="n">readMF2</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">mf2</span><span class="p">,</span> <span class="n">warningList</span><span class="p">)</span>
            <span class="n">resonances</span><span class="o">.</span><span class="n">reconstructCrossSection</span> <span class="o">=</span> <span class="p">(</span><span class="n">LRP</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>   <span class="c"># LRP was read in from first line of ENDF file</span>
            <span class="k">if</span> <span class="n">resonances</span><span class="o">.</span><span class="n">unresolved</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resonances</span><span class="o">.</span><span class="n">unresolved</span><span class="o">.</span><span class="n">tabulatedWidths</span><span class="o">.</span><span class="n">forSelfShieldingOnly</span><span class="p">:</span>
                    <span class="n">resonances</span><span class="o">.</span><span class="n">reconstructCrossSection</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">reactionSuite</span><span class="o">.</span><span class="n">addResonances</span><span class="p">(</span> <span class="n">resonances</span> <span class="p">)</span>

            <span class="c"># add spins appearing in resonance region to the particle list</span>
            <span class="k">for</span> <span class="n">particle</span><span class="p">,</span> <span class="n">spinParity</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">particle</span><span class="o">==</span><span class="s">&#39;target&#39;</span><span class="p">:</span> <span class="n">particle</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">target</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">particle</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span> <span class="n">particle</span> <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">xParticle</span><span class="p">)</span> <span class="ow">and</span> <span class="n">particle</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;gamma&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;H1&#39;</span><span class="p">):</span>
                    <span class="c"># spin should be associated with ground state level:</span>
                    <span class="n">particle</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">nuclearLevel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">particle</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_e0&#39;</span><span class="p">,</span>
                        <span class="n">energy</span><span class="o">=</span><span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="s">&#39;0 eV&#39;</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">particle</span> <span class="o">=</span> <span class="n">particle</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;spin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spinParity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">spinParity</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">particle</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;parity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spinParity</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">resonances</span><span class="o">.</span><span class="n">reconstructCrossSection</span><span class="p">:</span>
                <span class="c"># modify cross sections for relevant channels to indicate resonance contribution is needed:</span>
                <span class="n">resonanceLink</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">link</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;resonanceRegion&quot;</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">resonances</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">resonances</span><span class="o">.</span><span class="n">toXLink</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span>

                <span class="k">for</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">resonanceMTs</span> <span class="p">:</span>
                    <span class="n">MTChannels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactions</span> <span class="o">+</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">summedReactions</span>
                            <span class="o">+</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">fissionComponents</span> <span class="k">if</span><span class="p">(</span> <span class="n">a</span><span class="o">.</span><span class="n">getENDL_CS_ENDF_MT</span><span class="p">()[</span><span class="s">&#39;MT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">MTChannels</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       WARNING: unable to find channel corresponding to resonance data for MT</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                    <span class="k">elif</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">MTChannels</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">crossSectionComponent</span> <span class="o">=</span> <span class="n">MTChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crossSection</span>
                        <span class="n">backgroundForm</span> <span class="o">=</span> <span class="n">crossSectionComponent</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span> <span class="n">crossSectionComponent</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">]</span>
                        <span class="n">crossSectionComponent</span><span class="o">.</span><span class="n">removeForm</span><span class="p">(</span> <span class="n">backgroundForm</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
                        <span class="n">crossSectionComponent</span><span class="o">.</span><span class="n">addFormAsNativeData</span><span class="p">(</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">resonancesWithBackground</span><span class="p">(</span> <span class="n">backgroundForm</span><span class="p">,</span> <span class="n">resonanceLink</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">crossSectionComponent</span> <span class="o">=</span> <span class="n">MTChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crossSection</span>
                        <span class="n">backgroundComponent</span> <span class="o">=</span> <span class="n">crossSectionComponent</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span> <span class="n">crossSectionComponent</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">]</span><span class="o">.</span><span class="n">crossSection</span>
                        <span class="n">backgroundForm</span> <span class="o">=</span> <span class="n">backgroundComponent</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span> <span class="n">backgroundComponent</span><span class="o">.</span><span class="n">nativeData</span> <span class="p">]</span>
                        <span class="n">backgroundComponent</span><span class="o">.</span><span class="n">removeForm</span><span class="p">(</span> <span class="n">backgroundForm</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
                        <span class="n">referredXSecForm</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">reactionData</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">resonancesWithBackground</span><span class="p">(</span> <span class="n">backgroundForm</span><span class="p">,</span> <span class="n">resonanceLink</span> <span class="p">)</span>
                        <span class="n">backgroundComponent</span><span class="o">.</span><span class="n">addFormAsNativeData</span><span class="p">(</span> <span class="n">referredXSecForm</span> <span class="p">)</span>
    <span class="k">except</span> <span class="n">BadResonances</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;       ERROR: unable to parse resonances! Error message: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; parse covariances. This also requires setting up links from data to covariances, so we</span>
<span class="sd">        must ensure the links are synchronized &quot;&quot;&quot;</span>

        <span class="n">MTdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="o">.</span><span class="n">MAT</span> <span class="o">=</span> <span class="n">MAT</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">_getBaseAndDerivedReactions</span><span class="p">():</span>
            <span class="n">MT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;ENDF_MT&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">MTdict</span><span class="p">:</span> <span class="n">MTdict</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">ch</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">MTdict</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="p">]</span>
        <span class="n">covarianceSuite</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="n">parseCovariances</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">,</span> <span class="n">MTdict</span><span class="p">,</span> <span class="n">singleMTOnly</span><span class="o">=</span><span class="n">singleMTOnly</span><span class="p">,</span>
                <span class="n">resonances</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">reactionSuite</span><span class="p">,</span><span class="s">&#39;resonances&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">projectile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">)</span>
        <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">styles</span> <span class="o">=</span> <span class="p">{</span><span class="n">evaluatedStyle</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">evaluatedStyle</span><span class="p">}</span>
        <span class="c">#covarianceSuite.removeExtraZeros() # disable for easier comparison to ENDF</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;       WARNING: Couldn&#39;t parse covariances! Error message: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">covarianceSuite</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">covariances</span><span class="o">.</span><span class="n">covarianceSuite</span><span class="p">()</span>        <span class="c"># create empty section</span>
    
    <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span> <span class="p">:</span>
        <span class="n">mostCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">AWR</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">][</span><span class="n">AWR</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mostCount</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">mostCount</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">][</span><span class="n">AWR</span><span class="p">]</span>
                <span class="n">mostAWR</span> <span class="o">=</span> <span class="n">AWR</span>
        <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">=</span> <span class="n">mostAWR</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">masses</span><span class="o">.</span><span class="n">getMassFromZA</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">level</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c"># AWR is for isomer mass. Adjust info.ZAMasses to GS mass:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">targetZA</span><span class="p">]</span> <span class="o">-=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="s">&#39;eV/c**2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getValueAs</span><span class="p">(</span><span class="s">&#39;amu&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">particles</span> <span class="p">:</span>                        <span class="c"># Fix up any particle whose mass is not defined (i.e., is None).</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;gamma&#39;</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>
        <span class="n">ZA</span> <span class="o">=</span> <span class="n">fudgeZA</span><span class="o">.</span><span class="n">gndNameToZ_A_Suffix</span><span class="p">(</span> <span class="n">name</span> <span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">particle</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">particle</span><span class="o">.</span><span class="n">getMass</span><span class="p">(</span> <span class="s">&#39;amu&#39;</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ZA_AWRMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">mass</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">masses</span><span class="o">.</span><span class="n">getMassFromZA</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">ZAMasses</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">particle</span><span class="o">.</span><span class="n">setMass</span><span class="p">(</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">mass</span><span class="p">,</span> <span class="s">&#39;amu&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c"># also add ground state level if there are discrete excited levels:</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">reactionSuite</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">nuclearLevel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_e0&#39;</span><span class="p">,</span>
                    <span class="n">energy</span><span class="o">=</span><span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span><span class="s">&#39;0 eV&#39;</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">MF12BaseMTsAndRange</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">92</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">650</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">650</span><span class="p">,</span> <span class="mi">700</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">750</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">800</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">850</span> <span class="p">]</span> <span class="p">]</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">singleMTOnly</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">branchingData</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#if( len( info.MF12_LO2 ) &gt; 0 ) : reactionSuite.gammaBranching = {}</span>
        <span class="k">for</span> <span class="n">MTLO2</span><span class="p">,</span> <span class="n">MF12_LO2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">MF12_LO2</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">:</span>  <span class="c"># The logic below assumes MTs are in ascending order per base MT.</span>
            <span class="n">branchingBaseMT</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">MTBase</span><span class="p">,</span> <span class="n">MTEnd</span> <span class="ow">in</span> <span class="n">MF12BaseMTsAndRange</span> <span class="p">:</span>             <span class="c"># Determine base MT for this MTLO2</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">MTBase</span> <span class="o">&lt;</span> <span class="n">MTLO2</span> <span class="o">&lt;</span> <span class="n">MTEnd</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">branchingBaseMT</span> <span class="o">=</span> <span class="n">MTBase</span>
                    <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">branchingBaseMT</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">residualZA</span> <span class="o">=</span> <span class="n">endf_endl</span><span class="o">.</span><span class="n">ENDF_MTZAEquation</span><span class="p">(</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">targetZA</span><span class="p">,</span> <span class="n">branchingBaseMT</span> <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="bp">None</span> <span class="p">)</span>
                <span class="n">residualName</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">MTLO2</span> <span class="o">-</span> <span class="n">branchingBaseMT</span>
                <span class="n">levelName</span><span class="p">,</span> <span class="n">levelEnergy</span> <span class="o">=</span> <span class="s">&#39;_e</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">level</span><span class="p">,</span> <span class="n">MF12_LO2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;ES&#39;</span><span class="p">]</span>
                <span class="n">fullName</span> <span class="o">=</span> <span class="n">residualName</span> <span class="o">+</span> <span class="n">levelName</span>
                <span class="n">levelEnergy_eV</span> <span class="o">=</span> <span class="n">physicalQuantityWithUncertainty</span><span class="o">.</span><span class="n">PhysicalQuantityWithUncertainty</span><span class="p">(</span> <span class="n">levelEnergy</span><span class="p">,</span> <span class="s">&#39;eV&#39;</span> <span class="p">)</span>
                <span class="c"># compare this value to level energy from the particle list (from MF3 Q-value):</span>
                <span class="n">particleLevelEnergy_eV</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="n">fullName</span><span class="p">)</span><span class="o">.</span><span class="n">energy</span>
                <span class="k">if</span> <span class="n">levelEnergy_eV</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">particleLevelEnergy_eV</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">levelEnergy_eV</span> <span class="o">-</span> <span class="n">particleLevelEnergy_eV</span> <span class="p">)</span> <span class="o">/</span> <span class="n">particleLevelEnergy_eV</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                        <span class="c"># MF12/MF14 value wins over MF3 value for small disagreements:</span>
                        <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="n">fullName</span><span class="p">)</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">levelEnergy_eV</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s">&quot;MF12 parent level energy (</span><span class="si">%s</span><span class="s"> eV) doesn&#39;t match known level&quot;</span> <span class="o">%</span> <span class="n">particleLevelEnergy_eV</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">MF12</span> <span class="ow">in</span> <span class="n">MF12_LO2</span> <span class="p">:</span>
                    <span class="n">finalLevelEnergy</span> <span class="o">=</span> <span class="n">MF12</span><span class="p">[</span><span class="s">&#39;ESk&#39;</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">finalLevelEnergy</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="c"># find particle in the particleList with energy == finalLevelEnergy</span>
                        <span class="n">finalParticles</span> <span class="o">=</span> <span class="p">[</span><span class="n">lev</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span> <span class="n">residualName</span> <span class="p">)</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">lev</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">getValueAs</span><span class="p">(</span><span class="s">&#39;eV&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">finalLevelEnergy</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalParticles</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">finalParticle</span> <span class="o">=</span> <span class="n">finalParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>   <span class="c"># no exact match, look for levels within .01% of the exact value:</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">finalParticleName</span> <span class="o">=</span> <span class="n">residualName</span><span class="o">+</span><span class="s">&#39;_e</span><span class="si">%i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">idx</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">hasParticle</span><span class="p">(</span><span class="n">finalParticleName</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s">&quot;MF12 final level energy (</span><span class="si">%s</span><span class="s"> eV) doesn&#39;t match known level&quot;</span> <span class="o">%</span> <span class="n">finalLevelEnergy</span> <span class="p">)</span>
                                <span class="n">thisLevelEnergy</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="n">finalParticleName</span><span class="p">)</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">getValueAs</span><span class="p">(</span><span class="s">&#39;eV&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">thisLevelEnergy</span> <span class="o">-</span> <span class="n">finalLevelEnergy</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span> <span class="o">*</span> <span class="n">finalLevelEnergy</span><span class="p">:</span>
                                    <span class="n">finalParticle</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="n">finalParticleName</span><span class="p">)</span>
                                    <span class="k">break</span>   <span class="c"># found it</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">finalParticle</span> <span class="o">=</span> <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="n">residualName</span><span class="o">+</span><span class="s">&#39;_e0&#39;</span><span class="p">)</span>
                    <span class="n">gammaTransition</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">MF12</span><span class="p">[</span><span class="s">&#39;branching&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="n">gammaTransition</span> <span class="o">=</span> <span class="n">MF12</span><span class="p">[</span><span class="s">&#39;branching&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">gnd</span><span class="o">.</span><span class="n">xParticle</span><span class="o">.</span><span class="n">nuclearLevelGamma</span><span class="p">(</span> <span class="n">finalParticle</span><span class="p">,</span> <span class="n">MF12</span><span class="p">[</span><span class="s">&#39;angular&#39;</span><span class="p">],</span> <span class="n">MF12</span><span class="p">[</span><span class="s">&#39;branching&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="o">-</span><span class="n">gammaTransition</span> <span class="p">)</span>
                    <span class="n">reactionSuite</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="n">fullName</span><span class="p">)</span><span class="o">.</span><span class="n">addGamma</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Could not determine base MT for MF=12&#39;s MT=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">MTLO2</span> <span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warningList</span> <span class="p">:</span> <span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">warning</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skipBadData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Raising due to following errors:</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">err</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&#39;len( info.doRaise ) &gt; 0&#39;</span> <span class="p">)</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">reactionSuite</span><span class="p">,</span> <span class="n">covarianceSuite</span> <span class="p">)</span>
</div>
<span class="k">if</span><span class="p">(</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">flags</span> <span class="o">=</span> <span class="n">processingInfo</span><span class="o">.</span><span class="n">tempInfo</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">flags</span><span class="p">[</span><span class="s">&#39;verbosity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">endfFileToGND</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="s">&#39;test.xml&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">x</span><span class="o">.</span><span class="n">toXMLList</span><span class="p">(</span> <span class="n">flags</span> <span class="p">)</span> <span class="o">+</span> <span class="p">[</span> <span class="s">&#39;&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">:</span> <span class="c"># covariances</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="s">&#39;test-covar.xml&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">c</span><span class="o">.</span><span class="n">toXMLList</span><span class="p">(</span> <span class="n">flags</span> <span class="p">)</span> <span class="o">+</span> <span class="p">[</span> <span class="s">&#39;&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/gnd.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Fudge and GND 1.2 beta documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, B.Beck, D. Brown, C. Mattoon, N. Patel, N. Summers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>